import{CanvasTexture as e,LinearFilter as t,RepeatWrapping as r,Frustum as n,Matrix4 as i,Group as s,PlaneGeometry as o,Vector3 as a,MeshBasicMaterial as c,DoubleSide as u,Mesh as l,ArrowHelper as h,Color as f,BoxGeometry as d,EdgesGeometry as p,LineSegments as m,LineBasicMaterial as y,MeshStandardMaterial as g,Interpolant as v,Loader as w,LoaderUtils as b,FileLoader as T,SpotLight as _,PointLight as x,DirectionalLight as S,MeshPhysicalMaterial as E,Vector2 as A,TangentSpaceNormalMap as M,ImageBitmapLoader as R,TextureLoader as O,InterleavedBuffer as I,InterleavedBufferAttribute as k,BufferAttribute as N,RGBFormat as C,LinearMipmapLinearFilter as L,PointsMaterial as P,Material as U,sRGBEncoding as D,PropertyBinding as j,BufferGeometry as B,SkinnedMesh as F,Line as V,LineLoop as q,Points as z,PerspectiveCamera as G,MathUtils as H,OrthographicCamera as W,InterpolateLinear as K,AnimationClip as Q,Bone as X,Object3D as Y,Skeleton as Z,NearestFilter as J,NearestMipmapNearestFilter as $,LinearMipmapNearestFilter as ee,NearestMipmapLinearFilter as te,ClampToEdgeWrapping as re,MirroredRepeatWrapping as ne,InterpolateDiscrete as ie,FrontSide as se,TriangleFanDrawMode as oe,TriangleStripDrawMode as ae,VectorKeyframeTrack as ce,QuaternionKeyframeTrack as ue,NumberKeyframeTrack as le,Box3 as he,Sphere as fe,ShaderMaterial as de,Float32BufferAttribute as pe,Uint8BufferAttribute as me}from"three";import{GLTFLoader as ye}from"three/examples/jsm/loaders/GLTFLoader";import{DRACOLoader as ge}from"three/examples/jsm/loaders/DRACOLoader";import{KTX2Loader as ve}from"three/examples/jsm/loaders/KTX2Loader";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function we(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))}function be(e,t){if(!e)throw new Error(t||"loader assertion failed.")}const Te={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},_e=Te.global||Te.self||Te.window||{},xe="object"!=typeof process||"[object process]"!==String(process)||process.browser,Se="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version),Ee=Se&&parseFloat(Se[1])||0;function Ae(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}const Me={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},Re=Me.global||Me.self||Me.window||{},Oe="object"!=typeof process||"[object process]"!==String(process)||process.browser,Ie="function"==typeof importScripts,ke="undefined"!=typeof window&&void 0!==window.orientation,Ne="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);function Ce(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Ne&&parseFloat(Ne[1]);class Le{constructor(e,t){Ce(this,"name",void 0),Ce(this,"workerThread",void 0),Ce(this,"isRunning",void 0),Ce(this,"result",void 0),Ce(this,"_resolve",void 0),Ce(this,"_reject",void 0),this.name=e,this.workerThread=t,this.isRunning=!0,this._resolve=()=>{},this._reject=()=>{},this.result=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Ae(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Ae(this.isRunning),this.isRunning=!1,this._reject(e)}}const Pe=new Map;function Ue(e){Ae(e.source&&!e.url||!e.source&&e.url);let t=Pe.get(e.source||e.url);return t||(e.url&&(t=function(e){if(!e.startsWith("http"))return e;return De((t=e,"try {\n  importScripts('".concat(t,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")));var t}(e.url),Pe.set(e.url,t)),e.source&&(t=De(e.source),Pe.set(e.source,t))),Ae(t),t}function De(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function je(e,t=!0,r){const n=r||new Set;if(e){if(Be(e))n.add(e);else if(Be(e.buffer))n.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const r in e)je(e[r],t,n)}else;return void 0===r?Array.from(n):[]}function Be(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}const Fe=()=>{};class Ve{static isSupported(){return"undefined"!=typeof Worker}constructor(e){Ce(this,"name",void 0),Ce(this,"source",void 0),Ce(this,"url",void 0),Ce(this,"terminated",!1),Ce(this,"worker",void 0),Ce(this,"onMessage",void 0),Ce(this,"onError",void 0),Ce(this,"_loadableURL","");const{name:t,source:r,url:n}=e;Ae(r||n),this.name=t,this.source=r,this.url=n,this.onMessage=Fe,this.onError=e=>console.log(e),this.worker=this._createBrowserWorker()}destroy(){this.onMessage=Fe,this.onError=Fe,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||je(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=Ue({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>console.error(e),e}}class qe{constructor(e){Ce(this,"name","unnamed"),Ce(this,"source",void 0),Ce(this,"url",void 0),Ce(this,"maxConcurrency",1),Ce(this,"maxMobileConcurrency",1),Ce(this,"onDebug",(()=>{})),Ce(this,"reuseWorkers",!0),Ce(this,"props",{}),Ce(this,"jobQueue",[]),Ce(this,"idleQueue",[]),Ce(this,"count",0),Ce(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,t=((e,t,r)=>e.done(r)),r=((e,t)=>e.error(t))){const n=new Promise((n=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:n}),this)));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new Le(t.name,e);e.onMessage=e=>t.onMessage(r,e.type,e.payload),e.onError=e=>t.onError(r,e),t.onStart(r);try{await r.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new Ve({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return ke?this.maxMobileConcurrency:this.maxConcurrency}}const ze={maxConcurrency:3,maxMobileConcurrency:1,onDebug:()=>{},reuseWorkers:!0};class Ge{static isSupported(){return Ve.isSupported()}static getWorkerFarm(e={}){return Ge._workerFarm=Ge._workerFarm||new Ge({}),Ge._workerFarm.setProps(e),Ge._workerFarm}constructor(e){Ce(this,"props",void 0),Ce(this,"workerPools",new Map),this.props={...ze},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy()}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:n}=e;let i=this.workerPools.get(t);return i||(i=new qe({name:t,source:r,url:n}),i.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,i)),i}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}Ce(Ge,"_workerFarm",void 0);const He={};async function We(e,t=null,r={}){return t&&(e=function(e,t,r){if(e.startsWith("http"))return e;const n=r.modules||{};if(n[e])return n[e];if(!Oe)return"modules/".concat(t,"/dist/libs/").concat(e);if(r.CDN)return Ae(r.CDN.startsWith("http")),"".concat(r.CDN,"/").concat(t,"@").concat("3.0.0-beta.5","/dist/libs/").concat(e);if(Ie)return"../src/libs/".concat(e);return"modules/".concat(t,"/src/libs/").concat(e)}(e,t,r)),He[e]=He[e]||async function(e){if(e.endsWith("wasm")){const t=await fetch(e);return await t.arrayBuffer()}if(!Oe)return;if(Ie)return importScripts(e);const t=await fetch(e);return function(e,t){if(!Oe)return;if(Ie)return eval.call(Re,e),null;const r=document.createElement("script");r.id=t;try{r.appendChild(document.createTextNode(e))}catch(t){r.text=e}return document.body.appendChild(r),null}(await t.text(),e)}(e),await He[e]}async function Ke(e,t,r,n,i){const s=e.id,o=function(e,t={}){const r=t[e.id]||{},n="".concat(e.id,"-worker.js");let i=r.workerUrl;if("test"===t._workerType&&(i="modules/".concat(e.module,"/dist/").concat(n)),!i){let t=e.version;"latest"===t&&(t="beta");const r=t?"@".concat(t):"";i="https://unpkg.com/@loaders.gl/".concat(e.module).concat(r,"/dist/").concat(n)}return Ae(i),i}(e,r),a=Ge.getWorkerFarm(r).getWorkerPool({name:s,url:o});r=JSON.parse(JSON.stringify(r));const c=await a.startJob("process-on-worker",Qe.bind(null,i));c.postMessage("process",{input:t,options:r});const u=await c.result;return await u.result}async function Qe(e,t,r,n){switch(r){case"done":t.done(n);break;case"error":t.error(n.error);break;case"process":const{id:i,input:s,options:o}=n;try{const r=await e(s,o);t.postMessage("done",{id:i,result:r})}catch(e){const r=e instanceof Error?e.message:"unknown error";t.postMessage("error",{id:i,error:r})}break;default:console.warn("parse-with-worker unknown message ".concat(r))}}function Xe(e,t,r){if(e.byteLength<=t+r)return"";const n=new DataView(e);let i="";for(let e=0;e<r;e++)i+=String.fromCharCode(n.getUint8(t+e));return i}function Ye(e){try{return JSON.parse(e)}catch(t){throw new Error('Failed to parse JSON from data starting with "'.concat(function(e,t=5){if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return Xe(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer)return Xe(e,0,t);return""}(e),'"'))}}function Ze(e){if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return e.buffer;if("string"==typeof e){const t=e;return(new TextEncoder).encode(t).buffer}if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw new Error("toArrayBuffer")}function Je(e,t,r){const n=void 0!==r?new Uint8Array(e).subarray(t,t+r):new Uint8Array(e).subarray(t);return new Uint8Array(n).buffer}function $e(e,t){return be(e>=0),be(t>0),e+(t-1)&~(t-1)}function et(e,t,r){let n;if(e instanceof ArrayBuffer)n=new Uint8Array(e);else{const t=e.byteOffset,r=e.byteLength;n=new Uint8Array(e.buffer||e.arrayBuffer,t,r)}return t.set(n,r),r+$e(n.byteLength,4)}function tt(e){const t=e&&e.lastIndexOf("/");return t>=0?e.substr(0,t):""}const rt={};async function nt(e){const t=[];for await(const r of e)t.push(r);return function(...e){const t=e.map((e=>e instanceof ArrayBuffer?new Uint8Array(e):e)),r=t.reduce(((e,t)=>e+t.byteLength),0),n=new Uint8Array(r);let i=0;for(const e of t)n.set(e,i),i+=e.byteLength;return n.buffer}(...t)}function it(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function st(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ot(e,t,r){return t&&st(e.prototype,t),r&&st(e,r),e}function at(){var e;if("undefined"!=typeof window&&window.performance)e=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){var t=process.hrtime();e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}var ct=function(){function e(t,r){it(this,e),this.name=t,this.type=r,this.sampleSize=1,this.reset()}return ot(e,[{key:"setSampleSize",value:function(e){return this.sampleSize=e,this}},{key:"incrementCount",value:function(){return this.addCount(1),this}},{key:"decrementCount",value:function(){return this.subtractCount(1),this}},{key:"addCount",value:function(e){return this._count+=e,this._samples++,this._checkSampling(),this}},{key:"subtractCount",value:function(e){return this._count-=e,this._samples++,this._checkSampling(),this}},{key:"addTime",value:function(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}},{key:"timeStart",value:function(){return this._startTime=at(),this._timerPending=!0,this}},{key:"timeEnd",value:function(){return this._timerPending?(this.addTime(at()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}},{key:"getSampleAverageCount",value:function(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}},{key:"getSampleAverageTime",value:function(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}},{key:"getSampleHz",value:function(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}},{key:"getAverageCount",value:function(){return this.samples>0?this.count/this.samples:0}},{key:"getAverageTime",value:function(){return this.samples>0?this.time/this.samples:0}},{key:"getHz",value:function(){return this.time>0?this.samples/(this.time/1e3):0}},{key:"reset",value:function(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}},{key:"_checkSampling",value:function(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}]),e}(),ut=function(){function e(t){var r=t.id,n=t.stats;it(this,e),this.id=r,this.stats={},this._initializeStats(n),Object.seal(this)}return ot(e,[{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}},{key:"reset",value:function(){for(var e in this.stats)this.stats[e].reset();return this}},{key:"forEach",value:function(e){for(var t in this.stats)e(this.stats[t])}},{key:"getTable",value:function(){var e={};return this.forEach((function(t){e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}})),e}},{key:"_initializeStats",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];t.forEach((function(t){return e._getOrCreate(t)}))}},{key:"_getOrCreate",value:function(e){if(!e||!e.name)return null;var t=e.name,r=e.type;return this.stats[t]||(this.stats[t]=e instanceof ct?e:new ct(t,r)),this.stats[t]}},{key:"size",get:function(){return Object.keys(this.stats).length}}]),e}();const lt={id:"request-scheduler",throttleRequests:!0,maxRequests:6};class ht{constructor(e={}){Ce(this,"props",void 0),Ce(this,"stats",void 0),Ce(this,"activeRequestCount",void 0),Ce(this,"requestQueue",void 0),Ce(this,"requestMap",void 0),Ce(this,"_deferredUpdate",void 0),this.props={...lt,...e},this.requestQueue=[],this.activeRequestCount=0,this.requestMap=new Map,this.stats=new ut({id:e.id}),this.stats.get("Queued Requests"),this.stats.get("Active Requests"),this.stats.get("Cancelled Requests"),this.stats.get("Queued Requests Ever"),this.stats.get("Active Requests Ever"),this._deferredUpdate=null}scheduleRequest(e,t=(()=>0)){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const r={handle:e,priority:0,getPriority:t},n=new Promise((e=>(r.resolve=e,r)));return this.requestQueue.push(r),this.requestMap.set(e,n),this._issueNewRequests(),n}_issueRequest(e){const{handle:t,resolve:r}=e;let n=!1;const i=()=>{n||(n=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,r?r({done:i}):Promise.resolve({done:i})}_issueNewRequests(){this._deferredUpdate||(this._deferredUpdate=setTimeout((()=>this._issueNewRequestsAsync()),0))}_issueNewRequestsAsync(){this._deferredUpdate=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(0!==e){this._updateAllRequests();for(let t=0;t<e;++t)if(this.requestQueue.length>0){const e=this.requestQueue.shift();this._issueRequest(e)}}}_updateAllRequests(){const e=this.requestQueue;for(let t=0;t<e.length;++t){const r=e[t];this._updateRequest(r)||(e.splice(t,1),this.requestMap.delete(r.handle),t--)}e.sort(((e,t)=>e.priority-t.priority))}_updateRequest(e){return e.priority=e.getPriority(e.handle),!(e.priority<0)||(e.resolve(null),!1)}}const ft=e=>"function"==typeof e,dt=e=>null!==e&&"object"==typeof e,pt=e=>dt(e)&&e.constructor==={}.constructor,mt=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,yt=e=>"undefined"!=typeof Blob&&e instanceof Blob,gt=e=>(e=>"undefined"!=typeof ReadableStream&&e instanceof ReadableStream||dt(e)&&ft(e.tee)&&ft(e.cancel)&&ft(e.getReader))(e)||(e=>dt(e)&&ft(e.read)&&ft(e.pipe)&&(e=>"boolean"==typeof e)(e.readable))(e),vt=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,wt=/^([-\w.]+\/[-\w.+]+)/;function bt(e){const t=wt.exec(e);return t?t[1]:e}function Tt(e){const t=vt.exec(e);return t?t[1]:""}const _t=/\?.*/;function xt(e){if(mt(e)){const t=St(e.url||"");return{url:t,type:bt(e.headers.get("content-type")||"")||Tt(t)}}return yt(e)?{url:St(e.name||""),type:e.type||""}:"string"==typeof e?{url:St(e),type:Tt(e)}:{url:"",type:""}}function St(e){return e.replace(_t,"")}async function Et(e){if(mt(e))return e;const t={},r=function(e){return mt(e)?e.headers["content-length"]||-1:yt(e)?e.size:"string"==typeof e?e.length:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}(e);r>=0&&(t["content-length"]=String(r));const{url:n,type:i}=xt(e);i&&(t["content-type"]=i);const s=await async function(e){const t=5;if("string"==typeof e)return"data:,".concat(e.slice(0,t));if(e instanceof Blob){const t=e.slice(0,5);return await new Promise((e=>{const r=new FileReader;r.onload=t=>{var r;return e(null==t||null===(r=t.target)||void 0===r?void 0:r.result)},r.readAsDataURL(t)}))}if(e instanceof ArrayBuffer){const r=function(e){let t="";const r=new Uint8Array(e);for(let e=0;e<r.byteLength;e++)t+=String.fromCharCode(r[e]);return btoa(t)}(e.slice(0,t));return"data:base64,".concat(r)}return null}(e);s&&(t["x-first-bytes"]=s),"string"==typeof e&&(e=(new TextEncoder).encode(e));const o=new Response(e,{headers:t});return Object.defineProperty(o,"url",{value:n}),o}async function At(e,t){if("string"==typeof e){e=function(e){for(const t in rt)if(e.startsWith(t)){const r=rt[t];e=e.replace(t,r)}return e.startsWith("http://")||e.startsWith("https://")||(e="".concat("").concat(e)),e}(e);let r=t;null!=t&&t.fetch&&"function"!=typeof(null==t?void 0:t.fetch)&&(r=t.fetch);const n=await fetch(e,r);if(!n.ok&&null!=t&&t.throws)throw new Error(await async function(e){let t="Failed to fetch resource ".concat(e.url," (").concat(e.status,"): ");try{(e.headers.get("Content-Type")||"").includes("application/json")?t+=await e.text():t+=e.statusText}catch(e){return t}return t}(n));return n}return await Et(e)}class Mt{log(){return e=>{}}info(){return e=>{}}warn(){return e=>{}}error(){return e=>{}}}const Rt={fetch:null,log:new class{constructor(){Ce(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}},CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,_workerType:"",batchSize:"auto",metadata:!1,transforms:[],attributeName:null,attributeType:null},Ot={dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function It(){_e.loaders=_e.loaders||{};const{loaders:e}=_e;return e._state=e._state||{},e._state}const kt=()=>{const e=It();return e.globalOptions=e.globalOptions||{...Rt},e.globalOptions};function Nt(e,t,r,n){return r=r||[],function(e,t,r=console){Lt(e,null,r,Rt,Ot,t);for(const n of t){const i=e&&e[n.id]||{},s=n.options&&n.options[n.id]||{},o=n.defaultOptions&&n.defaultOptions[n.id]||{};Lt(i,n.id,r,s,o,t)}}(e,r=Array.isArray(r)?r:[r]),function(e,t,r){const n={...e.options||{}};(function(e,t){t&&!("baseUri"in e)&&(e.baseUri=t)})(n,r),null===n.log&&(n.log=new Mt);return Ut(n,kt()),Ut(n,t),n}(t,e,n)}function Ct(e,t){const r=kt(),n=e||r;return"function"==typeof n.fetch?n.fetch:dt(n.fetch)?e=>At(e,n):t&&t.fetch?t.fetch:At}function Lt(e,t,r,n,i,s){const o=t||"Top level",a=t?"".concat(t,"."):"";for(const c in e){const u=!t&&dt(e[c]);if(!(c in n)&&("baseUri"!==c||t))if(c in i)r.warn("".concat(o," loader option '").concat(a).concat(c,"' no longer supported, use '").concat(i[c],"'"));else if(!u){const e=Pt(c,s);r.warn("".concat(o," loader option '").concat(a).concat(c,"' not recognized. ").concat(e))}}}function Pt(e,t){const r=e.toLowerCase();let n="";for(const i of t)for(const t in i.options){if(e===t)return"Did you mean '".concat(i.id,".").concat(t,"'?");const s=t.toLowerCase();(r.startsWith(s)||s.startsWith(r))&&(n=n||"Did you mean '".concat(i.id,".").concat(t,"'?"))}return n}function Ut(e,t){for(const r in t)if(r in t){const n=t[r];pt(n)&&pt(e[r])?e[r]={...e[r],...t[r]}:e[r]=t[r]}}function Dt(e){var t;if(!e)return!1;Array.isArray(e)&&(e=e[0]);return Array.isArray(null===(t=e)||void 0===t?void 0:t.extensions)}function jt(e){let t;return be(e,"null loader"),be(Dt(e),"invalid loader"),Array.isArray(e)&&(t=e[1],e=e[0],e={...e,options:{...e.options,...t}}),e.text||(e.binary=!0),e}function Bt(){return(()=>{const e=It();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry})()}async function Ft(e,t,r){return await new Promise(((n,i)=>{const s=e.slice(t,r),o=new FileReader;o.onload=e=>{var t;return n(null==e||null===(t=e.target)||void 0===t?void 0:t.result)},o.onerror=e=>i(e),o.readAsArrayBuffer(s)}))}const Vt=/\.([^.]+)$/;function qt(e,t=[],r,n){if(t&&!Array.isArray(t))return jt(t);!function(e){for(const t of e)jt(t)}(t=[...t||[],...Bt()]);const{url:i,type:s}=xt(e);let o=function(e,t){const r=t&&Vt.exec(t),n=r&&r[1];return n?function(e,t){t=t.toLowerCase();for(const r of e)for(const e of r.extensions)if(e.toLowerCase()===t)return r;return null}(e,n):null}(t,i||(null==n?void 0:n.url));if(o=o||function(e,t){for(const r of e){if(r.mimeTypes&&r.mimeTypes.includes(t))return r;if(t==="application/x.".concat(r.id))return r}return null}(t,s),o=o||function(e,t){if(!t)return null;for(const r of e)if("string"==typeof t){if(Gt(t,r))return r}else if(ArrayBuffer.isView(t)){if(Ht(t.buffer,t.byteOffset,r))return r}else if(t instanceof ArrayBuffer){if(Ht(t,0,r))return r}return null}(t,e),!(o||null!=r&&r.nothrow))throw new Error(zt(e));return o}function zt(e){const{url:t,type:r}=xt(e);let n="No valid loader found";return e&&(n+=' data: "'.concat(function(e,t=5){if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return Wt(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){return Wt(e,0,t)}return""}(e),'", contentType: "').concat(r,'"')),t&&(n+=" url: ".concat(t)),n}function Gt(e,t){if(t.testText)return t.testText(e);return(Array.isArray(t.tests)?t.tests:[t.tests]).some((t=>e.startsWith(t)))}function Ht(e,t,r){return(Array.isArray(r.tests)?r.tests:[r.tests]).some((n=>function(e,t,r,n){if(n instanceof ArrayBuffer)return function(e,t,r){if(r=r||e.byteLength,e.byteLength<r||t.byteLength<r)return!1;const n=new Uint8Array(e),i=new Uint8Array(t);for(let e=0;e<n.length;++e)if(n[e]!==i[e])return!1;return!0}(n,e,n.byteLength);switch(typeof n){case"function":return n(e,r);case"string":return n===Wt(e,t,n.length);default:return!1}}(e,t,r,n)))}function Wt(e,t,r){if(e.byteLength<t+r)return"";const n=new DataView(e);let i="";for(let e=0;e<r;e++)i+=String.fromCharCode(n.getUint8(t+e));return i}const Kt=262144;function Qt(e){if(xe||Ee>=10){if("function"==typeof e[Symbol.asyncIterator])return async function*(e){for await(const t of e)yield Ze(t)}(e);if("function"==typeof e.getIterator)return e.getIterator()}return xe?async function*(e){const t=e.getReader();try{for(;;){const{done:e,value:r}=await t.read();if(e)return;yield Ze(r)}}catch(e){t.releaseLock()}}(e):async function*(e){e=await e;for(;;){const t=e.read();if(null===t){if(e._readableState.ended)return;await Xt(e)}else yield Ze(t)}}(e)}async function Xt(e){return new Promise((t=>{e.once("readable",t)}))}function Yt(e,t){if("string"==typeof e)return function*(e,t){const r=(null==t?void 0:t.chunkSize)||262144;let n=0;const i=new TextEncoder;for(;n<e.length;){const t=Math.min(e.length-n,r),s=e.slice(n,n+t);n+=t,yield i.encode(s)}}(e,t);if(e instanceof ArrayBuffer)return function*(e,t={}){const{chunkSize:r=Kt}=t;let n=0;for(;n<e.byteLength;){const t=Math.min(e.byteLength-n,r),i=new ArrayBuffer(t),s=new Uint8Array(e,n,t);new Uint8Array(i).set(s),n+=t,yield i}}(e,t);if(yt(e))return async function*(e,t){const r=(null==t?void 0:t.chunkSize)||1048576;let n=0;for(;n<e.size;){const t=n+r,i=await Ft(e,n,t);n=t,yield i}}(e,t);if(gt(e))return Qt(e);if(mt(e)){return Qt(e.body)}throw new Error("makeIterator")}const Zt="Cannot convert supplied data type";async function Jt(e,t){const r=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||r)return function(e,t){if(t.text&&"string"==typeof e)return e;var r;if((r=e)&&"object"==typeof r&&r.isBuffer&&(e=e.buffer),e instanceof ArrayBuffer){const r=e;return t.text&&!t.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(e)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(e);let r=e.buffer;const n=e.byteLength||e.length;return 0===e.byteOffset&&n===r.byteLength||(r=r.slice(e.byteOffset,e.byteOffset+n)),r}throw new Error(Zt)}(e,t);if(yt(e)&&(e=await Et(e)),mt(e)){const r=e;return await async function(e){if(!e.ok){const t=await async function(e){let t="Failed to fetch resource ".concat(e.url," (").concat(e.status,"): ");try{const r=e.headers.get("Content-Type");let n=e.statusText;r.includes("application/json")&&(n+=" ".concat(await e.text())),t+=n,t=t.length>60?"".concat(t.slice(60),"..."):t}catch(e){}return t}(e);throw new Error(t)}}(r),t.binary?await r.arrayBuffer():await r.text()}if(gt(e)&&(e=Yt(e)),(n=e)&&"function"==typeof n[Symbol.iterator]||(e=>e&&"function"==typeof e[Symbol.asyncIterator])(e))return nt(e);var n;throw new Error(Zt)}async function $t(e,t,r,n){Ae(!n||"object"==typeof n),!t||Array.isArray(t)||Dt(t)||(n=void 0,r=t,t=void 0),e=await e,r=r||{};const{url:i}=xt(e),s=function(e,t){if(!t&&e&&!Array.isArray(e))return e;let r;if(e&&(r=Array.isArray(e)?e:[e]),t&&t.loaders){const e=Array.isArray(t.loaders)?t.loaders:[t.loaders];r=r?[...r,...e]:e}return r&&r.length?r:null}(t,n),o=await async function(e,t=[],r,n){let i=qt(e,t,{...r,nothrow:!0},n);if(i)return i;if(yt(e)&&(i=qt(e=await Ft(e,0,10),t,r,n)),!(i||null!=r&&r.nothrow))throw new Error(zt(e));return i}(e,s,r);return o?(n=function(e,t,r=null){return r||(e={fetch:Ct(t,e),...e},Array.isArray(e.loaders)||(e.loaders=null),e)}({url:i,parse:$t,loaders:s},r=Nt(r,o,s,i),n),await async function(e,t,r,n){if(function(e,t="3.0.0-beta.5"){Ae(e,"no worker provided");const r=e.version}(e),t=await Jt(t,e),e.parseTextSync&&"string"==typeof t)return r.dataType="text",e.parseTextSync(t,r,n,e);if(function(e,t){return!!Ge.isSupported()&&e.worker&&(null==t?void 0:t.worker)}(e,r))return await Ke(e,t,r,0,$t);if(e.parseText&&"string"==typeof t)return await e.parseText(t,r,n,e);if(e.parse)return await e.parse(t,r,n,e);throw Ae(!e.parseSync),new Error("".concat(e.id," loader - no parser found and worker is disabled"))}(o,e,r,n)):null}async function er(e,t,r,n){Array.isArray(t)||Dt(t)||(r=t,t=void 0);const i=Ct(r);let s=e;return"string"==typeof e&&(s=await i(e)),yt(e)&&(s=await i(e)),await $t(s,t,r)}function tr(e){return(tr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function rr(e,t){return(rr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function nr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function ir(e,t,r){return(ir=nr()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&rr(i,r.prototype),i}).apply(null,arguments)}function sr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function or(e,t){if(e){if("string"==typeof e)return sr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?sr(e,t):void 0}}function ar(e){return function(e){if(Array.isArray(e))return sr(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||or(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function cr(e,t){if(!e)throw new Error("math.gl assertion ".concat(t))}var ur=1/Math.PI*180,lr=1/180*Math.PI,hr={};function fr(e){return Math.round(e/hr.EPSILON)*hr.EPSILON}function dr(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.precision,n=void 0===r?hr.precision||4:r;return e=fr(e),"".concat(parseFloat(e.toPrecision(n)))}function pr(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function mr(e,t,r){if(pr(e)){r=r||((i=e).clone?i.clone():new Array(i.length));for(var n=0;n<r.length&&n<e.length;++n)r[n]=t(e[n],n,r);return r}var i;return t(e)}function yr(e){return function(e,t){return mr(e,(function(e){return e*lr}),t)}(e)}function gr(e){return vr(e)}function vr(e,t){return mr(e,(function(e){return e*ur}),t)}function wr(e,t,r){var n=hr.EPSILON;r&&(hr.EPSILON=r);try{if(e===t)return!0;if(pr(e)&&pr(t)){if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(!wr(e[i],t[i]))return!1;return!0}return e&&e.equals?e.equals(t):t&&t.equals?t.equals(e):!(!Number.isFinite(e)||!Number.isFinite(t))&&Math.abs(e-t)<=hr.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}finally{hr.EPSILON=n}}function br(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&rr(e,t)}function Tr(e,t){return!t||"object"!==tr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _r(e){return(_r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xr(e){var t="function"==typeof Map?new Map:void 0;return(xr=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return ir(e,arguments,_r(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),rr(n,e)})(e)}function Sr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}hr.EPSILON=1e-12,hr.debug=!1,hr.precision=4,hr.printTypes=!1,hr.printDegrees=!1,hr.printRowMajor=!0;var Er=function(e){br(r,xr(Array));var t=Sr(r);function r(){return it(this,r),t.apply(this,arguments)}return ot(r,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"from",value:function(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}},{key:"fromArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}},{key:"to",value:function(e){return e===this?this:pr(e)?this.toArray(e):this.toObject(e)}},{key:"toTarget",value:function(e){return e?this.to(e):this}},{key:"toArray",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}},{key:"toFloat32Array",value:function(){return new Float32Array(this)}},{key:"toString",value:function(){return this.formatString(hr)}},{key:"formatString",value:function(e){for(var t="",r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+dr(this[r],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}},{key:"equals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(!wr(this[t],e[t]))return!1;return!0}},{key:"exactEquals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}},{key:"negate",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}},{key:"lerp",value:function(e,t,r){void 0===r&&(r=t,t=e,e=this);for(var n=0;n<this.ELEMENTS;++n){var i=e[n];this[n]=i+r*(t[n]-i)}return this.check()}},{key:"min",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}},{key:"max",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}},{key:"clamp",value:function(e,t){for(var r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}},{key:"add",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(var n=0,i=t;n<i.length;n++)for(var s=i[n],o=0;o<this.ELEMENTS;++o)this[o]+=s[o];return this.check()}},{key:"subtract",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(var n=0,i=t;n<i.length;n++)for(var s=i[n],o=0;o<this.ELEMENTS;++o)this[o]-=s[o];return this.check()}},{key:"scale",value:function(e){if(Array.isArray(e))return this.multiply(e);for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"sub",value:function(e){return this.subtract(e)}},{key:"setScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}},{key:"addScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}},{key:"subScalar",value:function(e){return this.addScalar(-e)}},{key:"multiplyScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"divideScalar",value:function(e){return this.scale(1/e)}},{key:"clampScalar",value:function(e,t){for(var r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}},{key:"multiplyByScalar",value:function(e){return this.scale(e)}},{key:"check",value:function(){if(hr.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}},{key:"validate",value:function(){for(var e=this.length===this.ELEMENTS,t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}},{key:"ELEMENTS",get:function(){return cr(!1),0}},{key:"RANK",get:function(){return cr(!1),0}},{key:"elements",get:function(){return this}}]),r}();function Ar(e,t){if(e.length!==t)return!1;for(var r=0;r<e.length;++r)if(!Number.isFinite(e[r]))return!1;return!0}function Mr(e){if(!Number.isFinite(e))throw new Error("Invalid number ".concat(e));return e}function Rr(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(hr.debug&&!Ar(e,t))throw new Error("math.gl: ".concat(r," some fields set to invalid numbers'"));return e}var Or={};function Ir(e,t){Or[e]||(Or[e]=!0,console.warn("".concat(e," has been removed in version ").concat(t,", see upgrade guide for more information")))}function kr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}var Nr,Cr=function(e){br(r,Er);var t=kr(r);function r(){return it(this,r),t.apply(this,arguments)}return ot(r,[{key:"copy",value:function(e){return cr(!1),this}},{key:"len",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"magnitude",value:function(){return this.len()}},{key:"lengthSquared",value:function(){for(var e=0,t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}},{key:"magnitudeSquared",value:function(){return this.lengthSquared()}},{key:"distance",value:function(e){return Math.sqrt(this.distanceSquared(e))}},{key:"distanceSquared",value:function(e){for(var t=0,r=0;r<this.ELEMENTS;++r){var n=this[r]-e[r];t+=n*n}return Mr(t)}},{key:"dot",value:function(e){for(var t=0,r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return Mr(t)}},{key:"normalize",value:function(){var e=this.magnitude();if(0!==e)for(var t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}},{key:"multiply",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(var n=0,i=t;n<i.length;n++)for(var s=i[n],o=0;o<this.ELEMENTS;++o)this[o]*=s[o];return this.check()}},{key:"divide",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(var n=0,i=t;n<i.length;n++)for(var s=i[n],o=0;o<this.ELEMENTS;++o)this[o]/=s[o];return this.check()}},{key:"lengthSq",value:function(){return this.lengthSquared()}},{key:"distanceTo",value:function(e){return this.distance(e)}},{key:"distanceToSquared",value:function(e){return this.distanceSquared(e)}},{key:"getComponent",value:function(e){return cr(e>=0&&e<this.ELEMENTS,"index is out of range"),Mr(this[e])}},{key:"setComponent",value:function(e,t){return cr(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}},{key:"addVectors",value:function(e,t){return this.copy(e).add(t)}},{key:"subVectors",value:function(e,t){return this.copy(e).subtract(t)}},{key:"multiplyVectors",value:function(e,t){return this.copy(e).multiply(t)}},{key:"addScaledVector",value:function(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}},{key:"x",get:function(){return this[0]},set:function(e){this[0]=Mr(e)}},{key:"y",get:function(){return this[1]},set:function(e){this[1]=Mr(e)}}]),r}(),Lr="undefined"!=typeof Float32Array?Float32Array:Array;function Pr(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[3]*i+r[6],e[1]=r[1]*n+r[4]*i+r[7],e}function Ur(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[4]*i+r[12],e[1]=r[1]*n+r[5]*i+r[13],e}function Dr(e,t,r){var n=t[0],i=t[1],s=r[3]*n+r[7]*i||1;return e[0]=(r[0]*n+r[4]*i)/s,e[1]=(r[1]*n+r[5]*i)/s,e}function jr(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[3]*n+r[7]*i+r[11]*s||1;return e[0]=(r[0]*n+r[4]*i+r[8]*s)/o,e[1]=(r[1]*n+r[5]*i+r[9]*s)/o,e[2]=(r[2]*n+r[6]*i+r[10]*s)/o,e}function Br(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),Nr=new Lr(2),Lr!=Float32Array&&(Nr[0]=0,Nr[1]=0);var Fr=function(e){br(r,Cr);var t=Br(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return it(this,r),e=t.call(this,2),pr(n)&&1===arguments.length?e.copy(n):(hr.debug&&(Mr(n),Mr(i)),e[0]=n,e[1]=i),e}return ot(r,[{key:"set",value:function(e,t){return this[0]=e,this[1]=t,this.check()}},{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this.check()}},{key:"fromObject",value:function(e){return hr.debug&&(Mr(e.x),Mr(e.y)),this[0]=e.x,this[1]=e.y,this.check()}},{key:"toObject",value:function(e){return e.x=this[0],e.y=this[1],e}},{key:"horizontalAngle",value:function(){return Math.atan2(this.y,this.x)}},{key:"verticalAngle",value:function(){return Math.atan2(this.x,this.y)}},{key:"transform",value:function(e){return this.transformAsPoint(e)}},{key:"transformAsPoint",value:function(e){return Ur(this,this,e),this.check()}},{key:"transformAsVector",value:function(e){return Dr(this,this,e),this.check()}},{key:"transformByMatrix3",value:function(e){return Pr(this,this,e),this.check()}},{key:"transformByMatrix2x3",value:function(e){return function(e,t,r){var n=t[0],i=t[1];e[0]=r[0]*n+r[2]*i+r[4],e[1]=r[1]*n+r[3]*i+r[5]}(this,this,e),this.check()}},{key:"transformByMatrix2",value:function(e){return function(e,t,r){var n=t[0],i=t[1];e[0]=r[0]*n+r[2]*i,e[1]=r[1]*n+r[3]*i}(this,this,e),this.check()}},{key:"ELEMENTS",get:function(){return 2}}]),r}();function Vr(){var e=new Lr(3);return Lr!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function qr(e){var t=e[0],r=e[1],n=e[2];return Math.hypot(t,r,n)}function zr(e,t,r){var n=new Lr(3);return n[0]=e,n[1]=t,n[2]=r,n}function Gr(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Hr(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[0],a=r[1],c=r[2];return e[0]=i*c-s*a,e[1]=s*o-n*c,e[2]=n*a-i*o,e}function Wr(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[3]*n+r[7]*i+r[11]*s+r[15];return o=o||1,e[0]=(r[0]*n+r[4]*i+r[8]*s+r[12])/o,e[1]=(r[1]*n+r[5]*i+r[9]*s+r[13])/o,e[2]=(r[2]*n+r[6]*i+r[10]*s+r[14])/o,e}function Kr(e,t,r){var n=t[0],i=t[1],s=t[2];return e[0]=n*r[0]+i*r[3]+s*r[6],e[1]=n*r[1]+i*r[4]+s*r[7],e[2]=n*r[2]+i*r[5]+s*r[8],e}var Qr=qr;function Xr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}!function(){var e=Vr()}();var Yr=[0,0,0],Zr={},Jr=function(e){br(r,Cr);var t=Xr(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return it(this,r),e=t.call(this,-0,-0,-0),1===arguments.length&&pr(n)?e.copy(n):(hr.debug&&(Mr(n),Mr(i),Mr(s)),e[0]=n,e[1]=i,e[2]=s),e}return ot(r,null,[{key:"ZERO",get:function(){return Zr.ZERO=Zr.ZERO||Object.freeze(new r(0,0,0,0))}}]),ot(r,[{key:"set",value:function(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}},{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}},{key:"fromObject",value:function(e){return hr.debug&&(Mr(e.x),Mr(e.y),Mr(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}},{key:"toObject",value:function(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}},{key:"angle",value:function(e){return r=e,n=(t=this)[0],i=t[1],s=t[2],o=r[0],a=r[1],c=r[2],u=Math.sqrt(n*n+i*i+s*s)*Math.sqrt(o*o+a*a+c*c),l=u&&Gr(t,r)/u,Math.acos(Math.min(Math.max(l,-1),1));var t,r,n,i,s,o,a,c,u,l}},{key:"cross",value:function(e){return Hr(this,this,e),this.check()}},{key:"rotateX",value:function(e){var t=e.radians,r=e.origin;return function(e,t,r,n){var i=[],s=[];i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[0],s[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),s[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2]}(this,this,void 0===r?Yr:r,t),this.check()}},{key:"rotateY",value:function(e){var t=e.radians,r=e.origin;return function(e,t,r,n){var i=[],s=[];i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),s[1]=i[1],s[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2]}(this,this,void 0===r?Yr:r,t),this.check()}},{key:"rotateZ",value:function(e){var t=e.radians,r=e.origin;return function(e,t,r,n){var i=[],s=[];i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),s[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),s[2]=i[2],e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2]}(this,this,void 0===r?Yr:r,t),this.check()}},{key:"transform",value:function(e){return this.transformAsPoint(e)}},{key:"transformAsPoint",value:function(e){return Wr(this,this,e),this.check()}},{key:"transformAsVector",value:function(e){return jr(this,this,e),this.check()}},{key:"transformByMatrix3",value:function(e){return Kr(this,this,e),this.check()}},{key:"transformByMatrix2",value:function(e){return function(e,t,r){var n=t[0],i=t[1];e[0]=r[0]*n+r[2]*i,e[1]=r[1]*n+r[3]*i,e[2]=t[2]}(this,this,e),this.check()}},{key:"transformByQuaternion",value:function(e){return function(e,t,r){var n=r[0],i=r[1],s=r[2],o=r[3],a=t[0],c=t[1],u=t[2],l=i*u-s*c,h=s*a-n*u,f=n*c-i*a,d=i*f-s*h,p=s*l-n*f,m=n*h-i*l,y=2*o;l*=y,h*=y,f*=y,d*=2,p*=2,m*=2,e[0]=a+l+d,e[1]=c+h+p,e[2]=u+f+m}(this,this,e),this.check()}},{key:"ELEMENTS",get:function(){return 3}},{key:"z",get:function(){return this[2]},set:function(e){this[2]=Mr(e)}}]),r}();function $r(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}var en=function(e){br(r,Er);var t=$r(r);function r(){return it(this,r),t.apply(this,arguments)}return ot(r,[{key:"toString",value:function(){var e="[";if(hr.printRowMajor){e+="row-major:";for(var t=0;t<this.RANK;++t)for(var r=0;r<this.RANK;++r)e+=" ".concat(this[r*this.RANK+t])}else{e+="column-major:";for(var n=0;n<this.ELEMENTS;++n)e+=" ".concat(this[n])}return e+="]"}},{key:"getElementIndex",value:function(e,t){return t*this.RANK+e}},{key:"getElement",value:function(e,t){return this[t*this.RANK+e]}},{key:"setElement",value:function(e,t,r){return this[t*this.RANK+e]=Mr(r),this}},{key:"getColumn",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array(this.RANK).fill(-0),r=e*this.RANK,n=0;n<this.RANK;++n)t[n]=this[r+n];return t}},{key:"setColumn",value:function(e,t){for(var r=e*this.RANK,n=0;n<this.RANK;++n)this[r+n]=t[n];return this}}]),r}();function tn(e,t,r){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],c=t[5],u=t[6],l=t[7],h=t[8],f=r[0],d=r[1],p=r[2],m=r[3],y=r[4],g=r[5],v=r[6],w=r[7],b=r[8];return e[0]=f*n+d*o+p*u,e[1]=f*i+d*a+p*l,e[2]=f*s+d*c+p*h,e[3]=m*n+y*o+g*u,e[4]=m*i+y*a+g*l,e[5]=m*s+y*c+g*h,e[6]=v*n+w*o+b*u,e[7]=v*i+w*a+b*l,e[8]=v*s+w*c+b*h,e}function rn(e,t,r){var n=r[0],i=r[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function nn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}var sn=Object.freeze([1,0,0,0,1,0,0,0,1]),on=Object.freeze([0,0,0,0,0,0,0,0,0]),an=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL1ROW0:3,COL1ROW1:4,COL1ROW2:5,COL2ROW0:6,COL2ROW1:7,COL2ROW2:8}),cn={},un=function(e){br(r,en);var t=nn(r);function r(e){var n;return it(this,r),n=t.call(this,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?n.copy(e):n.identity(),n}return ot(r,[{key:"ELEMENTS",get:function(){return 9}},{key:"RANK",get:function(){return 3}},{key:"INDICES",get:function(){return an}}],[{key:"IDENTITY",get:function(){return cn.IDENTITY=cn.IDENTITY||Object.freeze(new r(sn)),cn.IDENTITY}},{key:"ZERO",get:function(){return cn.ZERO=cn.ZERO||Object.freeze(new r(on)),cn.ZERO}}]),ot(r,[{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}},{key:"set",value:function(e,t,r,n,i,s,o,a,c){return this[0]=e,this[1]=t,this[2]=r,this[3]=n,this[4]=i,this[5]=s,this[6]=o,this[7]=a,this[8]=c,this.check()}},{key:"setRowMajor",value:function(e,t,r,n,i,s,o,a,c){return this[0]=e,this[1]=n,this[2]=o,this[3]=t,this[4]=i,this[5]=a,this[6]=r,this[7]=s,this[8]=c,this.check()}},{key:"determinant",value:function(){return t=(e=this)[0],r=e[1],n=e[2],i=e[3],s=e[4],o=e[5],a=e[6],c=e[7],u=e[8],t*(u*s-o*c)+r*(-u*i+o*a)+n*(c*i-s*a);var e,t,r,n,i,s,o,a,c,u}},{key:"identity",value:function(){return this.copy(sn)}},{key:"fromQuaternion",value:function(e){return function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],o=r+r,a=n+n,c=i+i,u=r*o,l=n*o,h=n*a,f=i*o,d=i*a,p=i*c,m=s*o,y=s*a,g=s*c;e[0]=1-h-p,e[3]=l-g,e[6]=f+y,e[1]=l+g,e[4]=1-u-p,e[7]=d-m,e[2]=f-y,e[5]=d+m,e[8]=1-u-h}(this,e),this.check()}},{key:"transpose",value:function(){return function(e,t){if(e===t){var r=t[1],n=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(this,this),this.check()}},{key:"invert",value:function(){return function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],o=t[4],a=t[5],c=t[6],u=t[7],l=t[8],h=l*o-a*u,f=-l*s+a*c,d=u*s-o*c,p=r*h+n*f+i*d;p&&(p=1/p,e[0]=h*p,e[1]=(-l*n+i*u)*p,e[2]=(a*n-i*o)*p,e[3]=f*p,e[4]=(l*r-i*c)*p,e[5]=(-a*r+i*s)*p,e[6]=d*p,e[7]=(-u*r+n*c)*p,e[8]=(o*r-n*s)*p)}(this,this),this.check()}},{key:"multiplyLeft",value:function(e){return tn(this,e,this),this.check()}},{key:"multiplyRight",value:function(e){return tn(this,this,e),this.check()}},{key:"rotate",value:function(e){return function(e,t,r){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],c=t[5],u=t[6],l=t[7],h=t[8],f=Math.sin(r),d=Math.cos(r);e[0]=d*n+f*o,e[1]=d*i+f*a,e[2]=d*s+f*c,e[3]=d*o-f*n,e[4]=d*a-f*i,e[5]=d*c-f*s,e[6]=u,e[7]=l,e[8]=h}(this,this,e),this.check()}},{key:"scale",value:function(e){return Array.isArray(e)?rn(this,this,e):rn(this,this,[e,e,e]),this.check()}},{key:"translate",value:function(e){return function(e,t,r){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],c=t[5],u=t[6],l=t[7],h=t[8],f=r[0],d=r[1];e[0]=n,e[1]=i,e[2]=s,e[3]=o,e[4]=a,e[5]=c,e[6]=f*n+d*o+u,e[7]=f*i+d*a+l,e[8]=f*s+d*c+h}(this,this,e),this.check()}},{key:"transform",value:function(e,t){switch(e.length){case 2:t=Pr(t||[-0,-0],e,this);break;case 3:t=Kr(t||[-0,-0,-0],e,this);break;case 4:t=function(e,t,r){var n=t[0],i=t[1],s=t[2];return e[0]=r[0]*n+r[3]*i+r[6]*s,e[1]=r[1]*n+r[4]*i+r[7]*s,e[2]=r[2]*n+r[5]*i+r[8]*s,e[3]=t[3],e}(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Rr(t,e.length),t}},{key:"transformVector",value:function(e,t){return Ir("Matrix3.transformVector"),this.transform(e,t)}},{key:"transformVector2",value:function(e,t){return Ir("Matrix3.transformVector"),this.transform(e,t)}},{key:"transformVector3",value:function(e,t){return Ir("Matrix3.transformVector"),this.transform(e,t)}}]),r}();function ln(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s=[],o=!0,a=!1;try{for(r=r.call(e);!(o=(n=r.next()).done)&&(s.push(n.value),!t||s.length!==t);o=!0);}catch(e){a=!0,i=e}finally{try{o||null==r.return||r.return()}finally{if(a)throw i}}return s}}(e,t)||or(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function hn(e,t,r){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],c=t[5],u=t[6],l=t[7],h=t[8],f=t[9],d=t[10],p=t[11],m=t[12],y=t[13],g=t[14],v=t[15],w=r[0],b=r[1],T=r[2],_=r[3];return e[0]=w*n+b*a+T*h+_*m,e[1]=w*i+b*c+T*f+_*y,e[2]=w*s+b*u+T*d+_*g,e[3]=w*o+b*l+T*p+_*v,w=r[4],b=r[5],T=r[6],_=r[7],e[4]=w*n+b*a+T*h+_*m,e[5]=w*i+b*c+T*f+_*y,e[6]=w*s+b*u+T*d+_*g,e[7]=w*o+b*l+T*p+_*v,w=r[8],b=r[9],T=r[10],_=r[11],e[8]=w*n+b*a+T*h+_*m,e[9]=w*i+b*c+T*f+_*y,e[10]=w*s+b*u+T*d+_*g,e[11]=w*o+b*l+T*p+_*v,w=r[12],b=r[13],T=r[14],_=r[15],e[12]=w*n+b*a+T*h+_*m,e[13]=w*i+b*c+T*f+_*y,e[14]=w*s+b*u+T*d+_*g,e[15]=w*o+b*l+T*p+_*v,e}function fn(e,t,r){var n=r[0],i=r[1],s=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function dn(e,t,r,n,i){var s,o=1/Math.tan(t/2);return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(s=1/(n-i),e[10]=(i+n)*s,e[14]=2*i*n*s):(e[10]=-1,e[14]=-2*n),e}function pn(e,t,r,n){var i,s,o,a,c,u,l,h,f,d,p=t[0],m=t[1],y=t[2],g=n[0],v=n[1],w=n[2],b=r[0],T=r[1],_=r[2];return Math.abs(p-b)<1e-6&&Math.abs(m-T)<1e-6&&Math.abs(y-_)<1e-6?function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e):(l=p-b,h=m-T,f=y-_,i=v*(f*=d=1/Math.hypot(l,h,f))-w*(h*=d),s=w*(l*=d)-g*f,o=g*h-v*l,(d=Math.hypot(i,s,o))?(i*=d=1/d,s*=d,o*=d):(i=0,s=0,o=0),a=h*o-f*s,c=f*i-l*o,u=l*s-h*i,(d=Math.hypot(a,c,u))?(a*=d=1/d,c*=d,u*=d):(a=0,c=0,u=0),e[0]=i,e[1]=a,e[2]=l,e[3]=0,e[4]=s,e[5]=c,e[6]=h,e[7]=0,e[8]=o,e[9]=u,e[10]=f,e[11]=0,e[12]=-(i*p+s*m+o*y),e[13]=-(a*p+c*m+u*y),e[14]=-(l*p+h*m+f*y),e[15]=1,e)}function mn(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[0],a=r[1],c=r[2],u=r[3],l=u*n+a*s-c*i,h=u*i+c*n-o*s,f=u*s+o*i-a*n,d=-o*n-a*i-c*s;return e[0]=l*u+d*-o+h*-c-f*-a,e[1]=h*u+d*-a+f*-o-l*-c,e[2]=f*u+d*-c+l*-a-h*-o,e[3]=t[3],e}function yn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}!function(){var e=function(){var e=new Lr(4);return Lr!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();var gn=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),vn=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),wn=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),bn={},Tn=function(e){br(r,en);var t=yn(r);function r(e){var n;return it(this,r),n=t.call(this,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?n.copy(e):n.identity(),n}return ot(r,[{key:"INDICES",get:function(){return wn}},{key:"ELEMENTS",get:function(){return 16}},{key:"RANK",get:function(){return 4}}],[{key:"IDENTITY",get:function(){return bn.IDENTITY=bn.IDENTITY||Object.freeze(new r(gn)),bn.IDENTITY}},{key:"ZERO",get:function(){return bn.ZERO=bn.ZERO||Object.freeze(new r(vn)),bn.ZERO}}]),ot(r,[{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}},{key:"set",value:function(e,t,r,n,i,s,o,a,c,u,l,h,f,d,p,m){return this[0]=e,this[1]=t,this[2]=r,this[3]=n,this[4]=i,this[5]=s,this[6]=o,this[7]=a,this[8]=c,this[9]=u,this[10]=l,this[11]=h,this[12]=f,this[13]=d,this[14]=p,this[15]=m,this.check()}},{key:"setRowMajor",value:function(e,t,r,n,i,s,o,a,c,u,l,h,f,d,p,m){return this[0]=e,this[1]=i,this[2]=c,this[3]=f,this[4]=t,this[5]=s,this[6]=u,this[7]=d,this[8]=r,this[9]=o,this[10]=l,this[11]=p,this[12]=n,this[13]=a,this[14]=h,this[15]=m,this.check()}},{key:"toRowMajor",value:function(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}},{key:"identity",value:function(){return this.copy(gn)}},{key:"fromQuaternion",value:function(e){return function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],o=r+r,a=n+n,c=i+i,u=r*o,l=n*o,h=n*a,f=i*o,d=i*a,p=i*c,m=s*o,y=s*a,g=s*c;e[0]=1-h-p,e[1]=l+g,e[2]=f-y,e[3]=0,e[4]=l-g,e[5]=1-u-p,e[6]=d+m,e[7]=0,e[8]=f+y,e[9]=d-m,e[10]=1-u-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this,e),this.check()}},{key:"frustum",value:function(e){var t=e.left,n=e.right,i=e.bottom,s=e.top,o=e.near,a=e.far;return a===1/0?r._computeInfinitePerspectiveOffCenter(this,t,n,i,s,o):function(e,t,r,n,i,s,o){var a=1/(r-t),c=1/(i-n),u=1/(s-o);e[0]=2*s*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*c,e[6]=0,e[7]=0,e[8]=(r+t)*a,e[9]=(i+n)*c,e[10]=(o+s)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*s*2*u,e[15]=0}(this,t,n,i,s,o,a),this.check()}},{key:"lookAt",value:function(e,t,r){if(1===arguments.length){var n=e;e=n.eye,t=n.center,r=n.up}return pn(this,e,t=t||[0,0,0],r=r||[0,1,0]),this.check()}},{key:"ortho",value:function(e){var t=e.left,r=e.right,n=e.bottom,i=e.top,s=e.near,o=void 0===s?.1:s,a=e.far;return function(e,t,r,n,i,s,o){var a=1/(t-r),c=1/(n-i),u=1/(s-o);e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+r)*a,e[13]=(i+n)*c,e[14]=(o+s)*u,e[15]=1}(this,t,r,n,i,o,void 0===a?500:a),this.check()}},{key:"orthographic",value:function(e){var t=e.fovy,n=void 0===t?45*Math.PI/180:t,i=e.aspect,s=void 0===i?1:i,o=e.focalDistance,a=void 0===o?1:o,c=e.near,u=void 0===c?.1:c,l=e.far,h=void 0===l?500:l;if(n>2*Math.PI)throw Error("radians");var f=n/2,d=a*Math.tan(f),p=d*s;return(new r).ortho({left:-p,right:p,bottom:-d,top:d,near:u,far:h})}},{key:"perspective",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fovy,r=void 0===t?void 0:t,n=e.fov,i=void 0===n?45*Math.PI/180:n,s=e.aspect,o=void 0===s?1:s,a=e.near,c=void 0===a?.1:a,u=e.far,l=void 0===u?500:u;if((r=r||i)>2*Math.PI)throw Error("radians");return dn(this,r,o,c,l),this.check()}},{key:"determinant",value:function(){return t=(e=this)[0],r=e[1],n=e[2],i=e[3],s=e[4],o=e[5],a=e[6],c=e[7],u=e[8],l=e[9],h=e[10],f=e[11],d=e[12],p=e[13],m=e[14],y=e[15],(t*o-r*s)*(h*y-f*m)-(t*a-n*s)*(l*y-f*p)+(t*c-i*s)*(l*m-h*p)+(r*a-n*o)*(u*y-f*d)-(r*c-i*o)*(u*m-h*d)+(n*c-i*a)*(u*p-l*d);var e,t,r,n,i,s,o,a,c,u,l,h,f,d,p,m,y}},{key:"getScale",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0];return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}},{key:"getTranslation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0];return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}},{key:"getRotation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.getScale(t||[-0,-0,-0]),n=1/r[0],i=1/r[1],s=1/r[2];return e[0]=this[0]*n,e[1]=this[1]*i,e[2]=this[2]*s,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*i,e[6]=this[6]*s,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*i,e[10]=this[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"getRotationMatrix3",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.getScale(t||[-0,-0,-0]),n=1/r[0],i=1/r[1],s=1/r[2];return e[0]=this[0]*n,e[1]=this[1]*i,e[2]=this[2]*s,e[3]=this[4]*n,e[4]=this[5]*i,e[5]=this[6]*s,e[6]=this[8]*n,e[7]=this[9]*i,e[8]=this[10]*s,e}},{key:"transpose",value:function(){return function(e,t){if(e===t){var r=t[1],n=t[2],i=t[3],s=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=s,e[11]=t[14],e[12]=i,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}(this,this),this.check()}},{key:"invert",value:function(){return function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],o=t[4],a=t[5],c=t[6],u=t[7],l=t[8],h=t[9],f=t[10],d=t[11],p=t[12],m=t[13],y=t[14],g=t[15],v=r*a-n*o,w=r*c-i*o,b=r*u-s*o,T=n*c-i*a,_=n*u-s*a,x=i*u-s*c,S=l*m-h*p,E=l*y-f*p,A=l*g-d*p,M=h*y-f*m,R=h*g-d*m,O=f*g-d*y,I=v*O-w*R+b*M+T*A-_*E+x*S;I&&(I=1/I,e[0]=(a*O-c*R+u*M)*I,e[1]=(i*R-n*O-s*M)*I,e[2]=(m*x-y*_+g*T)*I,e[3]=(f*_-h*x-d*T)*I,e[4]=(c*A-o*O-u*E)*I,e[5]=(r*O-i*A+s*E)*I,e[6]=(y*b-p*x-g*w)*I,e[7]=(l*x-f*b+d*w)*I,e[8]=(o*R-a*A+u*S)*I,e[9]=(n*A-r*R-s*S)*I,e[10]=(p*_-m*b+g*v)*I,e[11]=(h*b-l*_-d*v)*I,e[12]=(a*E-o*M-c*S)*I,e[13]=(r*M-n*E+i*S)*I,e[14]=(m*w-p*T-y*v)*I,e[15]=(l*T-h*w+f*v)*I)}(this,this),this.check()}},{key:"multiplyLeft",value:function(e){return hn(this,e,this),this.check()}},{key:"multiplyRight",value:function(e){return hn(this,this,e),this.check()}},{key:"rotateX",value:function(e){return function(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[4],o=t[5],a=t[6],c=t[7],u=t[8],l=t[9],h=t[10],f=t[11];t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*i+u*n,e[5]=o*i+l*n,e[6]=a*i+h*n,e[7]=c*i+f*n,e[8]=u*i-s*n,e[9]=l*i-o*n,e[10]=h*i-a*n,e[11]=f*i-c*n}(this,this,e),this.check()}},{key:"rotateY",value:function(e){return function(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[0],o=t[1],a=t[2],c=t[3],u=t[8],l=t[9],h=t[10],f=t[11];t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i-u*n,e[1]=o*i-l*n,e[2]=a*i-h*n,e[3]=c*i-f*n,e[8]=s*n+u*i,e[9]=o*n+l*i,e[10]=a*n+h*i,e[11]=c*n+f*i}(this,this,e),this.check()}},{key:"rotateZ",value:function(e){return function(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[0],o=t[1],a=t[2],c=t[3],u=t[4],l=t[5],h=t[6],f=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i+u*n,e[1]=o*i+l*n,e[2]=a*i+h*n,e[3]=c*i+f*n,e[4]=u*i-s*n,e[5]=l*i-o*n,e[6]=h*i-a*n,e[7]=f*i-c*n}(this,this,e),this.check()}},{key:"rotateXYZ",value:function(e){var t=ln(e,3),r=t[0],n=t[1],i=t[2];return this.rotateX(r).rotateY(n).rotateZ(i)}},{key:"rotateAxis",value:function(e,t){return function(e,t,r,n){var i,s,o,a,c,u,l,h,f,d,p,m,y,g,v,w,b,T,_,x,S,E,A,M,R=n[0],O=n[1],I=n[2],k=Math.hypot(R,O,I);k<1e-6||(R*=k=1/k,O*=k,I*=k,i=Math.sin(r),o=1-(s=Math.cos(r)),a=t[0],c=t[1],u=t[2],l=t[3],h=t[4],f=t[5],d=t[6],p=t[7],m=t[8],y=t[9],g=t[10],v=t[11],w=R*R*o+s,b=O*R*o+I*i,T=I*R*o-O*i,_=R*O*o-I*i,x=O*O*o+s,S=I*O*o+R*i,E=R*I*o+O*i,A=O*I*o-R*i,M=I*I*o+s,e[0]=a*w+h*b+m*T,e[1]=c*w+f*b+y*T,e[2]=u*w+d*b+g*T,e[3]=l*w+p*b+v*T,e[4]=a*_+h*x+m*S,e[5]=c*_+f*x+y*S,e[6]=u*_+d*x+g*S,e[7]=l*_+p*x+v*S,e[8]=a*E+h*A+m*M,e[9]=c*E+f*A+y*M,e[10]=u*E+d*A+g*M,e[11]=l*E+p*A+v*M,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(this,this,e,t),this.check()}},{key:"scale",value:function(e){return Array.isArray(e)?fn(this,this,e):fn(this,this,[e,e,e]),this.check()}},{key:"translate",value:function(e){return function(e,t,r){var n,i,s,o,a,c,u,l,h,f,d,p,m=r[0],y=r[1],g=r[2];t===e?(e[12]=t[0]*m+t[4]*y+t[8]*g+t[12],e[13]=t[1]*m+t[5]*y+t[9]*g+t[13],e[14]=t[2]*m+t[6]*y+t[10]*g+t[14],e[15]=t[3]*m+t[7]*y+t[11]*g+t[15]):(n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],c=t[5],u=t[6],l=t[7],h=t[8],f=t[9],d=t[10],p=t[11],e[0]=n,e[1]=i,e[2]=s,e[3]=o,e[4]=a,e[5]=c,e[6]=u,e[7]=l,e[8]=h,e[9]=f,e[10]=d,e[11]=p,e[12]=n*m+a*y+h*g+t[12],e[13]=i*m+c*y+f*g+t[13],e[14]=s*m+u*y+d*g+t[14],e[15]=o*m+l*y+p*g+t[15])}(this,this,e),this.check()}},{key:"transform",value:function(e,t){return 4===e.length?(Rr(t=function(e,t,r){var n=t[0],i=t[1],s=t[2],o=t[3];return e[0]=r[0]*n+r[4]*i+r[8]*s+r[12]*o,e[1]=r[1]*n+r[5]*i+r[9]*s+r[13]*o,e[2]=r[2]*n+r[6]*i+r[10]*s+r[14]*o,e[3]=r[3]*n+r[7]*i+r[11]*s+r[15]*o,e}(t||[-0,-0,-0,-0],e,this),4),t):this.transformAsPoint(e,t)}},{key:"transformAsPoint",value:function(e,t){switch(e.length){case 2:t=Ur(t||[-0,-0],e,this);break;case 3:t=Wr(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Rr(t,e.length),t}},{key:"transformAsVector",value:function(e,t){switch(e.length){case 2:t=Dr(t||[-0,-0],e,this);break;case 3:t=jr(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Rr(t,e.length),t}},{key:"makeRotationX",value:function(e){return this.identity().rotateX(e)}},{key:"makeTranslation",value:function(e,t,r){return this.identity().translate([e,t,r])}},{key:"transformPoint",value:function(e,t){return Ir("Matrix4.transformPoint","3.0"),this.transformAsPoint(e,t)}},{key:"transformVector",value:function(e,t){return Ir("Matrix4.transformVector","3.0"),this.transformAsPoint(e,t)}},{key:"transformDirection",value:function(e,t){return Ir("Matrix4.transformDirection","3.0"),this.transformAsVector(e,t)}}],[{key:"_computeInfinitePerspectiveOffCenter",value:function(e,t,r,n,i,s){var o=2*s/(r-t),a=2*s/(i-n),c=(r+t)/(r-t),u=(i+n)/(i-n),l=-2*s;return e[0]=o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=c,e[9]=u,e[10]=-1,e[11]=-1,e[12]=0,e[13]=0,e[14]=l,e[15]=0,e}}]),r}();function _n(){var e=new Lr(4);return Lr!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function xn(e,t,r){r*=.5;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e}function Sn(e,t,r){var n=t[0],i=t[1],s=t[2],o=t[3],a=r[0],c=r[1],u=r[2],l=r[3];return e[0]=n*l+o*a+i*u-s*c,e[1]=i*l+o*c+s*a-n*u,e[2]=s*l+o*u+n*c-i*a,e[3]=o*l-n*a-i*c-s*u,e}function En(e,t,r,n){var i,s,o,a,c,u=t[0],l=t[1],h=t[2],f=t[3],d=r[0],p=r[1],m=r[2],y=r[3];return(s=u*d+l*p+h*m+f*y)<0&&(s=-s,d=-d,p=-p,m=-m,y=-y),1-s>1e-6?(i=Math.acos(s),o=Math.sin(i),a=Math.sin((1-n)*i)/o,c=Math.sin(n*i)/o):(a=1-n,c=n),e[0]=a*u+c*d,e[1]=a*l+c*p,e[2]=a*h+c*m,e[3]=a*f+c*y,e}function An(e,t){var r,n=t[0]+t[4]+t[8];if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(t[3*i+i]-t[3*s+s]-t[3*o+o]+1),e[i]=.5*r,r=.5/r,e[3]=(t[3*s+o]-t[3*o+s])*r,e[s]=(t[3*s+i]+t[3*i+s])*r,e[o]=(t[3*o+i]+t[3*i+o])*r}return e}var Mn,Rn,On,In=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},kn=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},Nn=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Cn=function(e,t,r,n){var i=t[0],s=t[1],o=t[2],a=t[3];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=o+n*(r[2]-o),e[3]=a+n*(r[3]-a),e},Ln=function(e){var t=e[0],r=e[1],n=e[2],i=e[3];return Math.hypot(t,r,n,i)},Pn=function(e){var t=e[0],r=e[1],n=e[2],i=e[3];return t*t+r*r+n*n+i*i},Un=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],o=r*r+n*n+i*i+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=r*o,e[1]=n*o,e[2]=i*o,e[3]=s*o,e},Dn=(Mn=Vr(),Rn=zr(1,0,0),On=zr(0,1,0),function(e,t,r){var n=Gr(t,r);return n<-.999999?(Hr(Mn,Rn,t),Qr(Mn)<1e-6&&Hr(Mn,On,t),function(e,t){var r=t[0],n=t[1],i=t[2],s=r*r+n*n+i*i;s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s}(Mn,Mn),xn(e,Mn,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(Hr(Mn,t,r),e[0]=Mn[0],e[1]=Mn[1],e[2]=Mn[2],e[3]=1+n,Un(e,e))});function jn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=_r(e);if(t){var i=_r(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Tr(this,r)}}_n(),_n(),function(){var e=new Lr(9);Lr!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1}();var Bn=[0,0,0,1],Fn=function(e){br(r,Er);var t=jn(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return it(this,r),e=t.call(this,-0,-0,-0,-0),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i,s,o),e}return ot(r,[{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}},{key:"set",value:function(e,t,r,n){return this[0]=e,this[1]=t,this[2]=r,this[3]=n,this.check()}},{key:"fromMatrix3",value:function(e){return An(this,e),this.check()}},{key:"identity",value:function(){return function(e){e[0]=0,e[1]=0,e[2]=0,e[3]=1}(this),this.check()}},{key:"fromAxisRotation",value:function(e,t){return xn(this,e,t),this.check()}},{key:"setAxisAngle",value:function(e,t){return this.fromAxisRotation(e,t)}},{key:"len",value:function(){return Ln(this)}},{key:"lengthSquared",value:function(){return Pn(this)}},{key:"dot",value:function(e,t){if(void 0!==t)throw new Error("Quaternion.dot only takes one argument");return Nn(this,e)}},{key:"rotationTo",value:function(e,t){return Dn(this,e,t),this.check()}},{key:"add",value:function(e,t){if(void 0!==t)throw new Error("Quaternion.add only takes one argument");return In(this,this,e),this.check()}},{key:"calculateW",value:function(){return function(e,t){var r=t[0],n=t[1],i=t[2];e[0]=r,e[1]=n,e[2]=i,e[3]=Math.sqrt(Math.abs(1-r*r-n*n-i*i))}(this,this),this.check()}},{key:"conjugate",value:function(){return function(e,t){e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3]}(this,this),this.check()}},{key:"invert",value:function(){return function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],o=r*r+n*n+i*i+s*s,a=o?1/o:0;e[0]=-r*a,e[1]=-n*a,e[2]=-i*a,e[3]=s*a}(this,this),this.check()}},{key:"lerp",value:function(e,t,r){return Cn(this,e,t,r),this.check()}},{key:"multiplyRight",value:function(e,t){return cr(!t),Sn(this,this,e),this.check()}},{key:"multiplyLeft",value:function(e,t){return cr(!t),Sn(this,e,this),this.check()}},{key:"normalize",value:function(){var e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,0===e&&(this[3]=1),this.check()}},{key:"rotateX",value:function(e){return function(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],o=t[3],a=Math.sin(r),c=Math.cos(r);e[0]=n*c+o*a,e[1]=i*c+s*a,e[2]=s*c-i*a,e[3]=o*c-n*a}(this,this,e),this.check()}},{key:"rotateY",value:function(e){return function(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],o=t[3],a=Math.sin(r),c=Math.cos(r);e[0]=n*c-s*a,e[1]=i*c+o*a,e[2]=s*c+n*a,e[3]=o*c-i*a}(this,this,e),this.check()}},{key:"rotateZ",value:function(e){return function(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],o=t[3],a=Math.sin(r),c=Math.cos(r);e[0]=n*c+i*a,e[1]=i*c-n*a,e[2]=s*c+o*a,e[3]=o*c-s*a}(this,this,e),this.check()}},{key:"scale",value:function(e){return kn(this,this,e),this.check()}},{key:"slerp",value:function(e,t,r){switch(arguments.length){case 1:var n=arguments[0],i=n.start;e=void 0===i?Bn:i,t=n.target,r=n.ratio;break;case 2:var s=Array.prototype.slice.call(arguments);t=s[0],r=s[1],e=this}return En(this,e,t,r),this.check()}},{key:"transformVector4",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;return mn(t,e,this),Rr(t,4)}},{key:"lengthSq",value:function(){return this.lengthSquared()}},{key:"setFromAxisAngle",value:function(e,t){return this.setAxisAngle(e,t)}},{key:"premultiply",value:function(e,t){return this.multiplyLeft(e,t)}},{key:"multiply",value:function(e,t){return this.multiplyRight(e,t)}},{key:"ELEMENTS",get:function(){return 4}},{key:"x",get:function(){return this[0]},set:function(e){this[0]=Mr(e)}},{key:"y",get:function(){return this[1]},set:function(e){this[1]=Mr(e)}},{key:"z",get:function(){return this[2]},set:function(e){this[2]=Mr(e)}},{key:"w",get:function(){return this[3]},set:function(e){this[3]=Mr(e)}}]),r}(),Vn=.1,qn=1e-12,zn=1e-15,Gn=(Math.PI,Math.PI,Math.PI,Math.PI,function(e){return e}),Hn=new Jr;function Wn(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Gn;return pr(e)?(t[0]=r(e[0]),t[1]=r(e[1]),t[2]=e[2]):"longitude"in e?(t[0]=r(e.longitude),t[1]=r(e.latitude),t[2]=e.height):(t[0]=r(e.x),t[1]=r(e.y),t[2]=e.z),t}function Kn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Hn;return Wn(e,t,hr._cartographicRadians?Gn:yr)}function Qn(e,t){return function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Gn;return pr(t)?(t[0]=r(e[0]),t[1]=r(e[1]),t[2]=e[2]):"longitude"in t?(t.longitude=r(e[0]),t.latitude=r(e[1]),t.height=e[2]):(t.x=r(e[0]),t.y=r(e[1]),t.z=e[2]),t}(e,t,hr._cartographicRadians?Gn:gr)}var Xn=new Jr,Yn=new Jr,Zn=new Jr;var Jn=new Jr,$n={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},ei={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},ti={east:new Jr,north:new Jr,up:new Jr,west:new Jr,south:new Jr,down:new Jr},ri=new Jr,ni=new Jr,ii=new Jr;function si(e,t,r,n,i,s){var o,a,c,u=$n[t]&&$n[t][r];cr(u&&(!n||n===u));var l=Jn.copy(i);if(wr(l.x,0,1e-14)&&wr(l.y,0,1e-14)){var h=Math.sign(l.z);o=ri.fromArray(ei[t]),"east"!==t&&"west"!==t&&o.scale(h),a=ni.fromArray(ei[r]),"east"!==r&&"west"!==r&&a.scale(h),c=ii.fromArray(ei[n]),"east"!==n&&"west"!==n&&c.scale(h)}else{var f=ti.up,d=ti.east,p=ti.north;d.set(-l.y,l.x,0).normalize(),e.geodeticSurfaceNormal(l,f),p.copy(f).cross(d);var m=ti.west,y=ti.south;ti.down.copy(f).scale(-1),m.copy(d).scale(-1),y.copy(p).scale(-1),o=ti[t],a=ti[r],c=ti[n]}return s[0]=o.x,s[1]=o.y,s[2]=o.z,s[3]=0,s[4]=a.x,s[5]=a.y,s[6]=a.z,s[7]=0,s[8]=c.x,s[9]=c.y,s[10]=c.z,s[11]=0,s[12]=l.x,s[13]=l.y,s[14]=l.z,s[15]=1,s}var oi,ai=new Jr,ci=new Jr,ui=new Jr,li=new Jr,hi=new Jr,fi=new Jr,di=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;it(this,e),cr(t>=0),cr(r>=0),cr(n>=0),this.radii=new Jr(t,r,n),this.radiiSquared=new Jr(t*t,r*r,n*n),this.radiiToTheFourth=new Jr(t*t*t*t,r*r*r*r,n*n*n*n),this.oneOverRadii=new Jr(0===t?0:1/t,0===r?0:1/r,0===n?0:1/n),this.oneOverRadiiSquared=new Jr(0===t?0:1/(t*t),0===r?0:1/(r*r),0===n?0:1/(n*n)),this.minimumRadius=Math.min(t,r,n),this.maximumRadius=Math.max(t,r,n),this.centerToleranceSquared=Vn,0!==this.radiiSquared.z&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}return ot(e,null,[{key:"WGS84",get:function(){return oi=oi||new e(6378137,6378137,6356752.314245179)}}]),ot(e,[{key:"equals",value:function(e){return this===e||Boolean(e&&this.radii.equals(e.radii))}},{key:"toString",value:function(){return this.radii.toString()}},{key:"cartographicToCartesian",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0],r=ci,n=ui,i=ln(e,3),s=i[2];this.geodeticSurfaceNormalCartographic(e,r),n.copy(this.radiiSquared).scale(r);var o=Math.sqrt(r.dot(n));return n.scale(1/o),r.scale(s),n.add(r),n.to(t)}},{key:"cartesianToCartographic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];fi.from(e);var r=this.scaleToGeodeticSurface(fi,li);if(r){var n=this.geodeticSurfaceNormal(r,ci),i=hi;i.copy(fi).subtract(r);var s=Math.atan2(n.y,n.x),o=Math.asin(n.z),a=Math.sign(Gr(i,fi))*qr(i);return Qn([s,o,a],t)}}},{key:"eastNorthUpToFixedFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Tn;return si(this,"east","north","up",e,t)}},{key:"localFrameToFixedFrame",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Tn;return si(this,e,t,r,n,i)}},{key:"geocentricSurfaceNormal",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];return ai.from(e).normalize().to(t)}},{key:"geodeticSurfaceNormalCartographic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0],r=Kn(e),n=r[0],i=r[1],s=Math.cos(i);return ai.set(s*Math.cos(n),s*Math.sin(n),Math.sin(i)).normalize(),ai.to(t)}},{key:"geodeticSurfaceNormal",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];return ai.from(e).scale(this.oneOverRadiiSquared).normalize().to(t)}},{key:"scaleToGeodeticSurface",value:function(e,t){return function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Jr,n=t.oneOverRadii,i=t.oneOverRadiiSquared,s=t.centerToleranceSquared;Xn.from(e);var o=e.x,a=e.y,c=e.z,u=n.x,l=n.y,h=n.z,f=o*o*u*u,d=a*a*l*l,p=c*c*h*h,m=f+d+p,y=Math.sqrt(1/m);if(Number.isFinite(y)){var g=Yn;if(g.copy(e).scale(y),m<s)return g.to(r);var v=i.x,w=i.y,b=i.z,T=Zn;T.set(g.x*v*2,g.y*w*2,g.z*b*2);var _,x,S,E,A=(1-y)*e.len()/(.5*T.len()),M=0;do{var R=(_=1/(1+(A-=M)*v))*_,O=(x=1/(1+A*w))*x,I=(S=1/(1+A*b))*S;M=(E=f*R+d*O+p*I-1)/(-2*(f*(R*_)*v+d*(O*x)*w+p*(I*S)*b))}while(Math.abs(E)>qn);return Xn.scale([_,x,S]).to(r)}}(e,this,t)}},{key:"scaleToGeocentricSurface",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];li.from(e);var r=li.x,n=li.y,i=li.z,s=this.oneOverRadiiSquared,o=1/Math.sqrt(r*r*s.x+n*n*s.y+i*i*s.z);return li.multiplyScalar(o).to(t)}},{key:"transformPositionToScaledSpace",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];return li.from(e).scale(this.oneOverRadii).to(t)}},{key:"transformPositionFromScaledSpace",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];return li.from(e).scale(this.radii).to(t)}},{key:"getSurfaceNormalIntersectionWithZAxis",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0,0];cr(wr(this.radii.x,this.radii.y,zn)),cr(this.radii.z>0),li.from(e);var n=li.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(n)>=this.radii.z-t))return li.set(0,0,n).to(r)}}]),e}();class pi{constructor(e,t,r){this.item=e,this.previous=t,this.next=r}}class mi{constructor(){this.head=null,this.tail=null,this._length=0}get length(){return this._length}add(e){const t=new pi(e,this.tail,null);return this.tail?(this.tail.next=t,this.tail=t):(this.head=t,this.tail=t),++this._length,t}remove(e){e&&(e.previous&&e.next?(e.previous.next=e.next,e.next.previous=e.previous):e.previous?(e.previous.next=null,this.tail=e.previous):e.next?(e.next.previous=null,this.head=e.next):(this.head=null,this.tail=null),e.next=null,e.previous=null,--this._length)}splice(e,t){e!==t&&(this.remove(t),this._insert(e,t))}_insert(e,t){const r=e.next;e.next=t,this.tail===e?this.tail=t:r.previous=t,t.next=r,t.previous=e,++this._length}}function yi(e){return null!=e}class gi{constructor(){Ce(this,"_list",void 0),Ce(this,"_sentinel",void 0),Ce(this,"_trimTiles",void 0),this._list=new mi,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){const t=e._cacheNode;yi(t)&&this._list.splice(this._sentinel,t)}add(e,t,r){yi(t._cacheNode)||(t._cacheNode=this._list.add(t),r&&r(e,t))}unloadTile(e,t,r){const n=t._cacheNode;yi(n)&&(this._list.remove(n),t._cacheNode=void 0,r&&r(e,t))}unloadTiles(e,t){const r=this._trimTiles;this._trimTiles=!1;const n=this._list,i=1024*e.maximumMemoryUsage*1024,s=this._sentinel;let o=n.head;for(;o!==s&&(e.gpuMemoryUsageInBytes>i||r);){const r=o.item;o=o.next,this.unloadTile(e,r,t)}}trim(){this._trimTiles=!0}}var vi=Object.freeze({OUTSIDE:-1,INTERSECTING:0,INSIDE:1}),wi=new Jr,bi=new Jr;!function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;it(this,e),n=n||wi.copy(t).add(r).scale(.5),this.center=new Jr(n),this.halfDiagonal=new Jr(r).subtract(this.center),this.minimum=new Jr(t),this.maximum=new Jr(r)}ot(e,[{key:"clone",value:function(){return new e(this.minimum,this.maximum,this.center)}},{key:"equals",value:function(e){return this===e||Boolean(e)&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}},{key:"intersectPlane",value:function(e){var t=this.halfDiagonal,r=bi.from(e.normal),n=t.x*Math.abs(r.x)+t.y*Math.abs(r.y)+t.z*Math.abs(r.z),i=this.center.dot(r)+e.distance;return i-n>0?vi.INSIDE:i+n<0?vi.OUTSIDE:vi.INTERSECTING}},{key:"distanceTo",value:function(e){return Math.sqrt(this.distanceSquaredTo(e))}},{key:"distanceSquaredTo",value:function(e){var t,r=wi.from(e).subtract(this.center),n=this.halfDiagonal,i=0;return(t=Math.abs(r.x)-n.x)>0&&(i+=t*t),(t=Math.abs(r.y)-n.y)>0&&(i+=t*t),(t=Math.abs(r.z)-n.z)>0&&(i+=t*t),i}}])}();var Ti=new Jr,_i=new Jr,xi=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;it(this,e),this.radius=-0,this.center=new Jr,this.fromCenterRadius(t,r)}return ot(e,[{key:"fromCenterRadius",value:function(e,t){return this.center.from(e),this.radius=t,this}},{key:"fromCornerPoints",value:function(e,t){return t=Ti.from(t),this.center=(new Jr).from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}},{key:"equals",value:function(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.radius===e.radius}},{key:"clone",value:function(){return new e(this.center,this.radius)}},{key:"union",value:function(e){var t=this.center,r=this.radius,n=e.center,i=e.radius,s=Ti.copy(n).subtract(t),o=s.magnitude();if(r>=o+i)return this.clone();if(i>=o+r)return e.clone();var a=.5*(r+o+i);return _i.copy(s).scale((-r+a)/o).add(t),this.center.copy(_i),this.radius=a,this}},{key:"expand",value:function(e){var t=(e=Ti.from(e)).subtract(this.center).magnitude();return t>this.radius&&(this.radius=t),this}},{key:"intersectPlane",value:function(e){var t=this.center,r=this.radius,n=e.normal.dot(t)+e.distance;return n<-r?vi.OUTSIDE:n<r?vi.INTERSECTING:vi.INSIDE}},{key:"transform",value:function(e){this.center.transform(e);var t=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[4],o=t[5],a=t[6],c=t[8],u=t[9],l=t[10];return e[0]=Math.hypot(r,n,i),e[1]=Math.hypot(s,o,a),e[2]=Math.hypot(c,u,l),e}(Ti,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}},{key:"distanceSquaredTo",value:function(e){return(e=Ti.from(e)).subtract(this.center).lengthSquared()-this.radius*this.radius}},{key:"distanceTo",value:function(e){return Math.sqrt(this.distanceSquaredTo(e))}}]),e}(),Si=new Jr,Ei=new Jr,Ai=new Jr,Mi=new Jr,Ri=new Jr,Oi=new Jr,Ii=new Jr,ki=new Jr,Ni=new Jr,Ci=new Jr,Li=0,Pi=1,Ui=2,Di=3,ji=4,Bi=5,Fi=6,Vi=7,qi=8,zi=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0,0,0,0,0,0,0];it(this,e),this.center=(new Jr).from(t),this.halfAxes=new un(r)}return ot(e,[{key:"fromCenterHalfSizeQuaternion",value:function(e,t,r){var n=new Fn(r),i=(new un).fromQuaternion(n);return i[0]=i[0]*t[0],i[1]=i[1]*t[0],i[2]=i[2]*t[0],i[3]=i[3]*t[1],i[4]=i[4]*t[1],i[5]=i[5]*t[1],i[6]=i[6]*t[2],i[7]=i[7]*t[2],i[8]=i[8]*t[2],this.center=(new Jr).from(e),this.halfAxes=i,this}},{key:"clone",value:function(){return new e(this.center,this.halfAxes)}},{key:"equals",value:function(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}},{key:"getBoundingSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new xi,t=this.halfAxes,r=t.getColumn(0,ki),n=t.getColumn(1,Ni),i=t.getColumn(2,Ci),s=Si.copy(r).add(n).add(i);return e.center.copy(this.center),e.radius=s.magnitude(),e}},{key:"intersectPlane",value:function(e){var t=this.center,r=e.normal,n=this.halfAxes,i=r.x,s=r.y,o=r.z,a=Math.abs(i*n[Li]+s*n[Pi]+o*n[Ui])+Math.abs(i*n[Di]+s*n[ji]+o*n[Bi])+Math.abs(i*n[Fi]+s*n[Vi]+o*n[qi]),c=r.dot(t)+e.distance;return c<=-a?vi.OUTSIDE:c>=a?vi.INSIDE:vi.INTERSECTING}},{key:"distanceTo",value:function(e){return Math.sqrt(this.distanceSquaredTo(e))}},{key:"distanceSquaredTo",value:function(e){var t=Ei.from(e).subtract(this.center),r=this.halfAxes,n=r.getColumn(0,Ai),i=r.getColumn(1,Mi),s=r.getColumn(2,Ri),o=n.magnitude(),a=i.magnitude(),c=s.magnitude();n.normalize(),i.normalize(),s.normalize();var u,l=0;return(u=Math.abs(t.dot(n))-o)>0&&(l+=u*u),(u=Math.abs(t.dot(i))-a)>0&&(l+=u*u),(u=Math.abs(t.dot(s))-c)>0&&(l+=u*u),l}},{key:"computePlaneDistances",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[-0,-0],n=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=this.center,o=this.halfAxes,a=o.getColumn(0,Ai),c=o.getColumn(1,Mi),u=o.getColumn(2,Ri),l=Oi.copy(a).add(c).add(u).add(s),h=Ii.copy(l).subtract(e),f=t.dot(h);return n=Math.min(f,n),i=Math.max(f,i),l.copy(s).add(a).add(c).subtract(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),l.copy(s).add(a).subtract(c).add(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),l.copy(s).add(a).subtract(c).subtract(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),s.copy(l).subtract(a).add(c).add(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),s.copy(l).subtract(a).add(c).subtract(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),s.copy(l).subtract(a).subtract(c).add(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),s.copy(l).subtract(a).subtract(c).subtract(u),h.copy(l).subtract(e),f=t.dot(h),n=Math.min(f,n),i=Math.max(f,i),r[0]=n,r[1]=i,r}},{key:"getTransform",value:function(){}},{key:"halfSize",get:function(){var e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),r=this.halfAxes.getColumn(2);return[new Jr(e).len(),new Jr(t).len(),new Jr(r).len()]}},{key:"quaternion",get:function(){var e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),r=this.halfAxes.getColumn(2),n=new Jr(e).normalize(),i=new Jr(t).normalize(),s=new Jr(r).normalize();return(new Fn).fromMatrix3(new un([].concat(ar(n),ar(i),ar(s))))}}]),e}(),Gi=new Jr,Hi=new Jr,Wi=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,1],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;it(this,e),this.normal=new Jr,this.distance=-0,this.fromNormalDistance(t,r)}return ot(e,[{key:"fromNormalDistance",value:function(e,t){return cr(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}},{key:"fromPointNormal",value:function(e,t){e=Gi.from(e),this.normal.from(t).normalize();var r=-this.normal.dot(e);return this.distance=r,this}},{key:"fromCoefficients",value:function(e,t,r,n){return this.normal.set(e,t,r),cr(wr(this.normal.len(),1)),this.distance=n,this}},{key:"clone",value:function(t){return new e(this.normal,this.distance)}},{key:"equals",value:function(e){return wr(this.distance,e.distance)&&wr(this.normal,e.normal)}},{key:"getPointDistance",value:function(e){return this.normal.dot(e)+this.distance}},{key:"transform",value:function(e){var t=Hi.copy(this.normal).transformAsVector(e).normalize(),r=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(r,t)}},{key:"projectPointOntoPlane",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];e=Gi.from(e);var r=this.getPointDistance(e),n=Hi.copy(this.normal).scale(r);return e.subtract(n).to(t)}}]),e}();function Ki(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Qi(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Qi(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw s}}}}function Qi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Xi=[new Jr([1,0,0]),new Jr([0,1,0]),new Jr([0,0,1])],Yi=new Jr,Zi=new Jr;new Wi(new Jr(1,0,0),0);var Ji=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];it(this,e),this.planes=t,cr(this.planes.every((function(e){return e instanceof Wi})))}return ot(e,null,[{key:"MASK_OUTSIDE",get:function(){return 4294967295}},{key:"MASK_INSIDE",get:function(){return 0}},{key:"MASK_INDETERMINATE",get:function(){return 2147483647}}]),ot(e,[{key:"fromBoundingSphere",value:function(e){this.planes.length=2*Xi.length;var t,r=e.center,n=e.radius,i=0,s=Ki(Xi);try{for(s.s();!(t=s.n()).done;){var o=t.value,a=this.planes[i],c=this.planes[i+1];a||(a=this.planes[i]=new Wi),c||(c=this.planes[i+1]=new Wi);var u=Yi.copy(o).scale(-n).add(r);o.dot(u);a.fromPointNormal(u,o);var l=Yi.copy(o).scale(n).add(r),h=Zi.copy(o).negate();h.dot(l);c.fromPointNormal(l,h),i+=2}}catch(e){s.e(e)}finally{s.f()}return this}},{key:"computeVisibility",value:function(e){cr(e);var t,r=vi.INSIDE,n=Ki(this.planes);try{for(n.s();!(t=n.n()).done;){var i=t.value;switch(e.intersectPlane(i)){case vi.OUTSIDE:return vi.OUTSIDE;case vi.INTERSECTING:r=vi.INTERSECTING}}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"computeVisibilityWithPlaneMask",value:function(t,r){if(cr(t,"boundingVolume is required."),cr(Number.isFinite(r),"parentPlaneMask is required."),r===e.MASK_OUTSIDE||r===e.MASK_INSIDE)return r;for(var n=e.MASK_INSIDE,i=this.planes,s=0;s<this.planes.length;++s){var o=s<31?1<<s:0;if(!(s<31&&0==(r&o))){var a=i[s],c=t.intersectPlane(a);if(c===vi.OUTSIDE)return e.MASK_OUTSIDE;c===vi.INTERSECTING&&(n|=o)}}return n}}]),e}();function $i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function es(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?$i(Object(r),!0).forEach((function(t){Ce(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):$i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var ts=new Jr,rs=new Jr,ns=new Jr,is=new Jr,ss=new Jr,os=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};it(this,e),t=es({near:1,far:5e8},t),this.left=t.left,this._left=void 0,this.right=t.right,this._right=void 0,this.top=t.top,this._top=void 0,this.bottom=t.bottom,this._bottom=void 0,this.near=t.near,this._near=this.near,this.far=t.far,this._far=this.far,this._cullingVolume=new Ji([new Wi,new Wi,new Wi,new Wi,new Wi,new Wi]),this._perspectiveMatrix=new Tn,this._infinitePerspective=new Tn}return ot(e,[{key:"clone",value:function(){return new e({right:this.right,left:this.left,top:this.top,bottom:this.bottom,near:this.near,far:this.far})}},{key:"equals",value:function(t){return t&&t instanceof e&&this.right===t.right&&this.left===t.left&&this.top===t.top&&this.bottom===t.bottom&&this.near===t.near&&this.far===t.far}},{key:"computeCullingVolume",value:function(e,t,r){cr(e,"position is required."),cr(t,"direction is required."),cr(r,"up is required.");var n=this._cullingVolume.planes;r=ts.copy(r).normalize();var i=rs.copy(t).cross(r).normalize(),s=ns.copy(t).multiplyByScalar(this.near).add(e),o=is.copy(t).multiplyByScalar(this.far).add(e),a=ss;return a.copy(i).multiplyByScalar(this.left).add(s).subtract(e).cross(r),n[0].fromPointNormal(e,a),a.copy(i).multiplyByScalar(this.right).add(s).subtract(e).cross(r).negate(),n[1].fromPointNormal(e,a),a.copy(r).multiplyByScalar(this.bottom).add(s).subtract(e).cross(i).negate(),n[2].fromPointNormal(e,a),a.copy(r).multiplyByScalar(this.top).add(s).subtract(e).cross(i),n[3].fromPointNormal(e,a),a=(new Jr).copy(t),n[4].fromPointNormal(s,a),a.negate(),n[5].fromPointNormal(o,a),this._cullingVolume}},{key:"getPixelDimensions",value:function(e,t,r,n){as(this),cr(Number.isFinite(e)&&Number.isFinite(t)),cr(e>0),cr(t>0),cr(r>0),cr(n);var i=1/this.near,s=this.top*i,o=2*r*s/t,a=2*r*(s=this.right*i)/e;return n.x=a,n.y=o,n}},{key:"projectionMatrix",get:function(){return as(this),this._perspectiveMatrix}},{key:"infiniteProjectionMatrix",get:function(){return as(this),this._infinitePerspective}}]),e}();function as(e){cr(Number.isFinite(e.right)&&Number.isFinite(e.left)&&Number.isFinite(e.top)&&Number.isFinite(e.bottom)&&Number.isFinite(e.near)&&Number.isFinite(e.far));var t=e.top,r=e.bottom,n=e.right,i=e.left,s=e.near,o=e.far;t===e._top&&r===e._bottom&&i===e._left&&n===e._right&&s===e._near&&o===e._far||(cr(e.near>0&&e.near<e.far,"near must be greater than zero and less than far."),e._left=i,e._right=n,e._top=t,e._bottom=r,e._near=s,e._far=o,e._perspectiveMatrix=(new Tn).frustum({left:i,right:n,bottom:r,top:t,near:s,far:o}),e._infinitePerspective=(new Tn).frustum({left:i,right:n,bottom:r,top:t,near:s,far:1/0}))}function cs(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function us(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?cs(Object(r),!0).forEach((function(t){Ce(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):cs(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var ls=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};it(this,e),t=us({near:1,far:5e8,xOffset:0,yOffset:0},t),this._offCenterFrustum=new os,this.fov=t.fov,this._fov=void 0,this._fovy=void 0,this._sseDenominator=void 0,this.aspectRatio=t.aspectRatio,this._aspectRatio=void 0,this.near=t.near,this._near=this.near,this.far=t.far,this._far=this.far,this.xOffset=t.xOffset,this._xOffset=this.xOffset,this.yOffset=t.yOffset,this._yOffset=this.yOffset}return ot(e,[{key:"clone",value:function(){return new e({aspectRatio:this.aspectRatio,fov:this.fov,near:this.near,far:this.far})}},{key:"equals",value:function(t){return null!=t&&t instanceof e&&(hs(this),hs(t),this.fov===t.fov&&this.aspectRatio===t.aspectRatio&&this.near===t.near&&this.far===t.far&&this._offCenterFrustum.equals(t._offCenterFrustum))}},{key:"computeCullingVolume",value:function(e,t,r){return hs(this),this._offCenterFrustum.computeCullingVolume(e,t,r)}},{key:"getPixelDimensions",value:function(e,t,r,n){return hs(this),this._offCenterFrustum.getPixelDimensions(e,t,r,n)}},{key:"projectionMatrix",get:function(){return hs(this),this._offCenterFrustum.projectionMatrix}},{key:"infiniteProjectionMatrix",get:function(){return hs(this),this._offCenterFrustum.infiniteProjectionMatrix}},{key:"fovy",get:function(){return hs(this),this._fovy}},{key:"sseDenominator",get:function(){return hs(this),this._sseDenominator}}]),e}();function hs(e){cr(Number.isFinite(e.fov)&&Number.isFinite(e.aspectRatio)&&Number.isFinite(e.near)&&Number.isFinite(e.far));var t=e._offCenterFrustum;e.fov===e._fov&&e.aspectRatio===e._aspectRatio&&e.near===e._near&&e.far===e._far&&e.xOffset===e._xOffset&&e.yOffset===e._yOffset||(cr(e.fov>=0&&e.fov<Math.PI),cr(e.aspectRatio>0),cr(e.near>=0&&e.near<e.far),e._aspectRatio=e.aspectRatio,e._fov=e.fov,e._fovy=e.aspectRatio<=1?e.fov:2*Math.atan(Math.tan(.5*e.fov)/e.aspectRatio),e._near=e.near,e._far=e.far,e._sseDenominator=2*Math.tan(.5*e._fovy),e._xOffset=e.xOffset,e._yOffset=e.yOffset,t.top=e.near*Math.tan(.5*e._fovy),t.bottom=-t.top,t.right=e.aspectRatio*t.top,t.left=-t.right,t.near=e.near,t.far=e.far,t.right+=e.xOffset,t.left+=e.xOffset,t.top+=e.yOffset,t.bottom+=e.yOffset)}new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new Jr,new un,new un,new un,new un,new un,new Jr,new Jr,new Jr,new Jr,new Jr,new un,new un,new un;const fs=new Jr,ds=new Jr,ps=new Ji([new Wi,new Wi,new Wi,new Wi,new Wi,new Wi]);function ms(e,t){const{cameraDirection:r,cameraUp:n,height:i}=e,{metersPerUnit:s}=e.distanceScales,o=[e.longitude,e.latitude,0],a=di.WGS84.cartographicToCartesian(o,new Jr),c=di.WGS84.eastNorthUpToFixedFrame(a),u=e.unprojectPosition(e.cameraPosition),l=di.WGS84.cartographicToCartesian(u,new Jr),h=new Jr(c.transformAsVector(new Jr(r).scale(s))).normalize(),f=new Jr(c.transformAsVector(new Jr(n).scale(s))).normalize();return function(e,t){const r=e.getFrustumPlanes();let n=0;for(const i in r){const s=r[i],o=s.normal.dot(e.center);ds.copy(s.normal).scale(s.distance-o).add(e.center);const a=e.unprojectPosition(ds),c=di.WGS84.cartographicToCartesian(a,new Jr);ps.planes[n++].fromPointNormal(c,fs.copy(t).subtract(c))}}(e,a),{camera:{position:l,direction:h,up:f},viewport:e,height:i,cullingVolume:ps,frameNumber:t,sseDenominator:1.15}}const ys=new Jr;function gs(e){const{halfAxes:t,radius:r,width:n,height:i}=e;if(t){const e=function(e){e.getColumn(0,ys);const t=e.getColumn(1),r=e.getColumn(2),n=ys.add(t).add(r);return n.len()}(t);return Math.log2(6356752.314245179/e)}if(r)return Math.log2(6356752.314245179/r);if(i&&n){return(Math.log2(6378137/n)+Math.log2(6378137/i))/2}return 1}const vs=0,ws=1,bs=3,Ts=4,_s=5,xs=1,Ss=2,Es="empty",As="scenegraph",Ms="pointcloud",Rs="mesh",Os="I3S",Is="TILES3D",ks="geometricError",Ns=1;function Cs(e){return null!=e}const Ls=new Jr,Ps=new Jr,Us=new Jr;function Ds(e,t,r){if(be(e,"3D Tile: boundingVolume must be defined"),e.box)return function(e,t,r){const n=new Jr(e[0],e[1],e[2]);t.transform(n,n);let i=[];if(10===e.length){const t=e.slice(3,6),r=new Fn;r.fromArray(e,6);const n=new Jr([1,0,0]),s=new Jr([0,1,0]),o=new Jr([0,0,1]);n.transformByQuaternion(r),n.scale(t[0]),s.transformByQuaternion(r),s.scale(t[1]),o.transformByQuaternion(r),o.scale(t[2]),i=[...n.toArray(),...s.toArray(),...o.toArray()]}else i=[...e.slice(3,6),...e.slice(6,9),...e.slice(9,12)];const s=t.transformAsVector(i.slice(0,3)),o=t.transformAsVector(i.slice(3,6)),a=t.transformAsVector(i.slice(6,9)),c=new un([s[0],s[1],s[2],o[0],o[1],o[2],a[0],a[1],a[2]]);if(Cs(r))return r.center=n,r.halfAxes=c,r;return new zi(n,c)}(e.box,t,r);if(e.region){const[t,r,n,i,s,o]=e.region,a=di.WGS84.cartographicToCartesian([vr(t),vr(i),s],Ps),c=di.WGS84.cartographicToCartesian([vr(n),vr(r),o],Us),u=(new Jr).addVectors(a,c).multiplyScalar(.5),l=(new Jr).subVectors(a,c).len()/2;return js([u[0],u[1],u[2],l],new Tn)}if(e.sphere)return js(e.sphere,t,r);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function js(e,t,r){const n=new Jr(e[0],e[1],e[2]);t.transform(n,n);const i=t.getScale(Ls),s=Math.max(Math.max(i[0],i[1]),i[2]),o=e[3]*s;return Cs(r)?(r.center=n,r.radius=o,r):new xi(n,o)}function Bs(e,t){if(e.dynamicScreenSpaceError&&e.dynamicScreenSpaceErrorComputedDensity){const r=e.dynamicScreenSpaceErrorComputedDensity,n=e.dynamicScreenSpaceErrorFactor;return function(e,t){const r=e*t;return 1-Math.exp(-r*r)}(t,r)*n}return 0}new Tn,new Jr,new Jr,new Tn,new Jr,new Jr,new Jr;const Fs=Math.PI/2;function Vs([e,t,r]){const n=yr(e),i=yr(t),s=1+r/6378137,o=s*Math.cos(i);return[e=o*Math.cos(n),t=o*Math.sin(n),r=s*Math.sin(i)]}function qs(e,t){const[r,n,i=0]=e,[s,o,a=0]=t,c=Vs([s,o,a]),u=Vs([r,n,i]),l=u[0]-c[0],h=u[1]-c[1],f=u[2]-c[2];return l*l+h*h+f*f}function zs(e,t){const r=t.viewport,n=e.header.mbs[1],i=[e.header.mbs[0],n,e.header.mbs[2]],s=e.header.mbs[3]/6378137,o=qs(r.unprojectPosition(r.cameraPosition),i)-s*s;if(o<=0)return 170141175e30;let a=function(e,t){const{width:r,height:n,pixelProjectionMatrix:i}=t.viewport,s=Math.tan(Math.atan(Math.sqrt(1/(i[0]*i[0])+1/(i[5]*i[5]))));return Math.sqrt(n*n+r*r)/s}(0,t);return a*=s/Math.sqrt(o)/r.scale,a}class Gs{constructor(e=0){this._array=new Array(e),this._map=new Map,this._length=e}get length(){return this._length}set length(e){this._length=e,e>this._array.length&&(this._array.length=e)}get values(){return this._array}get(e){return be(e<this._array.length),this._array[e]}set(e,t){be(e>=0),e>=this.length&&(this.length=e+1),this._map.has(this._array[e])&&this._map.delete(this._array[e]),this._array[e]=t,this._map.set(t,e)}delete(e){const t=this._map.get(e);t>=0&&(this._array.splice(t,1),this._map.delete(e),this.length--)}peek(){return this._array[this._length-1]}push(e){if(!this._map.has(e)){const t=this.length++;this._array[t]=e,this._map.set(e,t)}}pop(){const e=this._array[--this.length];return this._map.delete(e),e}reserve(e){be(e>=0),e>this._array.length&&(this._array.length=e)}resize(e){be(e>=0),this.length=e}trim(e){null==e&&(e=this.length),this._array.length=e}reset(){this._array=[],this._map=new Map,this._length=0}find(e){return this._map.has(e)}}const Hs={loadSiblings:!1,skipLevelOfDetail:!1,maximumScreenSpaceError:2,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class Ws{constructor(e){Ce(this,"options",void 0),Ce(this,"root",void 0),Ce(this,"requestedTiles",void 0),Ce(this,"selectedTiles",void 0),Ce(this,"emptyTiles",void 0),Ce(this,"_traversalStack",void 0),Ce(this,"_emptyTraversalStack",void 0),Ce(this,"_frameNumber",void 0),this.options={...Hs,...e},this._traversalStack=new Gs,this._emptyTraversalStack=new Gs,this._frameNumber=null,this.root=null,this.selectedTiles={},this.requestedTiles={},this.emptyTiles={}}traverse(e,t,r){this.root=e,this.options={...this.options,...r},this.reset(),this.updateTile(e,t),this._frameNumber=t.frameNumber,this.executeTraversal(e,t)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(e,t){const r=this._traversalStack;for(e._selectionDepth=1,r.push(e);r.length>0;){const e=r.pop();let n=!1;this.canTraverse(e,t)&&(this.updateChildTiles(e,t),n=this.updateAndPushChildren(e,t,r,e.hasRenderContent?e._selectionDepth+1:e._selectionDepth));const i=e.parent,s=Boolean(!i||i._shouldRefine),o=!n;e.hasRenderContent?e.refine===xs?(this.loadTile(e,t),this.selectTile(e,t)):e.refine===Ss&&(this.loadTile(e,t),o&&this.selectTile(e,t)):(this.emptyTiles[e.id]=e,this.loadTile(e,t),o&&this.selectTile(e,t)),this.touchTile(e,t),e._shouldRefine=n&&s}this.options.onTraversalEnd(t)}updateChildTiles(e,t){const r=e.children;for(const e of r)this.updateTile(e,t);return!0}updateAndPushChildren(e,t,r,n){const{loadSiblings:i,skipLevelOfDetail:s}=this.options,o=e.children;o.sort(this.compareDistanceToCamera.bind(this));const a=e.refine===Ss&&e.hasRenderContent&&!s;let c=!1,u=!0;for(const e of o)if(e._selectionDepth=n,e.isVisibleAndInRequestVolume?(r.find(e)&&r.delete(e),r.push(e),c=!0):(a||i)&&(this.loadTile(e,t),this.touchTile(e,t)),a){let r;if(r=!!e._inRequestVolume&&(e.hasRenderContent?e.contentAvailable:this.executeEmptyTraversal(e,t)),u=u&&r,!u)return!1}return c||(u=!1),u}updateTile(e,t){this.updateTileVisibility(e,t)}selectTile(e,t){this.shouldSelectTile(e)&&(e._selectedFrame=t.frameNumber,this.selectedTiles[e.id]=e)}loadTile(e,t){this.shouldLoadTile(e)&&(e._requestedFrame=t.frameNumber,e._priority=e._getPriority(),this.requestedTiles[e.id]=e)}touchTile(e,t){e.tileset._cache.touch(e),e._touchedFrame=t.frameNumber}canTraverse(e,t,r=!1,n=!1){return!!e.hasChildren&&(e.hasTilesetContent?!e.contentExpired:!(!n&&!e.isVisibleAndInRequestVolume)&&this.shouldRefine(e,t,r))}shouldLoadTile(e){return e.hasUnloadedContent||e.contentExpired}shouldSelectTile(e){return e.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(e,t,r){let n=e._screenSpaceError;return r&&(n=e.getScreenSpaceError(t,!0)),n>this.options.maximumScreenSpaceError}updateTileVisibility(e,t){const r=[];if(this.options.viewportTraversersMap)for(const e in this.options.viewportTraversersMap){this.options.viewportTraversersMap[e]===t.viewport.id&&r.push(e)}else r.push(t.viewport.id);e.updateVisibility(t,r)}compareDistanceToCamera(e,t){return e._distanceToCamera-t._distanceToCamera}anyChildrenVisible(e,t){let r=!1;for(const n of e.children)n.updateVisibility(t),r=r||n.isVisibleAndInRequestVolume;return r}executeEmptyTraversal(e,t){let r=!0;const n=this._emptyTraversalStack;for(n.push(e);n.length>0&&r;){const e=n.pop();this.updateTile(e,t),e.isVisibleAndInRequestVolume||this.loadTile(e,t),this.touchTile(e,t);if(!e.hasRenderContent&&this.canTraverse(e,t,!1,!0)){const t=e.children;for(const e of t)n.find(e)&&n.delete(e),n.push(e)}else e.contentAvailable||(r=!1)}return r}}const Ks=new Jr;class Qs{constructor(e,t,r,n=""){Ce(this,"tileset",void 0),Ce(this,"header",void 0),Ce(this,"id",void 0),Ce(this,"url",void 0),Ce(this,"parent",void 0),Ce(this,"refine",void 0),Ce(this,"type",void 0),Ce(this,"contentUrl",void 0),Ce(this,"lodMetricType",void 0),Ce(this,"lodMetricValue",void 0),Ce(this,"boundingVolume",void 0),Ce(this,"content",void 0),Ce(this,"contentState",void 0),Ce(this,"gpuMemoryUsageInBytes",void 0),Ce(this,"children",void 0),Ce(this,"depth",void 0),Ce(this,"viewportIds",void 0),Ce(this,"transform",void 0),Ce(this,"userData",void 0),Ce(this,"computedTransform",void 0),Ce(this,"hasEmptyContent",void 0),Ce(this,"hasTilesetContent",void 0),Ce(this,"traverser",void 0),Ce(this,"_cacheNode",void 0),Ce(this,"_frameNumber",void 0),Ce(this,"_lodJudge",void 0),Ce(this,"_expireDate",void 0),Ce(this,"_expiredContent",void 0),Ce(this,"_shouldRefine",void 0),Ce(this,"_distanceToCamera",void 0),Ce(this,"_centerZDepth",void 0),Ce(this,"_screenSpaceError",void 0),Ce(this,"_visibilityPlaneMask",void 0),Ce(this,"_visible",void 0),Ce(this,"_inRequestVolume",void 0),Ce(this,"_stackLength",void 0),Ce(this,"_selectionDepth",void 0),Ce(this,"_touchedFrame",void 0),Ce(this,"_visitedFrame",void 0),Ce(this,"_selectedFrame",void 0),Ce(this,"_requestedFrame",void 0),Ce(this,"_priority",void 0),Ce(this,"_contentBoundingVolume",void 0),Ce(this,"_viewerRequestVolume",void 0),Ce(this,"_initialTransform",void 0),this.header=t,this.tileset=e,this.id=n||t.id,this.url=t.url,this.parent=r,this.refine=this._getRefine(t.refine),this.type=t.type,this.contentUrl=t.contentUrl,this.lodMetricType="geometricError",this.lodMetricValue=0,this.boundingVolume=null,this.content=null,this.contentState=vs,this.gpuMemoryUsageInBytes=0,this.children=[],this.hasEmptyContent=!1,this.hasTilesetContent=!1,this.depth=0,this.viewportIds=[],this.userData={},this._priority=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._screenSpaceError=0,this._cacheNode=null,this._frameNumber=null,this._cacheNode=null,this.traverser=new Ws({}),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._initialTransform=new Tn,this.transform=new Tn,this._initializeLodMetric(t),this._initializeTransforms(t),this._initializeBoundingVolumes(t),this._initializeContent(t),this._initializeRenderingState(t),this._lodJudge=null,this._expireDate=null,this._expiredContent=null,Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===bs||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===vs}get contentExpired(){return this.contentState===Ts}get contentFailed(){return this.contentState===_s}getScreenSpaceError(e,t){switch(this.tileset.type){case Os:return zs(this,e);case Is:return function(e,t,r){const n=e.tileset,i=e.parent&&e.parent.lodMetricValue||e.lodMetricValue,s=r?i:e.lodMetricValue;if(0===s)return 0;const o=Math.max(e._distanceToCamera,1e-7),{height:a,sseDenominator:c}=t,{viewDistanceScale:u}=n.options;let l=s*a*(u||1)/(o*c);return l-=Bs(n,o),l}(this,e,t);default:throw new Error("Unsupported tileset type")}}_getPriority(){const e=this.tileset._traverser,{skipLevelOfDetail:t}=e.options,r=this.refine===xs||t;if(r&&!this.isVisible&&void 0!==this._visible)return-1;if(this.contentState===vs)return-1;const n=this.parent,i=n&&(!r||0===this._screenSpaceError||n.hasTilesetContent)?n._screenSpaceError:this._screenSpaceError,s=e.root?e.root._screenSpaceError:0;return Math.max(s-i,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=ws;const e=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!e)return this.contentState=vs,!1;try{const t=this.tileset.getTileUrl(this.contentUrl),r=this.tileset.loader,n={...this.tileset.loadOptions,[r.id]:{...this.tileset.loadOptions[r.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(r.id)}};return this.content=await er(t,r,n),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=bs,this._onContentLoaded(),!0}catch(e){throw this.contentState=_s,e}finally{e.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=vs,!0}updateVisibility(e,t){if(this._frameNumber===e.frameNumber)return;const r=this.parent,n=r?r._visibilityPlaneMask:Ji.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const e=r?r.computedTransform:this.tileset.modelMatrix;this._updateTransform(e)}this._distanceToCamera=this.distanceToTile(e),this._screenSpaceError=this.getScreenSpaceError(e,!1),this._visibilityPlaneMask=this.visibility(e,n),this._visible=this._visibilityPlaneMask!==Ji.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(e),this._frameNumber=e.frameNumber,this.viewportIds=t}visibility(e,t){const{cullingVolume:r}=e,{boundingVolume:n}=this;return r.computeVisibilityWithPlaneMask(n,t)}contentVisibility(){return!0}distanceToTile(e){const t=this.boundingVolume;return Math.sqrt(Math.max(t.distanceSquaredTo(e.camera.position),0))}cameraSpaceZDepth({camera:e}){const t=this.boundingVolume;return Ks.subVectors(t.center,e.position),e.direction.dot(Ks)}insideViewerRequestVolume(e){const t=this._viewerRequestVolume;return!t||t.distanceSquaredTo(e.camera.position)<=0}updateExpiration(){if(null!=this._expireDate&&this.contentReady&&!this.hasEmptyContent){const e=Date.now();Date.lessThan(this._expireDate,e)&&(this.contentState=Ts,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(e){"lodMetricType"in e?this.lodMetricType=e.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in e?this.lodMetricValue=e.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(e){this.transform=e.transform?new Tn(e.transform):new Tn;const t=this.parent,r=this.tileset,n=t&&t.computedTransform?t.computedTransform.clone():r.modelMatrix.clone();this.computedTransform=new Tn(n).multiplyRight(this.transform);const i=t&&t._initialTransform?t._initialTransform.clone():new Tn;this._initialTransform=new Tn(i).multiplyRight(this.transform)}_initializeBoundingVolumes(e){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(e)}_initializeContent(e){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=vs,this.hasTilesetContent=!1,e.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(e){this.depth=e.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=Ji.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(e){return e||this.parent&&this.parent.refine||Ss}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()&&(this.hasTilesetContent=!0)}_updateBoundingVolume(e){this.boundingVolume=Ds(e.boundingVolume,this.computedTransform,this.boundingVolume);const t=e.content;t&&(t.boundingVolume&&(this._contentBoundingVolume=Ds(t.boundingVolume,this.computedTransform,this._contentBoundingVolume)),e.viewerRequestVolume&&(this._viewerRequestVolume=Ds(e.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(e=new Tn){const t=e.clone().multiplyRight(this.transform);!t.equals(this.computedTransform)&&(this.computedTransform=t,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(e){switch(e){case"i3s":return{...this.tileset.options.i3s,tile:this.header,tileset:this.tileset.tileset,isTileHeader:!1};case"3d-tiles":case"cesium-ion":default:return{assetGltfUpAxis:(t=this.tileset.tileset).asset&&t.asset.gltfUpAxis||"Y"}}var t}}class Xs extends Ws{compareDistanceToCamera(e,t){return 0===t._distanceToCamera&&0===e._distanceToCamera?t._centerZDepth-e._centerZDepth:t._distanceToCamera-e._distanceToCamera}updateTileVisibility(e,t){if(super.updateTileVisibility(e,t),!e.isVisibleAndInRequestVolume)return;const r=e.children.length>0;if(e.hasTilesetContent&&r){const r=e.children[0];return this.updateTileVisibility(r,t),void(e._visible=r._visible)}if(this.meetsScreenSpaceErrorEarly(e,t))return void(e._visible=!1);const n=e.refine===Ss,i=e._optimChildrenWithinParent===Ns;n&&i&&r&&!this.anyChildrenVisible(e,t)&&(e._visible=!1)}meetsScreenSpaceErrorEarly(e,t){const{parent:r}=e;return!(!r||r.hasTilesetContent||r.refine!==xs)&&!this.shouldRefine(e,t,!0)}}const Ys="REQUESTED",Zs="COMPLETED",Js="ERROR";class $s{constructor(){Ce(this,"_statusMap",void 0),this._statusMap={}}add(e,t,r,n){this._statusMap[t]||(this._statusMap[t]={request:e,callback:r,key:t,frameState:n,status:Ys},e().then((e=>{this._statusMap[t].status=Zs,this._statusMap[t].callback(e,n)})).catch((e=>{this._statusMap[t].status=Js,r(e)})))}update(e,t){this._statusMap[e]&&(this._statusMap[e].frameState=t)}find(e){return this._statusMap[e]}}class eo extends Ws{constructor(e){super(e),Ce(this,"_tileManager",void 0),this._tileManager=new $s}shouldRefine(e,t){return e._lodJudge=function(e,t){const r=t.viewport,n=r.metersPerPixel,i=e.header.mbs[1],s=e.header.mbs[0],o=e.header.mbs[2],a=e.header.mbs[3],{height:c,width:u,latitude:l,longitude:h}=r,f=[h,l],d=[s,i,o],p=[h,i],m=[s,l],y=Math.sqrt(c*c+u*u)*n[0],g=.5*c+a/6378137,v=.5*u+a/6378137;if(qs(f,d)>y+a/6378137)return"OUT";if(qs(f,p)>g)return"OUT";if(qs(f,m)>v)return"OUT";if(0===e.lodMetricValue)return"DIG";let w=zs(e,t);return w*=Fs,w<.5?"OUT":!e.header.children||w<=e.lodMetricValue?"DRAW":e.header.children?"DIG":"OUT"}(e,t),"DIG"===e._lodJudge}updateChildTiles(e,t){const r=e.header.children||[],n=e.children,i=e.tileset;for(const s of r){const r="".concat(s.id,"-").concat(t.viewport.id),o=n&&n.find((e=>e.id===r));if(o)o&&this.updateTile(o,t);else{let n=()=>this._loadTile(s.id,i);this._tileManager.find(r)?this._tileManager.update(r,t):(i.tileset.nodePages&&(n=()=>i.tileset.nodePagesTile.formTileFromNodePages(s.id)),this._tileManager.add(n,r,(t=>this._onTileLoad(t,e,r)),t))}}return!1}async _loadTile(e,t){const{loader:r}=t,n=t.getTileUrl("".concat(t.url,"/nodes/").concat(e)),i={...t.loadOptions,i3s:{...t.loadOptions.i3s,isTileHeader:!0,loadContent:!1}};return await er(n,r,i)}_onTileLoad(e,t,r){const n=new Qs(t.tileset,e,t,r);t.children.push(n);const i=this._tileManager.find(n.id).frameState;this.updateTile(n,i),this._frameNumber===i.frameNumber&&this.executeTraversal(n,i)}}const to={description:"",ellipsoid:di.WGS84,modelMatrix:new Tn,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}};class ro{constructor(e,t){Ce(this,"options",void 0),Ce(this,"loadOptions",void 0),Ce(this,"type",void 0),Ce(this,"tileset",void 0),Ce(this,"loader",void 0),Ce(this,"url",void 0),Ce(this,"basePath",void 0),Ce(this,"modelMatrix",void 0),Ce(this,"ellipsoid",void 0),Ce(this,"lodMetricType",void 0),Ce(this,"lodMetricValue",void 0),Ce(this,"refine",void 0),Ce(this,"root",void 0),Ce(this,"roots",void 0),Ce(this,"asset",void 0),Ce(this,"description",void 0),Ce(this,"properties",void 0),Ce(this,"extras",void 0),Ce(this,"attributions",void 0),Ce(this,"credits",void 0),Ce(this,"stats",void 0),Ce(this,"traverseCounter",void 0),Ce(this,"geometricError",void 0),Ce(this,"selectedTiles",void 0),Ce(this,"cartographicCenter",void 0),Ce(this,"cartesianCenter",void 0),Ce(this,"zoom",void 0),Ce(this,"boundingVolume",void 0),Ce(this,"gpuMemoryUsageInBytes",void 0),Ce(this,"dynamicScreenSpaceErrorComputedDensity",void 0),Ce(this,"_traverser",void 0),Ce(this,"_cache",void 0),Ce(this,"_requestScheduler",void 0),Ce(this,"_frameNumber",void 0),Ce(this,"_queryParamsString",void 0),Ce(this,"_queryParams",void 0),Ce(this,"_extensionsUsed",void 0),Ce(this,"_tiles",void 0),Ce(this,"_pendingCount",void 0),Ce(this,"lastUpdatedVieports",void 0),Ce(this,"_requestedTiles",void 0),Ce(this,"_emptyTiles",void 0),Ce(this,"frameStateData",void 0),Ce(this,"maximumMemoryUsage",void 0),be(e),this.options={...to,...t},this.tileset=e,this.loader=e.loader,this.type=e.type,this.url=e.url,this.basePath=e.basePath||tt(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=e.lodMetricType,this.lodMetricValue=e.lodMetricValue,this.refine=e.root.refine,this.loadOptions=this.options.loadOptions||{},this.root=null,this.roots={},this.cartographicCenter=null,this.cartesianCenter=null,this.zoom=1,this.boundingVolume=null,this.traverseCounter=0,this.geometricError=0,this._traverser=this._initializeTraverser(),this._cache=new gi,this._requestScheduler=new ht({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this._frameNumber=0,this._pendingCount=0,this._tiles={},this.selectedTiles=[],this._emptyTiles=[],this._requestedTiles=[],this.frameStateData={},this.lastUpdatedVieports=null,this._queryParams={},this._queryParamsString="",this.maximumMemoryUsage=this.options.maximumMemoryUsage||32,this.gpuMemoryUsageInBytes=0,this.stats=new ut({id:this.url}),this._initializeStats(),this._extensionsUsed=void 0,this.dynamicScreenSpaceErrorComputedDensity=0,this.extras=null,this.asset={},this.credits={},this.description=this.options.description||"",this._initializeTileSet(e)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return this._queryParamsString||(this._queryParamsString=function(e){const t=[];for(const r of Object.keys(e))t.push("".concat(r,"=").concat(e[r]));switch(t.length){case 0:return"";case 1:return"?".concat(t[0]);default:return"?".concat(t.join("&"))}}(this._queryParams)),this._queryParamsString}setProps(e){this.options={...this.options,...e}}setOptions(e){this.options={...this.options,...e}}getTileUrl(e){return e.startsWith("data:")?e:"".concat(e).concat(this.queryParams)}hasExtension(e){return Boolean(this._extensionsUsed&&this._extensionsUsed.indexOf(e)>-1)}update(e){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;!e&&this.lastUpdatedVieports?e=this.lastUpdatedVieports:this.lastUpdatedVieports=e,e instanceof Array||(e=[e]),this._cache.reset(),this._frameNumber++,this.traverseCounter=e.length;const t=[];for(const r of e){const e=r.id;this._needTraverse(e)?t.push(e):this.traverseCounter--}for(const r of e){const e=r.id;if(this.roots[e]||(this.roots[e]=this._initializeTileHeaders(this.tileset,null)),!t.includes(e))continue;const n=ms(r,this._frameNumber);this._traverser.traverse(this.roots[e],n,this.options)}}_needTraverse(e){let t=e;return this.options.viewportTraversersMap&&(t=this.options.viewportTraversersMap[e]),t===e}_onTraversalEnd(e){const t=e.viewport.id;this.frameStateData[t]||(this.frameStateData[t]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const r=this.frameStateData[t],n=Object.values(this._traverser.selectedTiles);r.selectedTiles=n,r._requestedTiles=Object.values(this._traverser.requestedTiles),r._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const e in this.frameStateData){const t=this.frameStateData[e];this.selectedTiles=this.selectedTiles.concat(t.selectedTiles),this._requestedTiles=this._requestedTiles.concat(t._requestedTiles),this._emptyTiles=this._emptyTiles.concat(t._emptyTiles)}for(const e of this.selectedTiles)this._tiles[e.id]=e;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(e,t){if(e.length!==t.length)return!0;const r=new Set(e.map((e=>e.id))),n=new Set(t.map((e=>e.id)));let i=e.filter((e=>!n.has(e.id))).length>0;return i=i||t.filter((e=>!r.has(e.id))).length>0,i}_loadTiles(){for(const e of this._requestedTiles)e.contentUnloaded&&this._loadTile(e)}_unloadTiles(){this._cache.unloadTiles(this,((e,t)=>e._unloadTile(t)))}_updateStats(){let e=0,t=0;for(const r of this.selectedTiles)r.contentAvailable&&r.content&&(e++,r.content.pointCount&&(t+=r.content.pointCount));this.stats.get("Tiles In View").count=this.selectedTiles.length,this.stats.get("Tiles To Render").count=e,this.stats.get("Points").count=t}_initializeTileSet(e){this.root=this._initializeTileHeaders(e,null),this.type===Is&&this._initializeCesiumTileset(e),this.type===Os&&this._initializeI3STileset(),this._calculateViewProps()}_calculateViewProps(){const e=this.root;be(e);const{center:t}=e.boundingVolume;if(!t)return console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new Jr,void(this.zoom=1);this.cartographicCenter=di.WGS84.cartesianToCartographic(t,new Jr),this.cartesianCenter=t,this.zoom=gs(e.boundingVolume)}_initializeStats(){this.stats.get("Tiles In Tileset(s)"),this.stats.get("Tiles Loading"),this.stats.get("Tiles In Memory"),this.stats.get("Tiles In View"),this.stats.get("Tiles To Render"),this.stats.get("Tiles Loaded"),this.stats.get("Tiles Unloaded"),this.stats.get("Failed Tile Loads"),this.stats.get("Points","memory"),this.stats.get("Tile Memory Use","memory")}_initializeTileHeaders(e,t){const r=new Qs(this,e.root,t);if(t&&(t.children.push(r),r.depth=t.depth+1),this.type===Is){const e=[];for(e.push(r);e.length>0;){const t=e.pop();this.stats.get("Tiles In Tileset(s)").incrementCount();const r=t.header.children||[];for(const n of r){const r=new Qs(this,n,t);t.children.push(r),r.depth=t.depth+1,e.push(r)}}}return r}_initializeTraverser(){let e;switch(this.type){case Is:e=Xs;break;case Os:e=eo;break;default:e=Ws}return new e({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(e){this._destroySubtree(e)}async _loadTile(e){let t;try{this._onStartTileLoading(),t=await e.loadContent()}catch(t){this._onTileLoadError(e,t)}finally{this._onEndTileLoading(),this._onTileLoad(e,t)}}_onTileLoadError(e,t){this.stats.get("Failed Tile Loads").incrementCount();const r=t.message||t.toString(),n=e.url;console.error("A 3D tile failed to load: ".concat(e.url," ").concat(r)),this.options.onTileError(e,r,n)}_onTileLoad(e,t){t&&(e&&e.content&&function(e,t){be(e),be(t);const{rtcCenter:r,gltfUpAxis:n}=t,{computedTransform:i,boundingVolume:{center:s}}=e;let o=new Tn(i);switch(r&&o.translate(r),n){case"Z":break;case"Y":const e=(new Tn).rotateX(Math.PI/2);o=o.multiplyRight(e);break;case"X":const t=(new Tn).rotateY(-Math.PI/2);o=o.multiplyRight(t)}t.isQuantized&&o.translate(t.quantizedVolumeOffset).scale(t.quantizedVolumeScale);const a=new Jr(s);t.cartesianModelMatrix=o,t.cartesianOrigin=a;const c=di.WGS84.cartesianToCartographic(a,new Jr),u=di.WGS84.eastNorthUpToFixedFrame(a).invert();t.cartographicModelMatrix=u.multiplyRight(o),t.cartographicOrigin=c,t.modelMatrix=t.cartographicModelMatrix}(e,e.content),this._addTileToCache(e),this.options.onTileLoad(e))}_onStartTileLoading(){this._pendingCount++,this.stats.get("Tiles Loading").incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get("Tiles Loading").decrementCount()}_addTileToCache(e){this._cache.add(this,e,(t=>t._updateCacheStats(e)))}_updateCacheStats(e){this.stats.get("Tiles Loaded").incrementCount(),this.stats.get("Tiles In Memory").incrementCount(),this.gpuMemoryUsageInBytes+=e.content.byteLength||0,this.stats.get("Tile Memory Use").count=this.gpuMemoryUsageInBytes}_unloadTile(e){this.gpuMemoryUsageInBytes-=e.content&&e.content.byteLength||0,this.stats.get("Tiles In Memory").decrementCount(),this.stats.get("Tiles Unloaded").incrementCount(),this.stats.get("Tile Memory Use").count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(e),e.unloadContent()}_destroy(){const e=[];for(this.root&&e.push(this.root);e.length>0;){const t=e.pop();for(const r of t.children)e.push(r);this._destroyTile(t)}this.root=null}_destroySubtree(e){const t=e,r=[];for(r.push(t);r.length>0;){e=r.pop();for(const t of e.children)r.push(t);e!==t&&this._destroyTile(e)}t.children=[]}_destroyTile(e){this._cache.unloadTile(this,e),this._unloadTile(e),e.destroy()}_initializeCesiumTileset(e){if(this.asset=e.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version 0.0 or 1.0.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=e.properties,this.geometricError=e.geometricError,this._extensionsUsed=e.extensionsUsed,this.extras=e.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const no="cmpt",io="pnts",so="b3dm",oo="i3dm";function ao(e,t,r){be(e instanceof ArrayBuffer);const n=new TextDecoder("utf8"),i=new Uint8Array(e,t,r);return n.decode(i)}class co{constructor(e,t){Ce(this,"fields",void 0),Ce(this,"metadata",void 0),function(e,t){if(!e)throw new Error(t||"loader assertion failed.")}(Array.isArray(e)),function(e){const t={};for(const r of e)t[r.name]&&console.warn("Schema: duplicated field name",r.name,r),t[r.name]=!0}(e),this.fields=e,this.metadata=t||new Map}compareTo(e){if(this.metadata!==e.metadata)return!1;if(this.fields.length!==e.fields.length)return!1;for(let t=0;t<this.fields.length;++t)if(!this.fields[t].compareTo(e.fields[t]))return!1;return!0}select(...e){const t=Object.create(null);for(const r of e)t[r]=!0;const r=this.fields.filter((e=>t[e.name]));return new co(r,this.metadata)}selectAt(...e){const t=e.map((e=>this.fields[e])).filter(Boolean);return new co(t,this.metadata)}assign(e){let t,r=this.metadata;if(e instanceof co){const n=e;t=n.fields,r=uo(uo(new Map,this.metadata),n.metadata)}else t=e;const n=Object.create(null);for(const e of this.fields)n[e.name]=e;for(const e of t)n[e.name]=e;const i=Object.values(n);return new co(i,r)}}function uo(e,t){return new Map([...e||new Map,...t||new Map])}class lo{constructor(e,t,r=!1,n=new Map){Ce(this,"name",void 0),Ce(this,"type",void 0),Ce(this,"nullable",void 0),Ce(this,"metadata",void 0),this.name=e,this.type=t,this.nullable=r,this.metadata=n}get typeId(){return this.type&&this.type.typeId}clone(){return new lo(this.name,this.type,this.nullable,this.metadata)}compareTo(e){return this.name===e.name&&this.type===e.type&&this.nullable===e.nullable&&this.metadata===e.metadata}toString(){return"".concat(this.type).concat(this.nullable?", nullable":"").concat(this.metadata?", metadata: ".concat(this.metadata):"")}}let ho,fo,po,mo;!function(e){e[e.NONE=0]="NONE",e[e.Null=1]="Null",e[e.Int=2]="Int",e[e.Float=3]="Float",e[e.Binary=4]="Binary",e[e.Utf8=5]="Utf8",e[e.Bool=6]="Bool",e[e.Decimal=7]="Decimal",e[e.Date=8]="Date",e[e.Time=9]="Time",e[e.Timestamp=10]="Timestamp",e[e.Interval=11]="Interval",e[e.List=12]="List",e[e.Struct=13]="Struct",e[e.Union=14]="Union",e[e.FixedSizeBinary=15]="FixedSizeBinary",e[e.FixedSizeList=16]="FixedSizeList",e[e.Map=17]="Map",e[e.Dictionary=-1]="Dictionary",e[e.Int8=-2]="Int8",e[e.Int16=-3]="Int16",e[e.Int32=-4]="Int32",e[e.Int64=-5]="Int64",e[e.Uint8=-6]="Uint8",e[e.Uint16=-7]="Uint16",e[e.Uint32=-8]="Uint32",e[e.Uint64=-9]="Uint64",e[e.Float16=-10]="Float16",e[e.Float32=-11]="Float32",e[e.Float64=-12]="Float64",e[e.DateDay=-13]="DateDay",e[e.DateMillisecond=-14]="DateMillisecond",e[e.TimestampSecond=-15]="TimestampSecond",e[e.TimestampMillisecond=-16]="TimestampMillisecond",e[e.TimestampMicrosecond=-17]="TimestampMicrosecond",e[e.TimestampNanosecond=-18]="TimestampNanosecond",e[e.TimeSecond=-19]="TimeSecond",e[e.TimeMillisecond=-20]="TimeMillisecond",e[e.TimeMicrosecond=-21]="TimeMicrosecond",e[e.TimeNanosecond=-22]="TimeNanosecond",e[e.DenseUnion=-23]="DenseUnion",e[e.SparseUnion=-24]="SparseUnion",e[e.IntervalDayTime=-25]="IntervalDayTime",e[e.IntervalYearMonth=-26]="IntervalYearMonth"}(ho||(ho={}));class yo{static isNull(e){return e&&e.typeId===ho.Null}static isInt(e){return e&&e.typeId===ho.Int}static isFloat(e){return e&&e.typeId===ho.Float}static isBinary(e){return e&&e.typeId===ho.Binary}static isUtf8(e){return e&&e.typeId===ho.Utf8}static isBool(e){return e&&e.typeId===ho.Bool}static isDecimal(e){return e&&e.typeId===ho.Decimal}static isDate(e){return e&&e.typeId===ho.Date}static isTime(e){return e&&e.typeId===ho.Time}static isTimestamp(e){return e&&e.typeId===ho.Timestamp}static isInterval(e){return e&&e.typeId===ho.Interval}static isList(e){return e&&e.typeId===ho.List}static isStruct(e){return e&&e.typeId===ho.Struct}static isUnion(e){return e&&e.typeId===ho.Union}static isFixedSizeBinary(e){return e&&e.typeId===ho.FixedSizeBinary}static isFixedSizeList(e){return e&&e.typeId===ho.FixedSizeList}static isMap(e){return e&&e.typeId===ho.Map}static isDictionary(e){return e&&e.typeId===ho.Dictionary}get typeId(){return ho.NONE}compareTo(e){return this===e}}fo=Symbol.toStringTag;class go extends yo{constructor(e,t){super(),Ce(this,"isSigned",void 0),Ce(this,"bitWidth",void 0),this.isSigned=e,this.bitWidth=t}get typeId(){return ho.Int}get[fo](){return"Int"}toString(){return"".concat(this.isSigned?"I":"Ui","nt").concat(this.bitWidth)}}class vo extends go{constructor(){super(!0,8)}}class wo extends go{constructor(){super(!0,16)}}class bo extends go{constructor(){super(!0,32)}}class To extends go{constructor(){super(!1,8)}}class _o extends go{constructor(){super(!1,16)}}class xo extends go{constructor(){super(!1,32)}}const So=32,Eo=64;po=Symbol.toStringTag;class Ao extends yo{constructor(e){super(),Ce(this,"precision",void 0),this.precision=e}get typeId(){return ho.Float}get[po](){return"Float"}toString(){return"Float".concat(this.precision)}}class Mo extends Ao{constructor(){super(So)}}class Ro extends Ao{constructor(){super(Eo)}}mo=Symbol.toStringTag;class Oo extends yo{constructor(e,t){super(),Ce(this,"listSize",void 0),Ce(this,"children",void 0),this.listSize=e,this.children=[t]}get typeId(){return ho.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[mo](){return"FixedSizeList"}toString(){return"FixedSizeList[".concat(this.listSize,"]<").concat(this.valueType,">")}}function Io(e,t,r){const n=r?ko(r.metadata):void 0,i=function(e){switch(e.constructor){case Int8Array:return new vo;case Uint8Array:return new To;case Int16Array:return new wo;case Uint16Array:return new _o;case Int32Array:return new bo;case Uint32Array:return new xo;case Float32Array:return new Mo;case Float64Array:return new Ro;default:throw new Error("array type not supported")}}(t.value);return new lo(e,new Oo(t.size,new lo("value",i)),!1,n)}function ko(e){const t=new Map;for(const r in e)t.set("".concat(r,".string"),JSON.stringify(e[r]));return t}const No={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},Co={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class Lo{constructor(e){Ce(this,"draco",void 0),Ce(this,"decoder",void 0),Ce(this,"metadataQuerier",void 0),this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,t={}){const r=new this.draco.DecoderBuffer;r.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const n=this.decoder.GetEncodedGeometryType(r),i=n===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let e;switch(n){case this.draco.TRIANGULAR_MESH:e=this.decoder.DecodeBufferToMesh(r,i);break;case this.draco.POINT_CLOUD:e=this.decoder.DecodeBufferToPointCloud(r,i);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!e.ok()||!i.ptr){const t="DRACO decompression failed: ".concat(e.error_msg());throw new Error(t)}const s=this._getDracoLoaderData(i,n,t),o=this._getMeshData(i,s,t),a=function(e){let t=1/0,r=1/0,n=1/0,i=-1/0,s=-1/0,o=-1/0;const a=e.POSITION?e.POSITION.value:[],c=a&&a.length;for(let e=0;e<c;e+=3){const c=a[e],u=a[e+1],l=a[e+2];t=c<t?c:t,r=u<r?u:r,n=l<n?l:n,i=c>i?c:i,s=u>s?u:s,o=l>o?l:o}return[[t,r,n],[i,s,o]]}(o.attributes),c=function(e,t,r){const n=ko(t.metadata),i=[],s=function(e){const t={};for(const r in e){const n=e[r];t[n.name||"undefined"]=n}return t}(t.attributes);for(const t in e){const r=Io(t,e[t],s[t]);i.push(r)}if(r){const e=Io("indices",r);i.push(e)}return new co(i,n)}(o.attributes,s,o.indices);return{loader:"draco",loaderData:s,header:{vertexCount:i.num_points(),boundingBox:a},...o,schema:c}}finally{this.draco.destroy(r),i&&this.draco.destroy(i)}}_getDracoLoaderData(e,t,r){const n=this._getTopLevelMetadata(e),i=this._getDracoAttributes(e,r);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:n,attributes:i}}_getDracoAttributes(e,t){const r={};for(let n=0;n<e.num_attributes();n++){const i=this.decoder.GetAttribute(e,n),s=this._getAttributeMetadata(e,n);r[i.unique_id()]={unique_id:i.unique_id(),attribute_type:i.attribute_type(),data_type:i.data_type(),num_components:i.num_components(),byte_offset:i.byte_offset(),byte_stride:i.byte_stride(),normalized:i.normalized(),metadata:s};const o=this._getQuantizationTransform(i,t);o&&(r[i.unique_id()].quantization_transform=o);const a=this._getOctahedronTransform(i,t);a&&(r[i.unique_id()].octahedron_transform=a)}return r}_getMeshData(e,t,r){const n=this._getMeshAttributes(t,e,r);if(!n.POSITION)throw new Error("DRACO: No position attribute found.");if(e instanceof this.draco.Mesh)switch(r.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:n,indices:{value:this._getTriangleStripIndices(e),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:n,indices:{value:this._getTriangleListIndices(e),size:1}}}return{topology:"point-list",mode:0,attributes:n}}_getMeshAttributes(e,t,r){const n={};for(const i of Object.values(e.attributes)){const e=this._deduceAttributeName(i,r);i.name=e;const{value:s,size:o}=this._getAttributeValues(t,i);n[e]={value:s,size:o,byteOffset:i.byte_offset,byteStride:i.byte_stride,normalized:i.normalized}}return n}_getTriangleListIndices(e){const t=3*e.num_faces(),r=4*t,n=this.draco._malloc(r);try{return this.decoder.GetTrianglesUInt32Array(e,r,n),new Uint32Array(this.draco.HEAPF32.buffer,n,t).slice()}finally{this.draco._free(n)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),function(e){const t=e.size(),r=new Int32Array(t);for(let n=0;n<t;n++)r[n]=e.GetValue(n);return r}(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const r=Co[t.data_type],n=t.num_components,i=e.num_points()*n,s=i*r.BYTES_PER_ELEMENT,o=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32;default:return e.DT_INVALID}}(this.draco,r);let a;const c=this.draco._malloc(s);try{const n=this.decoder.GetAttribute(e,t.unique_id);this.decoder.GetAttributeDataArrayForAllPoints(e,n,o,s,c),a=new r(this.draco.HEAPF32.buffer,c,i).slice()}finally{this.draco._free(c)}return{value:a,size:n}}_deduceAttributeName(e,t){const r=e.unique_id;for(const[e,n]of Object.entries(t.extraAttributes||{}))if(n===r)return e;const n=e.attribute_type;for(const e in No){if(this.draco[e]===n)return No[e]}const i=t.attributeNameEntry||"name";return e.metadata[i]?e.metadata[i].string:"CUSTOM_ATTRIBUTE_".concat(r)}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const r=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(r)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},r=this.metadataQuerier.NumEntries(e);for(let n=0;n<r;n++){const r=this.metadataQuerier.GetEntryName(e,n);t[r]=this._getDracoMetadataField(e,r)}return t}_getDracoMetadataField(e,t){const r=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,r);const n=function(e){const t=e.size(),r=new Int32Array(t);for(let n=0;n<t;n++)r[n]=e.GetValue(n);return r}(r);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:n}}finally{this.draco.destroy(r)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:r=[]}=e,n=[...t,...r];for(const e of n)this.decoder.SkipAttributeTransform(this.draco[e])}_getQuantizationTransform(e,t){const{quantizedAttributes:r=[]}=t,n=e.attribute_type();if(r.map((e=>this.decoder[e])).includes(n)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return{quantization_bits:t.quantization_bits(),range:t.range(),min_values:new Float32Array([1,2,3]).map((e=>t.min_value(e)))}}finally{this.draco.destroy(t)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:r=[]}=t,n=e.attribute_type();if(r.map((e=>this.decoder[e])).includes(n)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return{quantization_bits:t.quantization_bits()}}finally{this.draco.destroy(t)}}return null}}const Po="https://www.gstatic.com/draco/versioned/decoders/".concat("1.4.1","/draco_decoder.js"),Uo="https://www.gstatic.com/draco/versioned/decoders/".concat("1.4.1","/draco_wasm_wrapper.js"),Do="https://www.gstatic.com/draco/versioned/decoders/".concat("1.4.1","/draco_decoder.wasm");let jo;async function Bo(e){const t=e.modules||{};return jo=t.draco3d?jo||t.draco3d.createDecoderModule({}).then((e=>({draco:e}))):jo||async function(e){let t,r;switch(e.draco&&e.draco.decoderType){case"js":t=await We(Po,"draco",e);break;case"wasm":default:[t,r]=await Promise.all([await We(Uo,"draco",e),await We(Do,"draco",e)])}return t=t||globalThis.DracoDecoderModule,await function(e,t){const r={};t&&(r.wasmBinary=t);return new Promise((t=>{e({...r,onModuleLoaded:e=>t({draco:e})})}))}(t,r)}(e),await jo}const Fo={...{name:"Draco",id:"draco",module:"draco",version:"3.0.0-beta.5",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:"object"==typeof WebAssembly?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}},parse:async function(e,t){const{draco:r}=await Bo(t),n=new Lo(r);try{return n.parseSync(e,null==t?void 0:t.draco)}finally{n.destroy()}}};const Vo={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},qo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,...Vo},zo={[Vo.DOUBLE]:Float64Array,[Vo.FLOAT]:Float32Array,[Vo.UNSIGNED_SHORT]:Uint16Array,[Vo.UNSIGNED_INT]:Uint32Array,[Vo.UNSIGNED_BYTE]:Uint8Array,[Vo.BYTE]:Int8Array,[Vo.SHORT]:Int16Array,[Vo.INT]:Int32Array},Go={DOUBLE:Vo.DOUBLE,FLOAT:Vo.FLOAT,UNSIGNED_SHORT:Vo.UNSIGNED_SHORT,UNSIGNED_INT:Vo.UNSIGNED_INT,UNSIGNED_BYTE:Vo.UNSIGNED_BYTE,BYTE:Vo.BYTE,SHORT:Vo.SHORT,INT:Vo.INT};class Ho{static fromTypedArray(e){e=ArrayBuffer.isView(e)?e.constructor:e;for(const t in zo){if(zo[t]===e)return t}throw new Error("Failed to convert GL type")}static fromName(e){const t=Go[e];if(!t)throw new Error("Failed to convert GL type");return t}static getArrayType(e,t=!1){switch(e){case Vo.UNSIGNED_SHORT_5_6_5:case Vo.UNSIGNED_SHORT_4_4_4_4:case Vo.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const t=zo[e];if(!t)throw new Error("Failed to convert GL type");return t}}static getByteSize(e){return Ho.getArrayType(e).BYTES_PER_ELEMENT}static validate(e){return Boolean(Ho.getArrayType(e))}static createTypedArray(e,t,r=0,n){void 0===n&&(n=(t.byteLength-r)/Ho.getByteSize(e));return new(Ho.getArrayType(e))(t,r,n)}}function Wo(e,t=[0,0,0]){const r=e>>11&31,n=e>>5&63,i=31&e;return t[0]=r<<3,t[1]=n<<2,t[2]=i<<3,t}function Ko(e,t=255){return function(e,t,r){return mr(e,(function(e){return Math.max(t,Math.min(r,e))}))}(e,0,t)/t*2-1}function Qo(e){return e<0?-1:1}function Xo(e,t,r,n){if(function(e,t){if(!e)throw new Error("math.gl assertion failed. ".concat(t))}(n),e<0||e>r||t<0||t>r)throw new Error("x and y must be unsigned normalized integers between 0 and ".concat(r));if(n.x=Ko(e,r),n.y=Ko(t,r),n.z=1-(Math.abs(n.x)+Math.abs(n.y)),n.z<0){const e=n.x;n.x=(1-Math.abs(n.y))*Qo(e),n.y=(1-Math.abs(e))*Qo(n.y)}return n.normalize()}new Fr,new Jr,new Fr,new Fr;class Yo{constructor(e,t){this.json=e,this.buffer=t,this.featuresLength=0,this._cachedTypedArrays={}}getExtension(e){return this.json.extensions&&this.json.extensions[e]}hasProperty(e){return Boolean(this.json[e])}getGlobalProperty(e,t=qo.UNSIGNED_INT,r=1){const n=this.json[e];return n&&Number.isFinite(n.byteOffset)?this._getTypedArrayFromBinary(e,t,r,1,n.byteOffset):n}getPropertyArray(e,t,r){const n=this.json[e];return n&&Number.isFinite(n.byteOffset)?("componentType"in n&&(t=Ho.fromName(n.componentType)),this._getTypedArrayFromBinary(e,t,r,this.featuresLength,n.byteOffset)):this._getTypedArrayFromArray(e,t,n)}getProperty(e,t,r,n,i){const s=this.json[e];if(!s)return s;const o=this.getPropertyArray(e,t,r);if(1===r)return o[n];for(let e=0;e<r;++e)i[e]=o[r*n+e];return i}_getTypedArrayFromBinary(e,t,r,n,i){const s=this._cachedTypedArrays;let o=s[e];return o||(o=Ho.createTypedArray(t,this.buffer.buffer,this.buffer.byteOffset+i,n*r),s[e]=o),o}_getTypedArrayFromArray(e,t,r){const n=this._cachedTypedArrays;let i=n[e];return i||(i=Ho.createTypedArray(t,r),n[e]=i),i}}const Zo={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Jo={SCALAR:(e,t)=>e[t],VEC2:(e,t)=>[e[2*t+0],e[2*t+1]],VEC3:(e,t)=>[e[3*t+0],e[3*t+1],e[3*t+2]],VEC4:(e,t)=>[e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]],MAT2:(e,t)=>[e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]],MAT3:(e,t)=>[e[9*t+0],e[9*t+1],e[9*t+2],e[9*t+3],e[9*t+4],e[9*t+5],e[9*t+6],e[9*t+7],e[9*t+8]],MAT4:(e,t)=>[e[16*t+0],e[16*t+1],e[16*t+2],e[16*t+3],e[16*t+4],e[16*t+5],e[16*t+6],e[16*t+7],e[16*t+8],e[16*t+9],e[16*t+10],e[16*t+11],e[16*t+12],e[16*t+13],e[16*t+14],e[16*t+15]]},$o={SCALAR:(e,t,r)=>{t[r]=e},VEC2:(e,t,r)=>{t[2*r+0]=e[0],t[2*r+1]=e[1]},VEC3:(e,t,r)=>{t[3*r+0]=e[0],t[3*r+1]=e[1],t[3*r+2]=e[2]},VEC4:(e,t,r)=>{t[4*r+0]=e[0],t[4*r+1]=e[1],t[4*r+2]=e[2],t[4*r+3]=e[3]},MAT2:(e,t,r)=>{t[4*r+0]=e[0],t[4*r+1]=e[1],t[4*r+2]=e[2],t[4*r+3]=e[3]},MAT3:(e,t,r)=>{t[9*r+0]=e[0],t[9*r+1]=e[1],t[9*r+2]=e[2],t[9*r+3]=e[3],t[9*r+4]=e[4],t[9*r+5]=e[5],t[9*r+6]=e[6],t[9*r+7]=e[7],t[9*r+8]=e[8],t[9*r+9]=e[9]},MAT4:(e,t,r)=>{t[16*r+0]=e[0],t[16*r+1]=e[1],t[16*r+2]=e[2],t[16*r+3]=e[3],t[16*r+4]=e[4],t[16*r+5]=e[5],t[16*r+6]=e[6],t[16*r+7]=e[7],t[16*r+8]=e[8],t[16*r+9]=e[9],t[16*r+10]=e[10],t[16*r+11]=e[11],t[16*r+12]=e[12],t[16*r+13]=e[13],t[16*r+14]=e[14],t[16*r+15]=e[15]}};const ea=e=>void 0!==e;function ta(e,t,r){if(!t)return null;let n=e.getExtension("3DTILES_batch_table_hierarchy");const i=t.HIERARCHY;return i&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),t.extensions=t.extensions||{},t.extensions["3DTILES_batch_table_hierarchy"]=i,n=i),n?function(e,t){let r,n,i;const s=e.instancesLength,o=e.classes,a=e.classIds,c=e.parentCounts,u=e.parentIds,l=s;ea(a.byteOffset)&&(a.componentType=defaultValue(a.componentType,GL.UNSIGNED_SHORT),a.type=AttributeType.SCALAR,i=getBinaryAccessor(a),a=i.createArrayBufferView(t.buffer,t.byteOffset+a.byteOffset,s));let h;if(ea(c))for(ea(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,i=getBinaryAccessor(c),c=i.createArrayBufferView(t.buffer,t.byteOffset+c.byteOffset,s)),h=new Uint16Array(s),l=0,r=0;r<s;++r)h[r]=l,l+=c[r];ea(u)&&ea(u.byteOffset)&&(u.componentType=defaultValue(u.componentType,GL.UNSIGNED_SHORT),u.type=AttributeType.SCALAR,i=getBinaryAccessor(u),u=i.createArrayBufferView(t.buffer,t.byteOffset+u.byteOffset,l));const f=o.length;for(r=0;r<f;++r){const e=o[r].length,n=o[r].instances,i=getBinaryProperties(e,n,t);o[r].instances=combine(i,n)}const d=new Array(f).fill(0),p=new Uint16Array(s);for(r=0;r<s;++r)n=a[r],p[r]=d[n],++d[n];const m={classes:o,classIds:a,classIndexes:p,parentCounts:c,parentIndexes:h,parentIds:u};return function(e){const t=e.classIds.length;for(let r=0;r<t;++r)na(e,r,stack)}(m),m}(n,r):null}function ra(e,t,r){if(!e)return;const n=e.parentCounts;return e.parentIds?r(e,t):n>0?function(e,t,r){const n=e.classIds,i=e.parentCounts,s=e.parentIds,o=e.parentIndexes,a=n.length,c=scratchVisited;c.length=Math.max(c.length,a);const u=++marker,l=scratchStack;l.length=0,l.push(t);for(;l.length>0;){if(c[t=l.pop()]===u)continue;c[t]=u;const n=r(e,t);if(ea(n))return n;const a=i[t],h=o[t];for(let e=0;e<a;++e){const r=s[h+e];r!==t&&l.push(r)}}return null}(e,t,r):function(e,t,r){let n=!0;for(;n;){const i=r(e,t);if(ea(i))return i;const s=e.parentIds[t];n=s!==t,t=s}throw new Error("traverseHierarchySingleParent")}(e,t,r)}function na(e,t,r){const n=e.parentCounts,i=e.parentIds,s=e.parentIndexes,o=e.classIds.length;if(!ea(i))return;assert(t<o,"Parent index ".concat(t," exceeds the total number of instances: ").concat(o)),assert(-1===r.indexOf(t),"Circular dependency detected in the batch table hierarchy."),r.push(t);const a=ea(n)?n[t]:1,c=ea(n)?s[t]:t;for(let n=0;n<a;++n){const s=i[c+n];s!==t&&na(e,s,r)}r.pop(t)}function ia(e){return null!=e}const sa=(e,t)=>e,oa={HIERARCHY:!0,extensions:!0,extras:!0};class aa{constructor(e,t,r,n={}){var i;be(r>=0),this.json=e||{},this.binary=t,this.featureCount=r,this._extensions=(null===(i=this.json)||void 0===i?void 0:i.extensions)||{},this._properties={};for(const e in this.json)oa[e]||(this._properties[e]=this.json[e]);this._binaryProperties=this._initializeBinaryProperties(),n["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=ta(this,this.json,this.binary))}getExtension(e){return this.json&&this.json.extensions&&this.json.extensions[e]}memorySizeInBytes(){return 0}isClass(e,t){if(this._checkBatchId(e),be("string"==typeof t,t),this._hierarchy){return ia(ra(this._hierarchy,e,((e,r)=>{const n=e.classIds[r];return e.classes[n].name===t})))}return!1}isExactClass(e,t){return be("string"==typeof t,t),this.getExactClassName(e)===t}getExactClassName(e){if(this._checkBatchId(e),this._hierarchy){const t=this._hierarchy.classIds[e];return this._hierarchy.classes[t].name}}hasProperty(e,t){return this._checkBatchId(e),be("string"==typeof t,t),ia(this._properties[t])||this._hasPropertyInHierarchy(e,t)}getPropertyNames(e,t){this._checkBatchId(e),(t=ia(t)?t:[]).length=0;const r=Object.keys(this._properties);return t.push(...r),this._hierarchy&&this._getPropertyNamesInHierarchy(e,t),t}getProperty(e,t){if(this._checkBatchId(e),be("string"==typeof t,t),this._binaryProperties){const r=this._binaryProperties[t];if(ia(r))return this._getBinaryProperty(r,e)}const r=this._properties[t];if(ia(r))return sa(r[e]);if(this._hierarchy){const r=this._getHierarchyProperty(e,t);if(ia(r))return r}}setProperty(e,t,r){const n=this.featureCount;if(this._checkBatchId(e),be("string"==typeof t,t),this._binaryProperties){const n=this._binaryProperties[t];if(n)return void this._setBinaryProperty(n,e,r)}if(this._hierarchy&&this._setHierarchyProperty(this,e,t,r))return;let i=this._properties[t];ia(i)||(this._properties[t]=new Array(n),i=this._properties[t]),i[e]=sa(r)}_checkBatchId(e){if(!(e>=0&&e<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(e,t){return e.unpack(e.typedArray,t)}_setBinaryProperty(e,t,r){e.pack(r,e.typedArray,t)}_initializeBinaryProperties(){let e=null;for(const t in this._properties){const r=this._properties[t],n=this._initializeBinaryProperty(t,r);n&&(e=e||{},e[t]=n)}return e}_initializeBinaryProperty(e,t){if("byteOffset"in t){const r=t;be(this.binary,"Property ".concat(e," requires a batch table binary.")),be(r.type,"Property ".concat(e," requires a type."));const n=function(e,t,r,n){const{componentType:i}=e;be(e.componentType);const s="string"==typeof i?Ho.fromName(i):i,o=Zo[e.type],a=Jo[e.type],c=$o[e.type];return r+=e.byteOffset,{values:Ho.createTypedArray(s,t,r,o*n),type:s,size:o,unpacker:a,packer:c}}(r,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:n.values,componentCount:n.size,unpack:n.unpacker,pack:n.packer}}return null}_hasPropertyInHierarchy(e,t){if(!this._hierarchy)return!1;const r=ra(this._hierarchy,e,((e,r)=>{const n=e.classIds[r];return ia(e.classes[n].instances[t])}));return ia(r)}_getPropertyNamesInHierarchy(e,t){ra(this._hierarchy,e,((e,r)=>{const n=e.classIds[r],i=e.classes[n].instances;for(const e in i)i.hasOwnProperty(e)&&-1===t.indexOf(e)&&t.push(e)}))}_getHierarchyProperty(e,t){return ra(this._hierarchy,e,((e,r)=>{const n=e.classIds[r],i=e.classes[n],s=e.classIndexes[r],o=i.instances[t];return ia(o)?ia(o.typedArray)?this._getBinaryProperty(o,s):sa(o[s]):null}))}_setHierarchyProperty(e,t,r,n){const i=ra(this._hierarchy,t,((e,i)=>{const s=e.classIds[i],o=e.classes[s],a=e.classIndexes[i],c=o.instances[r];return!!ia(c)&&(be(i===t,'Inherited property "'.concat(r,'" is read-only.')),ia(c.typedArray)?this._setBinaryProperty(c,a,n):c[a]=sa(n),!0)}));return ia(i)}}function ca(e,t,r=0){const n=new DataView(t);if(e.magic=n.getUint32(r,!0),r+=4,e.version=n.getUint32(r,!0),r+=4,e.byteLength=n.getUint32(r,!0),r+=4,1!==e.version)throw new Error("3D Tile Version ".concat(e.version," not supported"));return r}function ua(e,t,r){const n=new DataView(t);let i;e.header=e.header||{};let s=n.getUint32(r,!0);r+=4;let o=n.getUint32(r,!0);r+=4;let a=n.getUint32(r,!0);r+=4;let c=n.getUint32(r,!0);return r+=4,a>=570425344?(r-=8,i=s,a=o,c=0,s=0,o=0,console.warn("b3dm tile in legacy format.")):c>=570425344&&(r-=4,i=a,a=s,c=o,s=0,o=0,console.warn("b3dm tile in legacy format.")),e.header.featureTableJsonByteLength=s,e.header.featureTableBinaryByteLength=o,e.header.batchTableJsonByteLength=a,e.header.batchTableBinaryByteLength=c,e.header.batchLength=i,r}function la(e,t,r,n){return r=function(e,t,r,n){const{featureTableJsonByteLength:i,featureTableBinaryByteLength:s,batchLength:o}=e.header;if(e.featureTableJson={BATCH_LENGTH:o||0},i>0){const n=ao(t,r,i);e.featureTableJson=JSON.parse(n)}return r+=i,e.featureTableBinary=new Uint8Array(t,r,s),r+=s}(e,t,r),r=function(e,t,r,n){const{batchTableJsonByteLength:i,batchTableBinaryByteLength:s}=e.header;if(i>0){const n=ao(t,r,i);e.batchTableJson=JSON.parse(n),r+=i,s>0&&(e.batchTableBinary=new Uint8Array(t,r,s),e.batchTableBinary=new Uint8Array(e.batchTableBinary),r+=s)}return r}(e,t,r)}function ha(e,t,r){if(!(t||e&&e.batchIds&&r))return null;const{batchIds:n,isRGB565:i,pointCount:s}=e;if(n&&r){const e=new Uint8ClampedArray(3*s);for(let t=0;t<s;t++){const i=n[t],s=r.getProperty(i,"dimensions").map((e=>255*e));e[3*t]=s[0],e[3*t+1]=s[1],e[3*t+2]=s[2]}return{type:qo.UNSIGNED_BYTE,value:e,size:3,normalized:!0}}if(i){const e=new Uint8ClampedArray(3*s);for(let r=0;r<s;r++){const n=Wo(t[r]);e[3*r]=n[0],e[3*r+1]=n[1],e[3*r+2]=n[2]}return{type:qo.UNSIGNED_BYTE,value:e,size:3,normalized:!0}}return t&&t.length===3*s?{type:qo.UNSIGNED_BYTE,value:t,size:3,normalized:!0}:{type:qo.UNSIGNED_BYTE,value:t,size:4,normalized:!0}}const fa=new Jr;function da(e,t,r){return e.isQuantized?r["3d-tiles"]&&r["3d-tiles"].decodeQuantizedPositions?(e.isQuantized=!1,function(e,t){const r=new Jr,n=new Float32Array(3*e.pointCount);for(let i=0;i<e.pointCount;i++)r.set(t[3*i],t[3*i+1],t[3*i+2]).scale(1/e.quantizedRange).multiply(e.quantizedVolumeScale).add(e.quantizedVolumeOffset).toArray(n,3*i);return n}(e,t)):{type:qo.UNSIGNED_SHORT,value:t,size:3,normalized:!0}:t}async function pa(e,t,r,n,i){r=la(e,t,r=ua(e,t,r=ca(e,t,r))),function(e){e.attributes={positions:null,colors:null,normals:null,batchIds:null},e.isQuantized=!1,e.isTranslucent=!1,e.isRGB565=!1,e.isOctEncoded16P=!1}(e);const{featureTable:s,batchTable:o}=function(e){const t=new Yo(e.featureTableJson,e.featureTableBinary),r=t.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(r))throw new Error("POINTS_LENGTH must be defined");t.featuresLength=r,e.featuresLength=r,e.pointsLength=r,e.pointCount=r,e.rtcCenter=t.getGlobalProperty("RTC_CENTER",qo.FLOAT,3);const n=function(e,t){let r=null;if(!e.batchIds&&t.hasProperty("BATCH_ID")&&(e.batchIds=t.getPropertyArray("BATCH_ID",qo.UNSIGNED_SHORT,1),e.batchIds)){const n=t.getGlobalProperty("BATCH_LENGTH");if(!n)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:i,batchTableBinary:s}=e;r=new aa(i,s,n)}return r}(e,t);return{featureTable:t,batchTable:n}}(e);return await async function(e,t,r,n,i){let s,o,a;const c=e.batchTableJson&&e.batchTableJson.extensions&&e.batchTableJson.extensions["3DTILES_draco_point_compression"];c&&(a=c.properties);const u=t.getExtension("3DTILES_draco_point_compression");if(u){o=u.properties;const t=u.byteOffset,r=u.byteLength;if(!o||!Number.isFinite(t)||!r)throw new Error("Draco properties, byteOffset, and byteLength must be defined");s=e.featureTableBinary.slice(t,t+r),e.hasPositions=Number.isFinite(o.POSITION),e.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),e.hasNormals=Number.isFinite(o.NORMAL),e.hasBatchIds=Number.isFinite(o.BATCH_ID),e.isTranslucent=Number.isFinite(o.RGBA)}if(!s)return!0;const l={buffer:s,properties:{...o,...a},featureTableProperties:o,batchTableProperties:a,dequantizeInShader:!1};return await async function(e,t,r,n){const{parse:i}=n,s={...r,draco:{...r.draco,extraAttributes:t.batchTableProperties||{}}};delete s["3d-tiles"];const o=await i(t.buffer,Fo,s),a=o.attributes.POSITION&&o.attributes.POSITION.value,c=o.attributes.COLOR_0&&o.attributes.COLOR_0.value,u=o.attributes.NORMAL&&o.attributes.NORMAL.value,l=o.attributes.BATCH_ID&&o.attributes.BATCH_ID.value,h=a&&o.attributes.POSITION.value.quantization,f=u&&o.attributes.NORMAL.value.quantization;if(h){const t=o.POSITION.data.quantization,r=t.range;e.quantizedVolumeScale=new Jr(r,r,r),e.quantizedVolumeOffset=new Jr(t.minValues),e.quantizedRange=(1<<t.quantizationBits)-1,e.isQuantizedDraco=!0}f&&(e.octEncodedRange=(1<<o.NORMAL.data.quantization.quantizationBits)-1,e.isOctEncodedDraco=!0);const d={};if(t.batchTableProperties)for(const e of Object.keys(t.batchTableProperties))o.attributes[e]&&o.attributes[e].value&&(d[e.toLowerCase()]=o.attributes[e].value);e.attributes={positions:a,colors:ha(e,c),normals:u,batchIds:l,...d}}(e,l,n,i)}(e,s,0,n,i),function(e,t,r){if(!e.attributes.positions)if(t.hasProperty("POSITION"))e.attributes.positions=t.getPropertyArray("POSITION",qo.FLOAT,3);else if(t.hasProperty("POSITION_QUANTIZED")){const n=t.getPropertyArray("POSITION_QUANTIZED",qo.UNSIGNED_SHORT,3);if(e.isQuantized=!0,e.quantizedRange=65535,e.quantizedVolumeScale=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",qo.FLOAT,3),!e.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(e.quantizedVolumeOffset=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",qo.FLOAT,3),!e.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");e.attributes.positions=da(e,n,r)}if(!e.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}(e,s,n),function(e,t,r){if(!e.attributes.colors){let n=null;t.hasProperty("RGBA")?(n=t.getPropertyArray("RGBA",qo.UNSIGNED_BYTE,4),e.isTranslucent=!0):t.hasProperty("RGB")?n=t.getPropertyArray("RGB",qo.UNSIGNED_BYTE,3):t.hasProperty("RGB565")&&(n=t.getPropertyArray("RGB565",qo.UNSIGNED_SHORT,1),e.isRGB565=!0),e.attributes.colors=ha(e,n,r)}t.hasProperty("CONSTANT_RGBA")&&(e.constantRGBA=t.getGlobalProperty("CONSTANT_RGBA",qo.UNSIGNED_BYTE,4))}(e,s,o),function(e,t){if(!e.attributes.normals){let r=null;t.hasProperty("NORMAL")?r=t.getPropertyArray("NORMAL",qo.FLOAT,3):t.hasProperty("NORMAL_OCT16P")&&(r=t.getPropertyArray("NORMAL_OCT16P",qo.UNSIGNED_BYTE,2),e.isOctEncoded16P=!0),e.attributes.normals=function(e,t){if(!t)return null;if(e.isOctEncoded16P){const r=new Float32Array(3*e.pointsLength);for(let n=0;n<e.pointsLength;n++)Xo(t[2*n],t[2*n+1],255,fa),fa.toArray(r,3*n);return{type:qo.FLOAT,size:2,value:r}}return{type:qo.FLOAT,size:2,value:t}}(e,r)}}(e,s),r}function ma(e,t){if(!e)throw new Error(t)}const ya={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},ga=ya.global||ya.self||ya.window,va="object"!=typeof process||"[object process]"!==String(process)||process.browser,wa="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);wa&&parseFloat(wa[1]);const{_parseImageNode:ba}=ga,Ta="undefined"!=typeof Image,_a="undefined"!=typeof ImageBitmap,xa=Boolean(ba),Sa=!!va||xa;function Ea(e){const t=function(e){if("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)return"imagebitmap";if("undefined"!=typeof Image&&e instanceof Image)return"image";if(e&&"object"==typeof e&&e.data&&e.width&&e.height)return"data";return null}(e);if(!t)throw new Error("Not an image");return t}const Aa=/^data:image\/svg\+xml/,Ma=/\.svg((\?|#).*)?$/;function Ra(e){return e&&(Aa.test(e)||Ma.test(e))}function Oa(e,t){if(Ra(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function Ia(e,t,r){const n=function(e,t){if(Ra(t)){const t=(new TextDecoder).decode(e);return"data:image/svg+xml;base64,".concat(btoa(t))}return Oa(e,t)}(e,r),i=self.URL||self.webkitURL,s="string"!=typeof n&&i.createObjectURL(n);try{return await async function(e,t){const r=new Image;if(r.src=e,t.image&&t.image.decode&&r.decode)return await r.decode(),r;return await new Promise(((t,n)=>{try{r.onload=()=>t(r),r.onerror=t=>n(new Error("Could not load image ".concat(e,": ").concat(t)))}catch(e){n(e)}}))}(s||n,t)}finally{s&&i.revokeObjectURL(s)}}const ka={};let Na=!0;async function Ca(e,t,r){let n;if(Ra(r)){n=await Ia(e,t,r)}else n=Oa(e,r);const i=t&&t.imagebitmap;return await async function(e,t=null){!function(e){for(const t in e||ka)return!1;return!0}(t)&&Na||(t=null);if(t)try{return await createImageBitmap(e,t)}catch(e){console.warn(e),Na=!1}return await createImageBitmap(e)}(n,i)}function La(e){const t=Pa(e);return function(e){const t=Pa(e);if(!(t.byteLength>=24&&2303741511===t.getUint32(0,false)))return null;return{mimeType:"image/png",width:t.getUint32(16,false),height:t.getUint32(20,false)}}(t)||function(e){const t=Pa(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,false)&&255===t.getUint8(2)))return null;const{tableMarkers:r,sofMarkers:n}=function(){const e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);const t=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:e,sofMarkers:t}}();let i=2;for(;i+9<t.byteLength;){const e=t.getUint16(i,false);if(n.has(e))return{mimeType:"image/jpeg",height:t.getUint16(i+5,false),width:t.getUint16(i+7,false)};if(!r.has(e))return null;i+=2,i+=t.getUint16(i,false)}return null}(t)||function(e){const t=Pa(e);if(!(t.byteLength>=10&&1195984440===t.getUint32(0,false)))return null;return{mimeType:"image/gif",width:t.getUint16(6,true),height:t.getUint16(8,true)}}(t)||function(e){const t=Pa(e);if(!(t.byteLength>=14&&16973===t.getUint16(0,false)&&t.getUint32(2,true)===t.byteLength))return null;return{mimeType:"image/bmp",width:t.getUint32(18,true),height:t.getUint32(22,true)}}(t)}function Pa(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}const Ua={id:"image",module:"images",name:"Images",version:"3.0.0-beta.5",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg"],parse:async function(e,t,r){const n=((t=t||{}).image||{}).type||"auto",{url:i}=r||{};let s;switch(function(e){switch(e){case"auto":case"data":return function(){if(_a)return"imagebitmap";if(Ta)return"image";if(Sa)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(e){switch(e){case"auto":return _a||Ta||Sa;case"imagebitmap":return _a;case"image":return Ta;case"data":return Sa;default:throw new Error("@loaders.gl/images: image ".concat(e," not supported in this environment"))}}(e),e}}(n)){case"imagebitmap":s=await Ca(e,t,i);break;case"image":s=await Ia(e,t,i);break;case"data":s=await function(e,t){const{mimeType:r}=La(e)||{},{_parseImageNode:n}=ga;return ma(n),n(e,r,t)}(e,t);break;default:ma(!1)}return"data"===n&&(s=function(e){switch(Ea(e)){case"data":return e;case"image":case"imagebitmap":const t=document.createElement("canvas"),r=t.getContext("2d");if(!r)throw new Error("getImageData");return t.width=e.width,t.height=e.height,r.drawImage(e,0,0),r.getImageData(0,0,e.width,e.height);default:throw new Error("getImageData")}}(s)),s},tests:[e=>Boolean(La(new DataView(e)))],options:{image:{type:"auto",decode:!0}}};function Da(e,t){if(!e)throw new Error(t||"assert failed: gltf")}function ja(e,t){if(e.startsWith("data:")||e.startsWith("http:")||e.startsWith("https:"))return e;const r=t.baseUri||t.uri;if(!r)throw new Error("'baseUri' must be provided to resolve relative url ".concat(e));return r.substr(0,r.lastIndexOf("/")+1)+e}const Ba=["SCALAR","VEC2","VEC3","VEC4"],Fa=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],Va=new Map(Fa),qa={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},za={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Ga={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Ha(e){return Ba[e-1]||Ba[0]}function Wa(e){const t=Va.get(e.constructor);if(!t)throw new Error("Illegal typed array");return t}function Ka(e,t){const r=Ga[e.componentType],n=qa[e.type],i=za[e.componentType],s=e.count*n,o=e.count*n*i;return Da(o>=0&&o<=t.byteLength),{ArrayType:r,length:s,byteLength:o}}const Qa={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class Xa{constructor(e){Ce(this,"gltf",void 0),Ce(this,"sourceBuffers",void 0),Ce(this,"byteLength",void 0),this.gltf=e||{json:{...Qa},buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}getExtension(e){const t=this.getUsedExtensions().find((t=>t===e)),r=this.json.extensions||{};return t?r[e]||!0:null}getRequiredExtension(e){return this.getRequiredExtensions().find((t=>t===e))?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if("object"==typeof t)return t;const r=this.json[e]&&this.json[e][t];if(!r)throw new Error("glTF file error: Could not find ".concat(e,"[").concat(t,"]"));return r}getTypedArrayForBufferView(e){const t=(e=this.getBufferView(e)).buffer,r=this.gltf.buffers[t];Da(r);const n=(e.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,n,e.byteLength)}getTypedArrayForAccessor(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),r=this.getBuffer(t.buffer).data,{ArrayType:n,length:i}=Ka(e,t);return new n(r,t.byteOffset+e.byteOffset,i)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),r=this.getBuffer(t.buffer).data,n=t.byteOffset||0;return new Uint8Array(r,n,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,r){return e.extensions=e.extensions||{},e.extensions[t]=r,this.registerUsedExtension(t),this}setObjectExtension(e,t,r){(e.extensions||{})[t]=r}removeObjectExtension(e,t){const r=e.extensions||{},n=r[t];return delete r[t],n}addExtension(e,t={}){return Da(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return Da(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((t=>t===e))||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((t=>t===e))||this.json.extensionsRequired.push(e)}removeExtension(e){this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e),this.json.extensions&&delete this.json.extensions[e]}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:r}=e;this.json.nodes=this.json.nodes||[];const n={mesh:t};return r&&(n.matrix=r),this.json.nodes.push(n),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:r,material:n,mode:i=4}=e,s={primitives:[{attributes:this._addAttributes(t),mode:i}]};if(r){const e=this._addIndices(r);s.primitives[0].indices=e}return Number.isFinite(n)&&(s.primitives[0].material=n),this.json.meshes=this.json.meshes||[],this.json.meshes.push(s),this.json.meshes.length-1}addPointCloud(e){const t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}addImage(e,t){const r=La(e),n=t||(null==r?void 0:r.mimeType),i={bufferView:this.addBufferView(e),mimeType:n};return this.json.images=this.json.images||[],this.json.images.push(i),this.json.images.length-1}addBufferView(e){const t=e.byteLength;Da(Number.isFinite(t)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const r={buffer:0,byteOffset:this.byteLength,byteLength:t};return this.byteLength+=$e(t,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(r),this.json.bufferViews.length-1}addAccessor(e,t){const r={bufferView:e,type:Ha(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const r=this.addBufferView(e);let n={min:t.min,max:t.max};n.min&&n.max||(n=this._getAccessorMinMax(e,t.size));const i={size:t.size,componentType:Wa(e),count:Math.round(e.length/t.size),min:n.min,max:n.max};return this.addAccessor(r,Object.assign(i,t))}addTexture(e){const{imageIndex:t}=e,r={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(r),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var e,t;this.gltf.buffers=[];const r=this.byteLength,n=new ArrayBuffer(r),i=new Uint8Array(n);let s=0;for(const e of this.sourceBuffers||[])s=et(e,i,s);null!==(e=this.json)&&void 0!==e&&null!==(t=e.buffers)&&void 0!==t&&t[0]?this.json.buffers[0].byteLength=r:this.json.buffers=[{byteLength:r}],this.gltf.binary=n,this.sourceBuffers=[n]}_removeStringFromArray(e,t){let r=!0;for(;r;){const n=e.indexOf(t);n>-1?e.splice(n,1):r=!1}}_addAttributes(e={}){const t={};for(const r in e){const n=e[r],i=this._getGltfAttributeName(r),s=this.addBinaryBuffer(n.value,n);t[i]=s}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const r={min:null,max:null};if(e.length<t)return r;r.min=[],r.max=[];const n=e.subarray(0,t);for(const e of n)r.min.push(e),r.max.push(e);for(let n=t;n<e.length;n+=t)for(let i=0;i<t;i++)r.min[0+i]=Math.min(r.min[0+i],e[n+i]),r.max[0+i]=Math.max(r.max[0+i],e[n+i]);return r}}function Ya(e){const{buffer:t,size:r,count:n}=function(e){let t=e,r=1,n=0;e&&e.value&&(t=e.value,r=e.size||1);t&&(ArrayBuffer.isView(t)||(t=function(e,t,r=!1){if(!e)return null;if(Array.isArray(e))return new t(e);if(r&&!(e instanceof t))return new t(e);return e}(t,Float32Array)),n=t.length/r);return{buffer:t,size:r,count:n}}(e);return{value:t,size:r,byteOffset:0,count:n,type:Ha(r),componentType:Wa(t)}}async function Za(e,t,r,n){const i=e.getObjectExtension(t,"KHR_draco_mesh_compression");if(!i)return;const s=e.getTypedArrayForBufferView(i.bufferView),o=Je(s.buffer,s.byteOffset),{parse:a}=n,c={...r};delete c["3d-tiles"];const u=await a(o,Fo,c,n),l=function(e){const t={};for(const r in e){const n=e[r];if("indices"!==r){const e=Ya(n);t[r]=e}}return t}(u.attributes);for(const[r,n]of Object.entries(l))if(r in t.attributes){const i=t.attributes[r],s=e.getAccessor(i);null!=s&&s.min&&null!=s&&s.max&&(n.min=s.min,n.max=s.max)}t.attributes=l,u.indices&&(t.indices=Ya(u.indices)),function(e){if(!e.attributes&&Object.keys(e.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(t)}function Ja(e,t,r=4,n,i){if(!n.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const s=n.DracoWriter.encodeSync({attributes:e}),{parseSync:o}=i,a=o({attributes:e}),c=n._addFauxAttributes(a.attributes);return{primitives:[{attributes:c,mode:r,extensions:{KHR_draco_mesh_compression:{bufferView:n.addBufferView(s),attributes:c}}}]}}function $a(e,t){const r=Object.assign({},e.values);return Object.keys(e.uniforms||{}).forEach((t=>{e.uniforms[t].value&&!(t in r)&&(r[t]=e.uniforms[t].value)})),Object.keys(r).forEach((e=>{"object"==typeof r[e]&&void 0!==r[e].index&&(r[e].texture=t.getTexture(r[e].index))})),r}const ec={KHR_draco_mesh_compression:Object.freeze({__proto__:null,decode:async function(e,t,r){var n;if(null==t||null===(n=t.gltf)||void 0===n||!n.decompressMeshes)return;const i=new Xa(e),s=[];for(const e of function*(e){for(const t of e.json.meshes||[])for(const e of t.primitives)yield e}(i))i.getObjectExtension(e,"KHR_draco_mesh_compression")&&s.push(Za(i,e,t,r));await Promise.all(s),i.removeExtension("KHR_draco_mesh_compression")},encode:function(e,t={}){const r=new Xa(e);for(const e of r.json.meshes||[])Ja(e),r.addRequiredExtension("KHR_draco_mesh_compression")}}),KHR_materials_unlit:Object.freeze({__proto__:null,decode:async function(e){const t=new Xa(e),{json:r}=t;t.removeExtension("KHR_materials_unlit");for(const e of r.materials||[]){e.extensions&&e.extensions.KHR_materials_unlit&&(e.unlit=!0),t.removeObjectExtension(e,"KHR_materials_unlit")}},encode:function(e){const t=new Xa(e),{json:r}=t;if(t.materials)for(const e of r.materials||[])e.unlit&&(delete e.unlit,t.addObjectExtension(e,"KHR_materials_unlit",{}),t.addExtension("KHR_materials_unlit"))}}),KHR_lights_punctual:Object.freeze({__proto__:null,decode:async function(e){const t=new Xa(e),{json:r}=t,n=t.getExtension("KHR_lights_punctual");n&&(t.json.lights=n.lights,t.removeExtension("KHR_lights_punctual"));for(const e of r.nodes||[]){const r=t.getObjectExtension(e,"KHR_lights_punctual");r&&(e.light=r.light),t.removeObjectExtension(e,"KHR_lights_punctual")}},encode:async function(e){const t=new Xa(e),{json:r}=t;if(r.lights){const e=t.addExtension("KHR_lights_punctual");Da(!e.lights),e.lights=r.lights,delete r.lights}if(t.json.lights){for(const e of t.json.lights){const r=e.node;t.addObjectExtension(r,"KHR_lights_punctual",e)}delete t.json.lights}}}),KHR_techniques_webgl:Object.freeze({__proto__:null,decode:async function(e){const t=new Xa(e),{json:r}=t,n=t.getExtension("KHR_techniques_webgl");if(n){const e=function(e,t){const{programs:r=[],shaders:n=[],techniques:i=[]}=e,s=new TextDecoder;return n.forEach((e=>{if(!Number.isFinite(e.bufferView))throw new Error("KHR_techniques_webgl: no shader code");e.code=s.decode(t.getTypedArrayForBufferView(e.bufferView))})),r.forEach((e=>{e.fragmentShader=n[e.fragmentShader],e.vertexShader=n[e.vertexShader]})),i.forEach((e=>{e.program=r[e.program]})),i}(n,t);for(const n of r.materials||[]){const r=t.getObjectExtension(n,"KHR_techniques_webgl");r&&(n.technique=Object.assign({},r,e[r.technique]),n.technique.values=$a(n.technique,t)),t.removeObjectExtension(n,"KHR_techniques_webgl")}t.removeExtension("KHR_techniques_webgl")}},encode:async function(e,t){}})};const tc={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},rc={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class nc{constructor(e){this.idToIndexMap={animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}}normalize(e,t){this.json=e.json;const r=e.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn("glTF: Unknown version ".concat(r.asset.version))}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),function(e){const t=new Xa(e),{json:r}=t;for(const e of r.images||[]){const r=t.removeObjectExtension(e,"KHR_binary_glTF");r&&Object.assign(e,r)}r.buffers&&r.buffers[0]&&delete r.buffers[0].uri,t.removeExtension("KHR_binary_glTF")}(e),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r),this._updateMaterial(r)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in tc)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const r=e[t];if(r&&!Array.isArray(r)){e[t]=[];for(const n in r){const i=r[n];i.id=i.id||n;const s=e[t].length;e[t].push(i),this.idToIndexMap[t][n]=s}}}_convertObjectIdsToArrayIndices(e){for(const t in tc)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:e,indices:r,material:n}=t;for(const t in e)e[t]=this._convertIdToIndex(e[t],"accessor");r&&(t.indices=this._convertIdToIndex(r,"accessor")),n&&(t.material=this._convertIdToIndex(n,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map((e=>this._convertIdToIndex(e,"node")))),e.meshes&&(e.meshes=e.meshes.map((e=>this._convertIdToIndex(e,"mesh"))))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map((e=>this._convertIdToIndex(e,"node"))))}_convertIdsToIndices(e,t){e[t]||(console.warn("gltf v1: json doesn't contain attribute ".concat(t)),e[t]=[]);for(const r of e[t])for(const e in r){const t=r[e],n=this._convertIdToIndex(t,e);r[e]=n}}_convertIdToIndex(e,t){const r=rc[t];if(r in this.idToIndexMap){const n=this.idToIndexMap[r][e];if(!Number.isFinite(n))throw new Error("gltf v1: failed to resolve ".concat(t," with id ").concat(e));return n}return e}_updateObjects(e){for(const e of this.json.buffers)delete e.type}_updateMaterial(e){for(const t of e.materials){t.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const r=t.values&&t.values.tex,n=e.textures.findIndex((e=>e.id===r));-1!==n&&(t.pbrMetallicRoughness.baseColorTexture={index:n})}}}const ic={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},sc={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},oc={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},ac={magFilter:oc.TEXTURE_MAG_FILTER,minFilter:oc.TEXTURE_MIN_FILTER,wrapS:oc.TEXTURE_WRAP_S,wrapT:oc.TEXTURE_WRAP_T},cc={[oc.TEXTURE_MAG_FILTER]:oc.LINEAR,[oc.TEXTURE_MIN_FILTER]:oc.NEAREST_MIPMAP_LINEAR,[oc.TEXTURE_WRAP_S]:oc.REPEAT,[oc.TEXTURE_WRAP_]:oc.REPEAT};class uc{postProcess(e,t={}){const{json:r,buffers:n=[],images:i=[],baseUri:s=""}=e;return Da(r),this.baseUri=s,this.json=r,this.buffers=n,this.images=i,this._resolveTree(this.json,t),this.json}_resolveTree(e,t={}){e.bufferViews&&(e.bufferViews=e.bufferViews.map(((e,t)=>this._resolveBufferView(e,t)))),e.images&&(e.images=e.images.map(((e,t)=>this._resolveImage(e,t)))),e.samplers&&(e.samplers=e.samplers.map(((e,t)=>this._resolveSampler(e,t)))),e.textures&&(e.textures=e.textures.map(((e,t)=>this._resolveTexture(e,t)))),e.accessors&&(e.accessors=e.accessors.map(((e,t)=>this._resolveAccessor(e,t)))),e.materials&&(e.materials=e.materials.map(((e,t)=>this._resolveMaterial(e,t)))),e.meshes&&(e.meshes=e.meshes.map(((e,t)=>this._resolveMesh(e,t)))),e.nodes&&(e.nodes=e.nodes.map(((e,t)=>this._resolveNode(e,t)))),e.skins&&(e.skins=e.skins.map(((e,t)=>this._resolveSkin(e,t)))),e.scenes&&(e.scenes=e.scenes.map(((e,t)=>this._resolveScene(e,t)))),void 0!==e.scene&&(e.scene=e.scenes[this.json.scene])}getScene(e){return this._get("scenes",e)}getNode(e){return this._get("nodes",e)}getSkin(e){return this._get("skins",e)}getMesh(e){return this._get("meshes",e)}getMaterial(e){return this._get("materials",e)}getAccessor(e){return this._get("accessors",e)}getCamera(e){return null}getTexture(e){return this._get("textures",e)}getSampler(e){return this._get("samplers",e)}getImage(e){return this._get("images",e)}getBufferView(e){return this._get("bufferViews",e)}getBuffer(e){return this._get("buffers",e)}_get(e,t){if("object"==typeof t)return t;const r=this.json[e]&&this.json[e][t];return r||console.warn("glTF file error: Could not find ".concat(e,"[").concat(t,"]")),r}_resolveScene(e,t){return e.id=e.id||"scene-".concat(t),e.nodes=(e.nodes||[]).map((e=>this.getNode(e))),e}_resolveNode(e,t){return e.id=e.id||"node-".concat(t),e.children&&(e.children=e.children.map((e=>this.getNode(e)))),void 0!==e.mesh?e.mesh=this.getMesh(e.mesh):void 0!==e.meshes&&e.meshes.length&&(e.mesh=e.meshes.reduce(((e,t)=>{const r=this.getMesh(t);return e.id=r.id,e.primitives=e.primitives.concat(r.primitives),e}),{primitives:[]})),void 0!==e.camera&&(e.camera=this.getCamera(e.camera)),void 0!==e.skin&&(e.skin=this.getSkin(e.skin)),e}_resolveSkin(e,t){return e.id=e.id||"skin-".concat(t),e.inverseBindMatrices=this.getAccessor(e.inverseBindMatrices),e}_resolveMesh(e,t){return e.id=e.id||"mesh-".concat(t),e.primitives&&(e.primitives=e.primitives.map((e=>{const t=(e={...e}).attributes;e.attributes={};for(const r in t)e.attributes[r]=this.getAccessor(t[r]);return void 0!==e.indices&&(e.indices=this.getAccessor(e.indices)),void 0!==e.material&&(e.material=this.getMaterial(e.material)),e}))),e}_resolveMaterial(e,t){if(e.id=e.id||"material-".concat(t),e.normalTexture&&(e.normalTexture={...e.normalTexture},e.normalTexture.texture=this.getTexture(e.normalTexture.index)),e.occlusionTexture&&(e.occlustionTexture={...e.occlustionTexture},e.occlusionTexture.texture=this.getTexture(e.occlusionTexture.index)),e.emissiveTexture&&(e.emmisiveTexture={...e.emmisiveTexture},e.emissiveTexture.texture=this.getTexture(e.emissiveTexture.index)),e.emissiveFactor||(e.emissiveFactor=e.emmisiveTexture?[1,1,1]:[0,0,0]),e.pbrMetallicRoughness){e.pbrMetallicRoughness={...e.pbrMetallicRoughness};const t=e.pbrMetallicRoughness;t.baseColorTexture&&(t.baseColorTexture={...t.baseColorTexture},t.baseColorTexture.texture=this.getTexture(t.baseColorTexture.index)),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture={...t.metallicRoughnessTexture},t.metallicRoughnessTexture.texture=this.getTexture(t.metallicRoughnessTexture.index))}return e}_resolveAccessor(e,t){var r,n;if(e.id=e.id||"accessor-".concat(t),void 0!==e.bufferView&&(e.bufferView=this.getBufferView(e.bufferView)),e.bytesPerComponent=(r=e.componentType,sc[r]),e.components=(n=e.type,ic[n]),e.bytesPerElement=e.bytesPerComponent*e.components,e.bufferView){const t=e.bufferView.buffer,{ArrayType:r,byteLength:n}=Ka(e,e.bufferView),i=(e.bufferView.byteOffset||0)+(e.byteOffset||0)+t.byteOffset,s=t.arrayBuffer.slice(i,i+n);e.value=new r(s)}return e}_resolveTexture(e,t){return e.id=e.id||"texture-".concat(t),e.sampler="sampler"in e?this.getSampler(e.sampler):cc,e.source=this.getImage(e.source),e}_resolveSampler(e,t){e.id=e.id||"sampler-".concat(t),e.parameters={};for(const t in e){const r=this._enumSamplerParameter(t);void 0!==r&&(e.parameters[r]=e[t])}return e}_enumSamplerParameter(e){return ac[e]}_resolveImage(e,t){e.id=e.id||"image-".concat(t),void 0!==e.bufferView&&(e.bufferView=this.getBufferView(e.bufferView));const r=this.images[t];return r&&(e.image=r),e}_resolveBufferView(e,t){e.id=e.id||"bufferView-".concat(t);const r=e.buffer;e.buffer=this.buffers[r];const n=this.buffers[r].arrayBuffer;let i=this.buffers[r].byteOffset||0;return"byteOffset"in e&&(i+=e.byteOffset),e.data=new Uint8Array(n,i,e.byteLength),e}_resolveCamera(e,t){return e.id=e.id||"camera-".concat(t),e.perspective,e.orthographic,e}}const lc=1735152710,hc=!0;function fc(e,t,r=0,n={}){const i=new DataView(t),s=function(e,t=0){return"".concat(String.fromCharCode(e.getUint8(t+0))).concat(String.fromCharCode(e.getUint8(t+1))).concat(String.fromCharCode(e.getUint8(t+2))).concat(String.fromCharCode(e.getUint8(t+3)))}(i,r+0),o=i.getUint32(r+4,hc),a=i.getUint32(r+8,hc);switch(Object.assign(e,{header:{byteOffset:r,byteLength:a,hasBinChunk:!1},type:s,version:o,json:{},binChunks:[]}),r+=12,e.version){case 1:return function(e,t,r){be(e.header.byteLength>20);const n=t.getUint32(r+0,hc),i=t.getUint32(r+4,hc);return r+=8,be(0===i),dc(e,t,r,n),r+=n,r+=pc(e,t,r,e.header.byteLength)}(e,i,r);case 2:return function(e,t,r,n){return be(e.header.byteLength>20),function(e,t,r,n){for(;r+8<=e.header.byteLength;){const i=t.getUint32(r+0,hc),s=t.getUint32(r+4,hc);switch(r+=8,s){case 1313821514:dc(e,t,r,i);break;case 5130562:pc(e,t,r,i);break;case 0:n.strict||dc(e,t,r,i);break;case 1:n.strict||pc(e,t,r,i)}r+=$e(i,4)}}(e,t,r,n),r+e.header.byteLength}(e,i,r,{});default:throw new Error("Invalid GLB version ".concat(e.version,". Only supports v1 and v2."))}}function dc(e,t,r,n){const i=new Uint8Array(t.buffer,r,n),s=new TextDecoder("utf8").decode(i);return e.json=JSON.parse(s),$e(n,4)}function pc(e,t,r,n){return e.header.hasBinChunk=!0,e.binChunks.push({byteOffset:r,byteLength:n,arrayBuffer:t.buffer}),$e(n,4)}async function mc(e,t,r=0,n,i){var s,o,a,c;!function(e,t,r,n){n.uri&&(e.baseUri=n.uri);if(t instanceof ArrayBuffer&&!function(e,t=0,r={}){const n=new DataView(e),{magic:i=lc}=r,s=n.getUint32(t,!1);return s===i||s===lc}(t,r,n)){t=(new TextDecoder).decode(t)}if("string"==typeof t)e.json=Ye(t);else if(t instanceof ArrayBuffer){const i={};r=fc(i,t,r,n.glb),Da("glTF"===i.type,"Invalid GLB magic string ".concat(i.type)),e._glb=i,e.json=i.json}else Da(!1,"GLTF: must be ArrayBuffer or string");const i=e.json.buffers||[];if(e.buffers=new Array(i.length).fill(null),e._glb&&e._glb.header.hasBinChunk){const{binChunks:t}=e._glb;e.buffers[0]={arrayBuffer:t[0].arrayBuffer,byteOffset:t[0].byteOffset,byteLength:t[0].byteLength}}const s=e.json.images||[];e.images=new Array(s.length).fill({})}(e,t,r,n),function(e,t={}){(new nc).normalize(e,t)}(e,{normalize:null==n||null===(s=n.gltf)||void 0===s?void 0:s.normalize});const u=[];if(null!=n&&null!==(o=n.gltf)&&void 0!==o&&o.loadBuffers&&e.json.buffers&&await async function(e,t,r){for(let n=0;n<e.json.buffers.length;++n){const i=e.json.buffers[n];if(i.uri){const{fetch:s}=r;Da(s);const o=ja(i.uri,t),a=await s(o),c=await a.arrayBuffer();e.buffers[n]={arrayBuffer:c,byteOffset:0,byteLength:c.byteLength},delete i.uri}}}(e,n,i),null!=n&&null!==(a=n.gltf)&&void 0!==a&&a.loadImages){const t=async function(e,t,r){const n=e.json.images||[],i=[];for(let s=0;s<n.length;++s)i.push(yc(e,n[s],s,t,r));return await Promise.all(i)}(e,n,i);u.push(t)}const l=async function(e,t={},r){for(const i in ec){var n;const s=(null==t||null===(n=t.gltf)||void 0===n?void 0:n.excludeExtensions)||{};if(!(i in s)||s[i]){const n=ec[i];await n.decode(e,t,r)}}}(e,n,i);return u.push(l),await Promise.all(u),null!=n&&null!==(c=n.gltf)&&void 0!==c&&c.postProcess?function(e,t){return(new uc).postProcess(e,t)}(e,n):e}async function yc(e,t,r,n,i){const{fetch:s,parse:o}=i;let a;if(t.uri){const e=ja(t.uri,n),r=await s(e);a=await r.arrayBuffer()}if(Number.isFinite(t.bufferView)){const r=function(e,t,r){const n=e.bufferViews[r];Da(n);const i=t[n.buffer];Da(i);const s=(n.byteOffset||0)+i.byteOffset;return new Uint8Array(i.arrayBuffer,s,n.byteLength)}(e.json,e.buffers,t.bufferView);a=Je(r.buffer,r.byteOffset,r.byteLength)}Da(a,"glTF image has no data");const c=await o(a,Ua,{},i);e.images[r]=c}const gc={name:"glTF",id:"gltf",module:"gltf",version:"3.0.0-beta.5",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:async function(e,t={},r){(t={...gc.options,...t}).gltf={...gc.options.gltf,...t.gltf};const{byteOffset:n=0}=t;return await mc({},e,n,t,r)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};const vc=0,wc=1;function bc(e,t,r,n){e.rotateYtoZ=!0;const i=e.byteOffset+e.byteLength-r;if(0===i)throw new Error("glTF byte length must be greater than 0.");return e.gltfUpAxis=n["3d-tiles"]&&n["3d-tiles"].assetGltfUpAxis?n["3d-tiles"].assetGltfUpAxis:"Y",e.gltfArrayBuffer=Je(t,r,i),e.gltfByteOffset=0,e.gltfByteLength=i,r%4==0||console.warn("".concat(e.type,": embedded glb is not aligned to a 4-byte boundary.")),e.byteOffset+e.byteLength}async function Tc(e,t,r,n){const i=r["3d-tiles"]||{};if(function(e,t,r){switch(t){case vc:const t=new Uint8Array(e.gltfArrayBuffer,e.gltfByteOffset),r=(new TextDecoder).decode(t);e.gltfUrl=r.replace(/[\s\0]+$/,""),delete e.gltfArrayBuffer,delete e.gltfByteOffset,delete e.gltfByteLength;break;case wc:break;default:throw new Error("b3dm: Illegal glTF format field")}}(e,t),i.loadGLTF){const{parse:t,fetch:i}=n;e.gltfUrl&&(e.gltfArrayBuffer=await i(e.gltfUrl,r),e.gltfByteOffset=0),e.gltfArrayBuffer&&(e.gltf=await t(e.gltfArrayBuffer,gc,r,n),delete e.gltfArrayBuffer,delete e.gltfByteOffset,delete e.gltfByteLength)}}async function _c(e,t,r,n,i){var s;r=function(e,t,r,n,i){r=ca(e,t,r),r=ua(e,t,r),r=la(e,t,r),r=bc(e,t,r,n);const s=new Yo(e.featureTableJson,e.featureTableBinary);return e.rtcCenter=s.getGlobalProperty("RTC_CENTER",qo.FLOAT,3),r}(e,t,r,n),await Tc(e,wc,n,i);const o=null==e||null===(s=e.gltf)||void 0===s?void 0:s.extension;return o&&o.CESIUM_RTC&&(e.rtcCenter=o.CESIUM_RTC.center),r}async function xc(e,t,r,n,i){return r=function(e,t,r,n,i){if(r=ca(e,t,r),1!==e.version)throw new Error("Instanced 3D Model version ".concat(e.version," is not supported"));r=ua(e,t,r);const s=new DataView(t);if(e.gltfFormat=s.getUint32(r,!0),r=la(e,t,r+=4),r=bc(e,t,r,n),0===e.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new Yo(e.featureTableJson,e.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");e.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),e.rtcCenter=o.getGlobalProperty("RTC_CENTER",qo.FLOAT,3);new aa(e.batchTableJson,e.batchTableBinary,a);return function(e,t,r,n){const i=[new Array(n),e._batchTable][0],s=new Jr;new Jr,new Jr,new Jr;const o=new un,a=new Fn,c=new Jr,u={},l=new Tn,h=[],f=[],d=new Jr,p=new Jr;for(let r=0;r<n;r++){let n;if(t.hasProperty("POSITION"))n=t.getProperty("POSITION",qo.FLOAT,3,r,s);else if(t.hasProperty("POSITION_QUANTIZED")){n=t.getProperty("POSITION_QUANTIZED",qo.UNSIGNED_SHORT,3,r,s);const e=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",qo.FLOAT,3,d);if(!e)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const i=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",qo.FLOAT,3,p);if(!i)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const o=65535;for(let t=0;t<3;t++)n[t]=n[t]/o*i[t]+e[t]}if(!n)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(s.copy(n),u.translation=s,e.normalUp=t.getProperty("NORMAL_UP",qo.FLOAT,3,r,h),e.normalRight=t.getProperty("NORMAL_RIGHT",qo.FLOAT,3,r,f),e.normalUp){if(!e.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");e.hasCustomOrientation=!0}else{if(e.octNormalUp=t.getProperty("NORMAL_UP_OCT32P",qo.UNSIGNED_SHORT,2,h),e.octNormalRight=t.getProperty("NORMAL_RIGHT_OCT32P",qo.UNSIGNED_SHORT,2,f),e.octNormalUp){if(!e.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}e.eastNorthUp?(di.WGS84.eastNorthUpToFixedFrame(s,l),l.getRotationMatrix3(o)):o.identity()}a.fromMatrix3(o),u.rotation=a,c.set(1,1,1);const m=t.getProperty("SCALE",qo.FLOAT,1,r);Number.isFinite(m)&&c.multiplyByScalar(m);const y=t.getProperty("SCALE_NON_UNIFORM",qo.FLOAT,3,r,h);y&&c.scale(y),u.scale=c;let g=t.getProperty("BATCH_ID",qo.UNSIGNED_SHORT,1,r);void 0===g&&(g=r);const v=(new Tn).fromQuaternion(u.rotation);l.identity(),l.translate(u.translation),l.multiplyRight(v),l.scale(u.scale);const w=l.clone();i[r]={modelMatrix:w,batchId:g}}e.instances=i}(e,o,0,a),r}(e,t,r,n),await Tc(e,e.gltfFormat,n,i),r}async function Sc(e,t=0,r,n,i={}){switch(i.byteOffset=t,i.type=function(e,t=0){const r=new DataView(e);return"".concat(String.fromCharCode(r.getUint8(t+0))).concat(String.fromCharCode(r.getUint8(t+1))).concat(String.fromCharCode(r.getUint8(t+2))).concat(String.fromCharCode(r.getUint8(t+3)))}(e,t),i.type){case no:return await async function(e,t,r,n,i,s){r=ca(e,t,r);const o=new DataView(t);for(e.tilesLength=o.getUint32(r,!0),r+=4,e.tiles=[];e.tiles.length<e.tilesLength&&e.byteLength-r>12;){const o={};e.tiles.push(o),r=await s(t,r,n,i,o)}return r}(i,e,t,r,n,Sc);case so:return await _c(i,e,t,r,n);case oo:return await xc(i,e,t,r,n);case io:return await pa(i,e,t,r,n);default:throw new Error("3DTileLoader: unknown type ".concat(i.type))}}function Ec(e,t){if(e.content){const r=e.content.uri||e.content.url;e.contentUrl="".concat(t.basePath,"/").concat(r)}return e.id=e.contentUrl,e.lodMetricType=ks,e.lodMetricValue=e.geometricError,e.transformMatrix=e.transform,e.type=function(e){if(!e.contentUrl)return Es;const t=e.contentUrl.split(".").pop();switch(t){case"pnts":return Ms;case"i3dm":case"b3dm":return As;default:return t}}(e),e.refine=function(e){switch(e){case"REPLACE":case"replace":return Ss;case"ADD":case"add":return xs;default:return e}}(e.refine),e}const Ac={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:"3.0.0-beta.5",extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:async function(e,t,r){const n=t["3d-tiles"]||{};let i;i="auto"===n.isTileset?r.url&&-1!==r.url.indexOf(".json"):n.isTileset;e=i?await async function(e,t,r){const n=JSON.parse((new TextDecoder).decode(e));return n.loader=t.loader||Ac,n.url=r.url,n.basePath=function(e){return tt(e.url)}(n),n.root=function(e){const t=e.basePath,r=Ec(e.root,e),n=[];for(n.push(r);n.length>0;){const e=n.pop().children||[];for(const r of e)Ec(r,{basePath:t}),n.push(r)}return r}(n),n.type=Is,n.lodMetricType=ks,n.lodMetricValue=n.root.lodMetricValue,n}(e,t,r):await async function(e,t,r){const n={content:{featureIds:null}},i=0;return await Sc(e,i,t,r,n.content),n.content}(e,t,r);return e},options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};const Mc="https://api.cesium.com/v1/assets";async function Rc(e,t){if(!t){const r=await async function(e){be(e);const t=Mc,r={Authorization:"Bearer ".concat(e)},n=await At(t,{fetch:{headers:r,throws:!0}});return await n.json()}(e);for(const e of r.items)"3DTILES"===e.type&&(t=e.id)}const r=await async function(e,t){be(e,t);const r={Authorization:"Bearer ".concat(e)},n="".concat(Mc,"/").concat(t);let i=await At("".concat(n),{fetch:{headers:r,throws:!0}}),s=await i.json();i=await At("".concat(n,"/endpoint"),{fetch:{headers:r,throws:!0}});const o=await i.json();return s={...s,...o},s}(e,t),{type:n,url:i}=r;return be("3DTILES"===n&&i),r.headers={Authorization:"Bearer ".concat(r.accessToken)},r}const Oc={...Ac,id:"cesium-ion",name:"Cesium Ion",preload:async function(e,t={}){t=t["cesium-ion"]||{};const{accessToken:r}=t;let n=t.assetId;if(!Number.isFinite(n)){const t=e.match(/\/([0-9]+)\/tileset.json/);n=t&&t[1]}return Rc(r,n)},parse:async(e,t,r)=>((t={...t})["3d-tiles"]=t["cesium-ion"],t.loader=Oc,Ac.parse(e,t,r)),options:{"cesium-ion":{...Ac.options["3d-tiles"],accessToken:null}}};function Ic(n){const i=64,s=document.createElement("canvas");s.width=i,s.height=i;const o=s.getContext("2d");o.rect(0,0,i,i);const a=o.createLinearGradient(0,0,i,i);for(let e=0;e<n.length;e++){const t=n[e];a.addColorStop(t[0],"#"+t[1].getHexString())}o.fillStyle=a,o.fill();const c=new e(s);return c.needsUpdate=!0,c.minFilter=t,c.wrapS=r,c.wrapT=r,c.repeat.set(2,2),c}function kc(e){e.updateMatrix(),e.updateMatrixWorld(),e.matrixWorldInverse.copy(e.matrixWorld).invert();const t=new n;return t.setFromProjectionMatrix((new i).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}function Nc(e){const t=e.boundingVolume;let r=0;e.content&&(r=Math.min(e.content.byteLength/5e5,1));const n=new f(r,1,0),s=new d(1,1,1),o=function(e){const t=e;return(new i).fromArray([2*t[0],2*t[1],2*t[2],0,2*t[3],2*t[4],2*t[5],0,2*t[6],2*t[7],2*t[8],0,0,0,0,1])}(t.halfAxes);s.applyMatrix4(o);const c=new p(s),u=new m(c,new y({color:n}));return u.position.copy(new a(...t.center)),u}class Cc extends w{constructor(e){super(e),this.dracoLoader=null,this.ddsLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Bc(e)})),this.register((function(e){return new Vc(e)})),this.register((function(e){return new qc(e)})),this.register((function(e){return new Fc(e)})),this.register((function(e){return new Dc(e)})),this.register((function(e){return new zc(e)}))}load(e,t,r,n){var i,s=this;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:b.extractUrlBase(e),this.manager.itemStart(e);var o=function(t){n?n(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},a=new T(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(r){try{s.parse(r,i,(function(r){t(r),s.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(e){return this.ddsLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,n){var i,s={},o={};if("string"==typeof e)i=e;else if(b.decodeText(new Uint8Array(e,0,4))===Gc){try{s[Pc.KHR_BINARY_GLTF]=new Kc(e)}catch(e){return void(n&&n(e))}i=s[Pc.KHR_BINARY_GLTF].content}else i=b.decodeText(new Uint8Array(e));var a=e instanceof ArrayBuffer?JSON.parse(i):e;if(void 0===a.asset||a.asset.version[0]<2)n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var c=new _u(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(var u=0;u<this.pluginCallbacks.length;u++){var l=this.pluginCallbacks[u](c);o[l.name]=l,s[l.name]=!0}if(a.extensionsUsed)for(u=0;u<a.extensionsUsed.length;++u){var h=a.extensionsUsed[u],f=a.extensionsRequired||[];switch(h){case Pc.KHR_MATERIALS_UNLIT:s[h]=new jc;break;case Pc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:s[h]=new Zc;break;case Pc.KHR_DRACO_MESH_COMPRESSION:s[h]=new Qc(a,this.dracoLoader);break;case Pc.MSFT_TEXTURE_DDS:s[h]=new Uc(this.ddsLoader);break;case Pc.KHR_TEXTURE_TRANSFORM:s[h]=new Xc;break;case Pc.KHR_MESH_QUANTIZATION:s[h]=new Jc;break;default:f.indexOf(h)>=0&&void 0===o[h]&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(s),c.setPlugins(o),c.parse(r,n)}}}function Lc(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}var Pc={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function Uc(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=Pc.MSFT_TEXTURE_DDS,this.ddsLoader=e}function Dc(e){this.parser=e,this.name=Pc.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function jc(){this.name=Pc.KHR_MATERIALS_UNLIT}function Bc(e){this.parser=e,this.name=Pc.KHR_MATERIALS_CLEARCOAT}function Fc(e){this.parser=e,this.name=Pc.KHR_MATERIALS_TRANSMISSION}function Vc(e){this.parser=e,this.name=Pc.KHR_TEXTURE_BASISU}function qc(e){this.parser=e,this.name=Pc.EXT_TEXTURE_WEBP,this.isSupported=null}function zc(e){this.name=Pc.EXT_MESHOPT_COMPRESSION,this.parser=e}Dc.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],r=0,n=t.length;r<n;r++){var i=t[r];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}},Dc.prototype._loadLight=function(e){var t=this.parser,r="light:"+e,n=t.cache.get(r);if(n)return n;var i,s=t.json,o=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],a=new f(16777215);void 0!==o.color&&a.fromArray(o.color);var c=void 0!==o.range?o.range:0;switch(o.type){case"directional":(i=new S(a)).target.position.set(0,0,-1),i.add(i.target);break;case"point":(i=new x(a)).distance=c;break;case"spot":(i=new _(a)).distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,i.angle=o.spot.outerConeAngle,i.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+o.type+'".')}return i.position.set(0,0,0),i.decay=2,void 0!==o.intensity&&(i.intensity=o.intensity),i.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(i),t.cache.add(r,n),n},Dc.prototype.createNodeAttachment=function(e){var t=this,r=this.parser,n=r.json.nodes[e]||e,i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return r._getNodeRef(t.cache,i,e)}))},jc.prototype.getMaterialType=function(){return c},jc.prototype.extendParams=function(e,t,r){var n=[];e.color=new f(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var s=i.baseColorFactor;e.color.fromArray(s),e.opacity=s[3]}void 0!==i.baseColorTexture&&n.push(r.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(n)},Bc.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e]||e;return t.extensions&&t.extensions[this.name]?E:null},Bc.prototype.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e]||e;if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],s=n.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&i.push(r.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&i.push(r.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(i.push(r.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){var o=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new A(o,o)}return Promise.all(i)},Fc.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e]||e;return t.extensions&&t.extensions[this.name]?E:null},Fc.prototype.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e]||e;if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],s=n.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&i.push(r.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(i)},Vc.prototype.loadTexture=function(e){var t=this.parser,r=t.json,n=r.textures[e]||e;if(!n.extensions||!n.extensions[this.name])return null;var i=n.extensions[this.name],s=r.images[i.source],o=t.options.ktx2Loader;if(!o){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s,o)},qc.prototype.loadTexture=function(e){var t=this.name,r=this.parser,n=r.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;var s=i.extensions[t],o=n.images[s.source],a=o.uri?r.options.manager.getHandler(o.uri):r.textureLoader;return this.detectSupport().then((function(i){if(i)return r.loadTextureImage(e,o,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)}))},qc.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},zc.prototype.loadBufferView=function(e){var t=this.parser.json,r=t.bufferViews[e]||e;if(r.extensions&&r.extensions[this.name]){var n=r.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([i,s.ready]).then((function(e){var t=n.byteOffset||0,r=n.byteLength||0,i=n.count,o=n.byteStride,a=new ArrayBuffer(i*o),c=new Uint8Array(e[0],t,r);return s.decodeGltfBuffer(new Uint8Array(a),i,o,c,n.mode,n.filter),a}))}return null};var Gc="glTF",Hc=1313821514,Wc=5130562;function Kc(e){this.name=Pc.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:b.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Gc)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var r=new DataView(e,12),n=0;n<r.byteLength;){var i=r.getUint32(n,!0);n+=4;var s=r.getUint32(n,!0);if(n+=4,s===Hc){var o=new Uint8Array(e,12+n,i);this.content=b.decodeText(o)}else if(s===Wc){var a=12+n;this.body=e.slice(a,a+i)}n+=i}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function Qc(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Pc.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function Xc(){this.name=Pc.KHR_TEXTURE_TRANSFORM}function Yc(e){g.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),r=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),s=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new f).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(var a in o)e.uniforms[a]=o[a];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",r).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",s)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){o.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){o.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function Zc(){return{name:Pc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return Yc},extendParams:function(e,t,r){var n=t.extensions[this.name];e.color=new f(1,1,1),e.opacity=1;var i=[];if(Array.isArray(n.diffuseFactor)){var s=n.diffuseFactor;e.color.fromArray(s),e.opacity=s[3]}if(void 0!==n.diffuseTexture&&i.push(r.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new f(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new f(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var o=n.specularGlossinessTexture;i.push(r.assignTexture(e,"glossinessMap",o)),i.push(r.assignTexture(e,"specularMap",o))}return Promise.all(i)},createMaterial:function(e){var t=new Yc(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=M,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function Jc(){this.name=Pc.KHR_MESH_QUANTIZATION}function $c(e,t,r,n){v.call(this,e,t,r,n)}Qc.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,o={},a={},c={};for(var u in s){var l=hu[u]||u.toLowerCase();o[l]=s[u]}for(u in e.attributes){l=hu[u]||u.toLowerCase();if(void 0!==s[u]){var h=r.accessors[e.attributes[u]],f=au[h.componentType];c[l]=f,a[l]=!0===h.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var r in e.attributes){var n=e.attributes[r],i=a[r];void 0!==i&&(n.normalized=i)}t(e)}),o,c)}))}))},Xc.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},Yc.prototype=Object.create(g.prototype),Yc.prototype.constructor=Yc,Yc.prototype.copy=function(e){return g.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},$c.prototype=Object.create(v.prototype),$c.prototype.constructor=$c,$c.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n*3+n,s=0;s!==n;s++)t[s]=r[i+s];return t},$c.prototype.beforeStart_=$c.prototype.copySampleValue_,$c.prototype.afterEnd_=$c.prototype.copySampleValue_,$c.prototype.interpolate_=function(e,t,r,n){for(var i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=2*o,c=3*o,u=n-t,l=(r-t)/u,h=l*l,f=h*l,d=e*c,p=d-c,m=-2*f+3*h,y=f-h,g=1-m,v=y-h+l,w=0;w!==o;w++){var b=s[p+w+o],T=s[p+w+a]*u,_=s[d+w+o],x=s[d+w]*u;i[w]=g*b+v*T+m*_+y*x}return i};var eu=0,tu=1,ru=2,nu=3,iu=4,su=5,ou=6,au={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},cu={9728:J,9729:t,9984:$,9985:ee,9986:te,9987:L},uu={33071:re,33648:ne,10497:r},lu={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},hu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},fu={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},du={CUBICSPLINE:void 0,LINEAR:K,STEP:ie},pu="OPAQUE",mu="MASK",yu="BLEND";function gu(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function vu(e,t,r){for(var n in r.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=r.extensions[n])}function wu(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function bu(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,n=t.weights.length;r<n;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(r=0,n=i.length;r<n;r++)e.morphTargetDictionary[i[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Tu(e){for(var t="",r=Object.keys(e).sort(),n=0,i=r.length;n<i;n++)t+=r[n]+":"+e[r[n]]+";";return t}function _u(e,t){this.json=e||{},this.extensions={},this.plugins={},this.options=t||{},this.cache=new Lc,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new R(this.options.manager):this.textureLoader=new O(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new T(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function xu(e,t,r){var n=t.attributes,i=[];function s(t,n){return r.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var o in n){var c=hu[o]||o.toLowerCase();c in e.attributes&&null!=e.attributes[c]||i.push(s(n[o],c))}if(void 0!==t.indices&&!e.index){var u=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(u)}return wu(e,t),function(e,t,r){var n=t.attributes,i=new he;if(void 0!==n.POSITION){var s=(d=r.json.accessors[n.POSITION]||n.POSITION).min,o=d.max;if(void 0!==s&&void 0!==o){i.set(new a(s[0],s[1],s[2]),new a(o[0],o[1],o[2]));var c=t.targets;if(void 0!==c){for(var u=new a,l=new a,h=0,f=c.length;h<f;h++){var d,p=c[h];if(void 0!==p.POSITION)s=(d=r.json.accessors[p.POSITION]).min,o=d.max,void 0!==s&&void 0!==o?(l.setX(Math.max(Math.abs(s[0]),Math.abs(o[0]))),l.setY(Math.max(Math.abs(s[1]),Math.abs(o[1]))),l.setZ(Math.max(Math.abs(s[2]),Math.abs(o[2]))),u.max(l)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}i.expandByVector(u)}e.boundingBox=i;var m=new fe;i.getCenter(m.center),m.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=m}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(e,t,r),Promise.all(i).then((function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,i=!1,s=0,o=t.length;s<o&&(void 0!==(u=t[s]).POSITION&&(n=!0),void 0!==u.NORMAL&&(i=!0),!n||!i);s++);if(!n&&!i)return Promise.resolve(e);var a=[],c=[];for(s=0,o=t.length;s<o;s++){var u=t[s];if(n){var l=void 0!==u.POSITION?r.getDependency("accessor",u.POSITION):e.attributes.position;a.push(l)}i&&(l=void 0!==u.NORMAL?r.getDependency("accessor",u.NORMAL):e.attributes.normal,c.push(l))}return Promise.all([Promise.all(a),Promise.all(c)]).then((function(t){var r=t[0],s=t[1];return n&&(e.morphAttributes.position=r),i&&(e.morphAttributes.normal=s),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}function Su(e,t){var r=e.getIndex();if(null===r){var n=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var s=0;s<i.count;s++)n.push(s);e.setIndex(n),r=e.getIndex()}var o=r.count-2,a=[];if(t===oe)for(s=1;s<=o;s++)a.push(r.getX(0)),a.push(r.getX(s)),a.push(r.getX(s+1));else for(s=0;s<o;s++)s%2==0?(a.push(r.getX(s)),a.push(r.getX(s+1)),a.push(r.getX(s+2))):(a.push(r.getX(s+2)),a.push(r.getX(s+1)),a.push(r.getX(s)));a.length/3!==o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var c=e.clone();return c.setIndex(a),c}_u.prototype.setExtensions=function(e){this.extensions=e},_u.prototype.setPlugins=function(e){this.plugins=e},_u.prototype.parse=function(e,t){var r=this,n=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){var s={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:r,userData:{}};vu(i,s,n),wu(s,n),e(s)})).catch(t)},_u.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n=0,i=t.length;n<i;n++)for(var s=t[n].joints,o=0,a=s.length;o<a;o++)e[s[o]].isBone=!0;for(var c=0,u=e.length;c<u;c++){var l=e[c];void 0!==l.mesh&&(this._addNodeRef(this.meshCache,l.mesh),void 0!==l.skin&&(r[l.mesh].isSkinnedMesh=!0)),void 0!==l.camera&&this._addNodeRef(this.cameraCache,l.camera)}},_u.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},_u.prototype._getNodeRef=function(e,t,r){if(e.refs[t]<=1)return r;var n=r.clone();return n.name+="_instance_"+e.uses[t]++,n},_u.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var r=0;r<t.length;r++){var n=e(t[r]);if(n)return n}},_u.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var r=[],n=0;n<t.length;n++){var i=e(t[n]);i&&r.push(i)}return r},_u.prototype.getDependency=function(e,t){var r=e+":"+t,n="number"==typeof t?this.cache.get(r):null;if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,n)}return n},_u.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return r.getDependency(e,n)}))),this.cache.add(e,t)}return t},_u.prototype.loadBuffer=function(e){var t=this.json.buffers[e]||e,r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e&&this.extensions[Pc.KHR_BINARY_GLTF])return Promise.resolve(this.extensions[Pc.KHR_BINARY_GLTF].body);var n=this.options;return new Promise((function(e,i){r.load(gu(t.uri,n.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},_u.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e]||e;return t.data?Promise.resolve(t.data):this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)}))},_u.prototype.loadAccessor=function(e){var t=this,r=this.json,n=this.json.accessors[e]||e;if((void 0===n.bufferView||null===n.bufferView)&&void 0===n.sparse&&!n.value)return Promise.resolve(null);var i=[];return void 0===n.bufferView||n.value?i.push(null):i.push(this.getDependency("bufferView",n.bufferView)),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then((function(e){var i,s,o=e[0],a=lu[n.type],c=au[n.componentType],u=c.BYTES_PER_ELEMENT,l=u*a,h=n.byteOffset||0,f=void 0===n.bufferView||n.value?void 0:r.bufferViews[n.bufferView].byteStride,d=!0===n.normalized;if(f&&f!==l){var p=Math.floor(h/f),m="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,y=t.cache.get(m);y||(i=new c(o,p*f,n.count*f/u),y=new I(i,f/u),t.cache.add(m,y)),s=new k(y,a,h%f/u,d)}else i=n.value?n.value:null===o?new c(n.count*a):new c(o,h,n.count*a),s=new N(i,a,d);if(void 0!==n.sparse){var g=lu.SCALAR,v=au[n.sparse.indices.componentType],w=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,T=new v(e[1],w,n.sparse.count*g),_=new c(e[2],b,n.sparse.count*a);null!==o&&(s=new N(s.array.slice(),s.itemSize,s.normalized));for(var x=0,S=T.length;x<S;x++){var E=T[x];if(s.setX(E,_[x*a]),a>=2&&s.setY(E,_[x*a+1]),a>=3&&s.setZ(E,_[x*a+2]),a>=4&&s.setW(E,_[x*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return s}))},_u.prototype.loadTexture=function(e){var t,r,n=this.json,i=this.options,s=n.textures[e]||e,o=s.extensions||{};return(t=o[Pc.MSFT_TEXTURE_DDS]?n.images[o[Pc.MSFT_TEXTURE_DDS].source]:n.images[s.source]||s.source).uri&&(r=i.manager.getHandler(t.uri)),r||(r=o[Pc.MSFT_TEXTURE_DDS]?this.extensions[Pc.MSFT_TEXTURE_DDS].ddsLoader:this.textureLoader),this.loadTextureImage(e,t,r)},_u.prototype.loadTextureImage=function(n,i,s){var o,a=this,c=this.json,u=this.options,l=c.textures[n]||n,h=self.URL||self.webkitURL,f=i.uri,d=!1,p=!0;return"image/jpeg"===i.mimeType&&(p=!1),void 0!==i.bufferView&&(f=a.getDependency("bufferView",i.bufferView).then((function(e){if("image/png"===i.mimeType){var t=new DataView(e,25,1).getUint8(0,!1);p=6===t||4===t||3===t}return new Blob([e],{type:i.mimeType})}))),o=s.isImageBitmapLoader?Promise.resolve(f).then((function(e){return createImageBitmap(e,{premultiplyAlpha:"none"})})).then((function(t){return new e(t)})):Promise.resolve(f).then((function(e){return d=!0,f=h.createObjectURL(e)})).then((function(e){return new Promise((function(t,r){var n=t;s.load(gu(e,u.path),n,void 0,r)}))})),Promise.resolve(o).then((function(e){!0===d&&h.revokeObjectURL(f),e.flipY=!1,l.name&&(e.name=l.name),p||(e.format=C);var i=(c.samplers||{})[l.sampler]||{};return e.magFilter=cu[i.magFilter]||t,e.minFilter=cu[i.minFilter]||L,e.wrapS=uu[i.wrapS]||r,e.wrapT=uu[i.wrapT]||r,a.associations.set(e,{type:"textures",index:n}),e}))},_u.prototype.assignTexture=function(e,t,r){var n=this;return this.getDependency("texture",r.index).then((function(i){if(void 0===r.texCoord||0==r.texCoord||"aoMap"===t&&1==r.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+r.texCoord+" for texture "+t+" not yet supported."),n.extensions[Pc.KHR_TEXTURE_TRANSFORM]){var s=void 0!==r.extensions?r.extensions[Pc.KHR_TEXTURE_TRANSFORM]:void 0;if(s){var o=n.associations.get(i);i=n.extensions[Pc.KHR_TEXTURE_TRANSFORM].extendTexture(i,s),n.associations.set(i,o)}}e[t]=i}))},_u.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,n=void 0!==t.attributes.tangent,i=void 0!==t.attributes.color,s=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,a=Object.keys(t.morphAttributes).length>0,c=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){var u="PointsMaterial:"+r.uuid,l=this.cache.get(u);l||(l=new P,U.prototype.copy.call(l,r),l.color.copy(r.color),l.map=r.map,l.sizeAttenuation=!1,this.cache.add(u,l)),r=l}else if(e.isLine){u="LineBasicMaterial:"+r.uuid;var h=this.cache.get(u);h||(h=new y,U.prototype.copy.call(h,r),h.color.copy(r.color),this.cache.add(u,h)),r=h}if(n||i||s||o||a){u="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(u+="specular-glossiness:"),o&&(u+="skinning:"),n&&(u+="vertex-tangents:"),i&&(u+="vertex-colors:"),s&&(u+="flat-shading:"),a&&(u+="morph-targets:"),c&&(u+="morph-normals:");var f=this.cache.get(u);f||(f=r.clone(),o&&(f.skinning=!0),n&&(f.vertexTangents=!0),i&&(f.vertexColors=!0),s&&(f.flatShading=!0),a&&(f.morphTargets=!0),c&&(f.morphNormals=!0),this.cache.add(u,f),this.associations.set(f,this.associations.get(r))),r=f}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),r.normalScale&&!n&&(r.normalScale.y=-r.normalScale.y),r.clearcoatNormalScale&&!n&&(r.clearcoatNormalScale.y=-r.clearcoatNormalScale.y),e.material=r},_u.prototype.getMaterialType=function(){return g},_u.prototype.loadMaterial=function(e){var t,r=this,n=this.json,i=this.extensions,s=n.materials[e]||e,o={},a=s.extensions||{},l=[];if(a[Pc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=i[Pc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),l.push(h.extendParams(o,s,r))}else if(a[Pc.KHR_MATERIALS_UNLIT]){var d=i[Pc.KHR_MATERIALS_UNLIT];t=d.getMaterialType(),l.push(d.extendParams(o,s,r))}else{var p=s.pbrMetallicRoughness||{};if(o.color=new f(1,1,1),o.opacity=1,Array.isArray(p.baseColorFactor)){var m=p.baseColorFactor;o.color.fromArray(m),o.opacity=m[3]}void 0!==p.baseColorTexture&&l.push(r.assignTexture(o,"map",p.baseColorTexture)),o.metalness=void 0!==p.metallicFactor?p.metallicFactor:1,o.roughness=void 0!==p.roughnessFactor?p.roughnessFactor:1,void 0!==p.metallicRoughnessTexture&&(l.push(r.assignTexture(o,"metalnessMap",p.metallicRoughnessTexture)),l.push(r.assignTexture(o,"roughnessMap",p.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===s.doubleSided&&(o.side=u);var y=s.alphaMode||pu;return y===yu?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,y===mu&&(o.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==c&&(l.push(r.assignTexture(o,"normalMap",s.normalTexture)),o.normalScale=new A(1,1),void 0!==s.normalTexture.scale&&o.normalScale.set(s.normalTexture.scale,s.normalTexture.scale)),void 0!==s.occlusionTexture&&t!==c&&(l.push(r.assignTexture(o,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(o.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==c&&(o.emissive=(new f).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&t!==c&&l.push(r.assignTexture(o,"emissiveMap",s.emissiveTexture)),Promise.all(l).then((function(){var n;return n=t===Yc?i[Pc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),s.name&&(n.name=s.name),n.map&&(n.map.encoding=D),n.emissiveMap&&(n.emissiveMap.encoding=D),wu(n,s),r.associations.set(n,{type:"materials",index:e}),s.extensions&&vu(i,n,s),n}))},_u.prototype.createUniqueName=function(e){for(var t=j.sanitizeNodeName(e||""),r=1;this.nodeNamesUsed[t];++r)t=e+"_"+r;return this.nodeNamesUsed[t]=!0,t},_u.prototype.loadGeometries=function(e){var t=this,r=this.extensions,n=this.primitiveCache;function i(e){return r[Pc.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return xu(r,e,t)}))}for(var s,o,a=[],c=0,u=e.length;c<u;c++){var l,h=e[c],f=null,d=null;if("number"==typeof h.indices&&(o=void 0,d=n[f=(o=(s=h).extensions&&s.extensions[Pc.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+Tu(o.attributes):s.indices+":"+Tu(s.attributes)+":"+s.mode]),d)a.push(d.promise);else l=h.extensions&&h.extensions[Pc.KHR_DRACO_MESH_COMPRESSION]&&"number"==typeof h.indices?i(h):xu(new B,h,t),f&&(n[f]={primitive:h,promise:l}),a.push(l)}return Promise.all(a)},_u.prototype.loadMesh=function(e){for(var t,r=this,n=this.json.meshes[e]||e,i=n.primitives,o=[],a=0,c=i.length;a<c;a++){var u=void 0===i[a].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new g({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:se})),t.DefaultMaterial):this.getDependency("material",i[a].material);o.push(u)}return o.push(r.loadGeometries(i)),Promise.all(o).then((function(t){for(var o=t.slice(0,t.length-1),a=t[t.length-1],c=[],u=0,h=a.length;u<h;u++){var f,d=a[u],p=i[u],y=o[u];if(p.mode===iu||p.mode===su||p.mode===ou||void 0===p.mode)!0!==(f=!0===n.isSkinnedMesh?new F(d,y):new l(d,y)).isSkinnedMesh||f.geometry.attributes.skinWeight.normalized||f.normalizeSkinWeights(),p.mode===su?f.geometry=Su(f.geometry,ae):p.mode===ou&&(f.geometry=Su(f.geometry,oe));else if(p.mode===tu)f=new m(d,y);else if(p.mode===nu)f=new V(d,y);else if(p.mode===ru)f=new q(d,y);else{if(p.mode!==eu)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);f=new z(d,y)}Object.keys(f.geometry.morphAttributes).length>0&&bu(f,n),f.name=r.createUniqueName(n.name||"mesh_"+e),wu(f,n),r.assignFinalMaterial(f),c.push(f)}if(1===c.length)return c[0];var g=new s;for(u=0,h=c.length;u<h;u++)g.add(c[u]);return g}))},_u.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n)return"perspective"===r.type?t=new G(H.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===r.type&&(t=new W(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),wu(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},_u.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},_u.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],n=[],i=[],s=[],o=[],a=0,c=t.channels.length;a<c;a++){var u=t.channels[a],l=t.samplers[u.sampler],h=u.target,f=void 0!==h.node?h.node:h.id,d=void 0!==t.parameters?t.parameters[l.input]:l.input,p=void 0!==t.parameters?t.parameters[l.output]:l.output;r.push(this.getDependency("node",f)),n.push(this.getDependency("accessor",d)),i.push(this.getDependency("accessor",p)),s.push(l),o.push(h)}return Promise.all([Promise.all(r),Promise.all(n),Promise.all(i),Promise.all(s),Promise.all(o)]).then((function(r){for(var n=r[0],i=r[1],s=r[2],o=r[3],a=r[4],c=[],u=0,l=n.length;u<l;u++){var h=n[u],f=i[u],d=s[u],p=o[u],m=a[u];if(void 0!==h){var y;switch(h.updateMatrix(),h.matrixAutoUpdate=!0,fu[m.path]){case fu.weights:y=le;break;case fu.rotation:y=ue;break;case fu.position:case fu.scale:default:y=ce}var g=h.name?h.name:h.uuid,v=void 0!==p.interpolation?du[p.interpolation]:K,w=[];fu[m.path]===fu.weights?h.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&w.push(e.name?e.name:e.uuid)})):w.push(g);var b=d.array;if(d.normalized){var T;if(b.constructor===Int8Array)T=1/127;else if(b.constructor===Uint8Array)T=1/255;else if(b.constructor==Int16Array)T=1/32767;else{if(b.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");T=1/65535}for(var _=new Float32Array(b.length),x=0,S=b.length;x<S;x++)_[x]=b[x]*T;b=_}for(x=0,S=w.length;x<S;x++){var E=new y(w[x]+"."+fu[m.path],f.array,b,v);"CUBICSPLINE"===p.interpolation&&(E.createInterpolant=function(e){return new $c(this.times,this.values,this.getValueSize()/3,e)},E.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(E)}}}var A=t.name?t.name:"animation_"+e;return new Q(A,void 0,c)}))},_u.prototype.loadNode=function(e){var t,r=this.json,n=this.extensions,o=this,a=r.nodes[e]||e,c=a.name?o.createUniqueName(a.name):"";return(t=[],void 0!==a.mesh&&t.push(o.getDependency("mesh",a.mesh).then((function(e){var t=o._getNodeRef(o.meshCache,a.mesh,e);return void 0!==a.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=a.weights.length;t<r;t++)e.morphTargetInfluences[t]=a.weights[t]})),t}))),void 0!==a.camera&&t.push(o.getDependency("camera",a.camera).then((function(e){return o._getNodeRef(o.cameraCache,a.camera,e)}))),o._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var r;if((r=!0===a.isBone?new X:t.length>1?new s:1===t.length?t[0]:new Y)!==t[0])for(var u=0,l=t.length;u<l;u++)r.add(t[u]);if(a.name&&(r.userData.name=a.name,r.name=c),wu(r,a),a.extensions&&vu(n,r,a),void 0!==a.matrix){var h=new i;h.fromArray(a.matrix),r.applyMatrix4(h)}else void 0!==a.translation&&r.position.fromArray(a.translation),void 0!==a.rotation&&r.quaternion.fromArray(a.rotation),void 0!==a.scale&&r.scale.fromArray(a.scale);return o.associations.set(r,{type:"nodes",index:e}),r}))},_u.prototype.loadScene=function(){function e(t,r,n,s){var o=n.nodes[t]||t;return s.getDependency("node",t).then((function(e){return void 0===o.skin?e:s.getDependency("skin",o.skin).then((function(e){for(var r=[],n=0,i=(t=e).joints.length;n<i;n++)r.push(s.getDependency("node",t.joints[n]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var n=[],s=[],o=0,a=r.length;o<a;o++){var c=r[o];if(c){n.push(c);var u=new i;void 0!==t.inverseBindMatrices&&u.fromArray(t.inverseBindMatrices.array,16*o),s.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[o])}e.bind(new Z(n,s),e.matrixWorld)}})),e}));var t})).then((function(t){r.add(t);var i=[];if(o.children)for(var a=o.children,c=0,u=a.length;c<u;c++){var l=a[c];i.push(e(l,t,n,s))}return Promise.all(i)}))}return function(t){var r=this.json,n=this.extensions,i=this.json.scenes[t],o=new s;i.name&&(o.name=this.createUniqueName(i.name)),wu(o,i),i.extensions&&vu(n,o,i);for(var a=i.nodes||[],c=[],u=0,l=a.length;u<l;u++)c.push(e(a[u],o,r,this));return Promise.all(c).then((function(){return o}))}}();const Eu={SPECTRAL:[[0,new f(.3686,.3098,.6353)],[.1,new f(.1961,.5333,.7412)],[.2,new f(.4,.7608,.6471)],[.3,new f(.6706,.8667,.6431)],[.4,new f(.902,.9608,.5961)],[.5,new f(1,1,.749)],[.6,new f(.9961,.8784,.5451)],[.7,new f(.9922,.6824,.3804)],[.8,new f(.9569,.4275,.2627)],[.9,new f(.8353,.2431,.3098)],[1,new f(.6196,.0039,.2588)]],PLASMA:[[0,new f(.241,.015,.61)],[.1,new f(.387,.001,.654)],[.2,new f(.524,.025,.653)],[.3,new f(.651,.125,.596)],[.4,new f(.752,.227,.513)],[.5,new f(.837,.329,.431)],[.6,new f(.907,.435,.353)],[.7,new f(.963,.554,.272)],[.8,new f(.992,.681,.195)],[.9,new f(.987,.822,.144)],[1,new f(.94,.975,.131)]],YELLOW_GREEN:[[0,new f(.1647,.2824,.3451)],[.1,new f(.1338,.3555,.4227)],[.2,new f(.061,.4319,.4864)],[.3,new f(0,.5099,.5319)],[.4,new f(0,.5881,.5569)],[.5,new f(.137,.665,.5614)],[.6,new f(.2906,.7395,.5477)],[.7,new f(.4453,.8099,.5201)],[.8,new f(.6102,.8748,.485)],[.9,new f(.7883,.9323,.4514)],[1,new f(.9804,.9804,.4314)]],VIRIDIS:[[0,new f(.267,.005,.329)],[.1,new f(.283,.141,.458)],[.2,new f(.254,.265,.53)],[.3,new f(.207,.372,.553)],[.4,new f(.164,.471,.558)],[.5,new f(.128,.567,.551)],[.6,new f(.135,.659,.518)],[.7,new f(.267,.749,.441)],[.8,new f(.478,.821,.318)],[.9,new f(.741,.873,.15)],[1,new f(.993,.906,.144)]],INFERNO:[[0,new f(.077,.042,.206)],[.1,new f(.225,.036,.388)],[.2,new f(.373,.074,.432)],[.3,new f(.522,.128,.42)],[.4,new f(.665,.182,.37)],[.5,new f(.797,.255,.287)],[.6,new f(.902,.364,.184)],[.7,new f(.969,.516,.063)],[.8,new f(.988,.683,.072)],[.9,new f(.961,.859,.298)],[1,new f(.988,.998,.645)]],GRAYSCALE:[[0,new f(0,0,0)],[1,new f(1,1,1)]],TURBO:[[0,new f(.18995,.07176,.23217)],[.07,new f(.25107,.25237,.63374)],[.13,new f(.27628,.42118,.89123)],[.2,new f(.25862,.57958,.99876)],[.27,new f(.15844,.73551,.92305)],[.33,new f(.09267,.86554,.7623)],[.4,new f(.19659,.94901,.59466)],[.47,new f(.42778,.99419,.38575)],[.53,new f(.64362,.98999,.23356)],[.6,new f(.80473,.92452,.20459)],[.67,new f(.93301,.81236,.22667)],[.73,new f(.99314,.67408,.20348)],[.8,new f(.9836,.49291,.12849)],[.87,new f(.92105,.31489,.05475)],[.93,new f(.81608,.18462,.01809)],[1,new f(.66449,.08436,.00424)]],RAINBOW:[[0,new f(.278,0,.714)],[1/6,new f(0,0,1)],[2/6,new f(0,1,1)],[.5,new f(0,1,0)],[4/6,new f(1,1,0)],[5/6,new f(1,.64,0)],[1,new f(1,0,0)]],CONTOUR:[[0,new f(0,0,0)],[.03,new f(0,0,0)],[.04,new f(1,1,1)],[1,new f(1,1,1)]]},Au="\n  varying vec3 vColor;\n  void main() {\n    if (vColor == vec3(0.0, 0.0, 0.0)) {\n      discard;\n    } else {\n      gl_FragColor = vec4( vColor, 1.0 );\n    }\n  }\n",Mu="\n  varying vec3 vColor;\n  uniform sampler2D gradient;\n  uniform sampler2D grayscale;\n  attribute float intensity;\n  attribute float classification;\n  uniform vec3 rootCenter;\n  uniform vec3 rootNormal;\n  uniform vec2 elevationRange;\n  uniform int coloring;\n  uniform bool hideGround;\n  uniform float maxIntensity;\n  uniform float intensityContrast;\n\n  #ifdef USE_COLOR\n  vec3 getRGB() {\n      vec3 rgb = color;\n      return rgb;\n  }\n  #endif\n\n  vec3 getElevation(){\n    vec4 world = modelMatrix * vec4( position, 1.0 );\n    float diff = abs(dot(rootNormal, (vec3(world) - rootCenter)));\n    float w = max(diff - elevationRange.x,0.0) / max(elevationRange.y - elevationRange.x,1.0);\n    vec3 cElevation = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\n    return cElevation;\n  }\n\n  vec3 getIntensity(){\n    // TODO: real contrast enhancement. Check https://github.com/yuki-koyama/enhancer/blob/master/shaders/enhancer.fs\n    float intmod = pow(intensity, intensityContrast);\n    vec3 cIntensity = texture2D(grayscale, vec2(intmod / maxIntensity ,1.0-(intmod / maxIntensity))).rgb;\n    return cIntensity;\n  }\n\n  vec3 getClassification(){\n    float classNormalized = classification / 255.0;\n    vec3 cClassification = texture2D(gradient, vec2(classNormalized * 5.0,1.0-classNormalized * 5.0)).rgb;\n    return cClassification;\n  }\n\n  vec3 getColor(){\n      vec3 color;\n      if (hideGround && classification == 2.0) {\n         return vec3(0.0, 0.0, 0.0);               \n      }\n\n      if (coloring == 1) {\n        color = getIntensity();\n      }\n      else if (coloring == 2) {\n        color = getClassification();\n      } else if (coloring == 3) {\n        color = getElevation();\n      } \n      #ifdef USE_COLOR\n      else if (coloring == 4) {\n        color = getRGB();\n      }\n      #endif\n      else {\n        color = vec3(1.0, 1.0, 1.0);\n      }\n      return color;\n  }\n\n  void main() {\n      vColor = getColor();\n\n      gl_PointSize = 1.0;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n  }\n";var Ru,Ou;!function(e){e[e.Intensity=1]="Intensity",e[e.Classification=2]="Classification",e[e.Elevation=3]="Elevation",e[e.RGB=4]="RGB",e[e.White=5]="White"}(Ru||(Ru={})),function(e){e[e.FlatTexture=1]="FlatTexture",e[e.ShadedTexture=2]="ShadedTexture",e[e.ShadedNoTexture=3]="ShadedNoTexture"}(Ou||(Ou={}));const Iu="undefined"!=typeof document?Ic(Eu.RAINBOW):null,ku="undefined"!=typeof document?Ic(Eu.GRAYSCALE):null,Nu={initialTransform:new i,throttleRequests:!0,maxRequests:64,updateInterval:.1,maxConcurrency:1,maximumScreenSpaceError:16,maximumMemoryUsage:32,viewDistanceScale:1,skipLevelOfDetail:!1,updateTransforms:!1,shading:Ou.FlatTexture,pointCloudColoring:Ru.White,worker:!0,wireframe:!1,debug:!1,basisTranscoderPath:null,dracoDecoderPath:null,material:null,computeNormals:!1,shaderCallback:null,loadersGlGltf:!0};class Cu{static load(e){return we(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},Nu),e.options),{url:r}=e,n=t.updateInterval,f={};if(t.cesiumIONToken){f["cesium-ion"]={accessToken:t.cesiumIONToken};const e=yield Oc.preload(r,f);f.fetch={headers:e.headers}}const d=yield er(r,Ac,Object.assign({},f)),p={},m={},y=[],g=new s,v=new s;t.debug||(v.visible=!1);let w=new i;const b=d.root.transform?(new i).fromArray(d.root.transform):new i;if(1==d.root.children.length&&d.root.children[0].transform){const e=(new i).fromArray(d.root.children[0].transform);b.multiply(e)}w.copy(b).invert();const T=w.clone();w.premultiply(t.initialTransform);let _=new Tn(w.toArray());const x={pointSize:{type:"f",value:1},gradient:{type:"t",value:Iu},grayscale:{type:"t",value:ku},rootCenter:{type:"vec3",value:new a},rootNormal:{type:"vec3",value:new a},coloring:{type:"i",value:t.pointCloudColoring},hideGround:{type:"b",value:!0},elevationRange:{type:"vec2",value:new A(0,400)},maxIntensity:{type:"f",value:1},intensityContrast:{type:"f",value:1}};let S=null,E=null;const M=t.loadersGlGltf?new Cc:new ye;if(t.basisTranscoderPath){const r=new ve;r.detectSupport(e.renderer),r.setTranscoderPath(t.basisTranscoderPath+"/"),M.setKTX2Loader(r)}if(!t.loadersGlGltf&&t.dracoDecoderPath){const e=new ge;e.setDecoderPath(t.dracoDecoderPath+"/"),e.setWorkerLimit(t.maxConcurrency),M.setDRACOLoader(e)}const R=new de({uniforms:{},vertexShader:"\n  varying vec2 vUv;\n  void main() {\n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n  }\n",fragmentShader:"\n  uniform sampler2D map;\n  varying vec2 vUv;\n\n  void main() {\n    vec4 realColor = texture2D(map, vUv);\n    gl_FragColor = realColor;\n  }\n"}),O={modelMatrix:_,maximumMemoryUsage:t.maximumMemoryUsage,maximumScreenSpaceError:t.maximumScreenSpaceError,viewDistanceScale:t.viewDistanceScale,skipLevelOfDetail:t.skipLevelOfDetail,updateTransforms:t.updateTransforms,throttleRequests:t.throttleRequests,maxRequests:t.maxRequests,contentLoader:e=>we(this,void 0,void 0,(function*(){let r=null;switch(e.type){case Ms:r=function(e,t){const r={rtc_center:e.content.rtcCenter,points:e.content.attributes.positions,intensities:e.content.attributes.intensity,classifications:e.content.attributes.classification,rgb:null,rgba:null},{colors:n}=e.content.attributes;n&&3===n.size&&(r.rgb=n.value);n&&4===n.size&&(r.rgba=n.value);const s=new B;s.setAttribute("position",new pe(r.points,3));const o=new de({uniforms:t,vertexShader:Mu,fragmentShader:Au,transparent:!0});r.rgba?(s.setAttribute("color",new pe(r.rgba,4)),o.vertexColors=!0):r.rgb&&(s.setAttribute("color",new me(r.rgb,3,!0)),o.vertexColors=!0);r.intensities&&s.setAttribute("intensity",new me(r.intensities,1,!0));r.classifications&&s.setAttribute("classification",new me(r.classifications,1,!1));const a=new z(s,o);if(r.rtc_center){const e=r.rtc_center;a.applyMatrix4((new i).makeTranslation(e[0],e[1],e[2]))}return a}(e,x);break;case As:case Rs:r=yield function(e,t,r,n){return we(this,void 0,void 0,(function*(){return new Promise(((s,o)=>{const c=(new i).makeRotationAxis(new a(1,0,0),Math.PI/2);e.parse(n.loadersGlGltf?t.content.gltf:t.content.gltfArrayBuffer,"",(e=>{const t=e.scenes[0].children[0];t.applyMatrix4(c),t.traverse((e=>{if(e instanceof l){const t=e.material.map;n.material?e.material=n.material.clone():n.shading==Ou.FlatTexture&&(e.material=r.clone()),n.shading!=Ou.ShadedNoTexture?e.material.uniforms?e.material.uniforms.map={value:t}:e.material.map=t:e.material.map=null,n.shaderCallback&&(e.onBeforeRender=n.shaderCallback),e.material.wireframe=n.wireframe,n.computeNormals&&e.geometry.computeVertexNormals()}})),s(t)}),(e=>{o(new Error(`error parsing gltf in tile ${t.id}: ${e}`))}))}))}))}(M,e,R,t)}if(r&&(r.visible=!1,p[e.id]=r,g.add(p[e.id]),t.debug)){const t=Nc(e);v.add(t),m[e.id]=t}})),onTileLoad:()=>we(this,void 0,void 0,(function*(){I&&(I._frameNumber++,j(I,p,E,S))})),onTileUnload:e=>{y.push(e)},onTileError:(e,t)=>{console.error("Tile error",e.id,t)}},I=new ro(d,Object.assign(Object.assign({},O),{loadOptions:Object.assign(Object.assign({},f),{maxConcurrency:t.maxConcurrency,worker:t.worker,gltf:{loadImages:!1},"3d-tiles":{loadGLTF:t.loadersGlGltf}})}));let k=!1;const N=(new a).setFromMatrixPosition(t.initialTransform);x.rootCenter.value.copy(N),x.rootNormal.value.copy(new a(0,0,1).applyMatrix4(t.initialTransform).normalize()),g.applyMatrix4(t.initialTransform),I.stats.get("Loader concurrency").count=t.maxConcurrency+" / "+("undefined"!=typeof navigator&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:"??"),I.stats.get("Maximum SSE").count=t.maximumScreenSpaceError,I.stats.get("Maximum mem usage").count=t.maximumMemoryUsage;let C=0;const L=(new i).makeTranslation(1/0,1/0,1/0);let P=null;const U=new a(1/0,1/0,1/0);let D=null;function j(r,n,i,s){if(k)return;if(!D||s.aspect!=P){const e=new ls({fov:s.fov/180*Math.PI,aspectRatio:s.aspect,near:s.near,far:s.far});D=e.sseDenominator,P=s.aspect,t.debug&&console.log("Updated sse denonimator:",D)}const o=kc(s).planes.map((e=>new Wi(e.normal.toArray(),e.constant))),a=new Ji(o),c=new A;i.getSize(c);const u={camera:{position:U.toArray()},height:c.y,frameNumber:r._frameNumber,sseDenominator:D,cullingVolume:a,viewport:{id:0}};r._cache.reset(),r._traverser.traverse(r.root,u,r.options);for(const e of r.tiles)e.selected?n[e.id]?n[e.id].visible=!0:console.error("TILE SELECTED BUT NOT LOADED!!",e.id):n[e.id]&&(n[e.id].visible=!1);for(;y.length>0;){const e=y.pop();n[e.id]&&e.contentState==vs&&(g.remove(n[e.id]),Lu(n[e.id]),delete n[e.id]),m[e.id]&&(Lu(m[e.id]),v.remove(m[e.id]),delete m[e.id])}return e.onProgress&&e.onProgress(r.stats.get("Tiles Loaded").count,r.stats.get("Tiles Loaded").count+r.stats.get("Tiles Loading").count),u}return{model:g,runtime:{getTileset:()=>I,getStats:()=>I.stats,showTiles:e=>{v.visible=e},setWireframe:e=>{t.wireframe=e,g.traverse((t=>{t instanceof l&&(t.material.wireframe=e)}))},setDebug:e=>{t.debug=e,v.visible=e},setShading:e=>{t.shading=e},getTileBoxes:()=>v,setViewDistanceScale:e=>{I.options.viewDistanceScale=e,I._frameNumber++,j(I,p,E,S)},setHideGround:e=>{x.hideGround.value=e},setPointCloudColoring:e=>{x.coloring.value=e},setElevationRange:e=>{x.elevationRange.value.set(e[0],e[1])},setMaxIntensity:e=>{x.maxIntensity.value=e},setIntensityContrast:e=>{x.intensityContrast.value=e},getLatLongHeightFromPosition:e=>{const t=I.ellipsoid.cartesianToCartographic((new a).copy(e).applyMatrix4((new i).copy(w).invert()).toArray());return{lat:t[1],long:t[0],height:t[2]}},getPositionFromLatLongHeight:e=>{const t=I.ellipsoid.cartographicToCartesian([e.long,e.lat,e.height]);return new a(...t).applyMatrix4(w)},getCameraFrustum:e=>{const t=kc(e).planes.map((e=>new Wi(e.normal.toArray(),e.constant))).map((e=>function(e){const t=new s,r=new o(10,5),n=new a(...e.projectPointOntoPlane([0,0,0])),i=new a(e.normal.x,e.normal.y,e.normal.z),f=(new a).copy(n).add(i);r.lookAt(f),r.translate(n.x,n.y,n.z);const d=new c({color:65535,side:u}),p=new l(r,d),m=new h(i,n,5,16776960);return t.add(m),t.add(p),t}(e))),r=new s;for(const e of t)r.add(e);return r},getTransform:()=>t.initialTransform,setTransform:e=>{t.initialTransform=e,w=T.clone(),w.premultiply(t.initialTransform),_=new Tn(w.toArray()),I.modelMatrix=_,g.matrix.copy(t.initialTransform),g.matrix.decompose(g.position,g.quaternion,g.scale)},update:function(e,t,r){const i=!(r.matrixWorld.equals(L)&&r.aspect==P);S=r,E=t,C+=e,I&&C>=n&&i&&(C=0,I._frameNumber++,r.getWorldPosition(U),L.copy(r.matrixWorld),j(I,p,t,r))},dispose:function(){for(k=!0,I._destroy();g.children.length>0;){const e=g.children[0];Lu(e),g.remove(e)}for(;v.children.length>0;){const e=v.children[0];v.remove(e),e.geometry.dispose(),e.material.dispose()}}}}}))}}function Lu(e){e.traverse((e=>{if(e.isMesh)if(e.geometry.dispose(),e.material.isMaterial)e.material.dispose();else for(const t of e.material)t.dispose()}));for(let t=e.children.length-1;t>=0;t--){const r=e.children[t];e.remove(r)}}export{Cu as Loader3DTiles,Ru as PointCloudColoring,Ou as Shading};
//# sourceMappingURL=threebird-loader-3d-tiles.esm.min.js.map
